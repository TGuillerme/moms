---
title: "Shifting spaces: how to summarise multidimensional spaces occupancy?"
author: "Thomas Guillerme, Mark Puttick, Ariel Marcy, Vera Weisbecker"
date: "`r Sys.Date()`"
output:
  html_document:
    fig_width: 12
    fig_height: 6
---

# Supplementary material 1: simulations

```{r, echo = FALSE}
## Loading the packages
if(!require(devtools)) install.packages("devtools")
if(!require(knitr)) install.packages("knitr"); library(knitr)
if(!require(rmarkdown)) install.packages("rmarkdown"); library(rmarkdown)
if(!require(ape)) install.packages("ape"); library(ape)
if(!require(dispRity)) install.packages("dispRity"); library(dispRity)
if(packageVersion("dispRity") < "1.2.4") {
    ## dispRity must be above v1.2.3
    devtools::install_github("TGuillerme/dispRity"); library(dispRity)
}
if(!require(moms)) devtools::install_github("TGuillerm/moms"); library(moms)

## Setting the default parameters for the space plots
defaults <- list(pch = 20,
                 xlim = c(-3, 3),
                 ylim = c(-3, 3),
                 col1 = "grey",
                 col2 = "black",
                 xlab = "Trait",
                 ylab = "Trait",
                 cex = 1)
## Generating the default palette
default.palette <- function(n) {
    hues = seq(15, 375, length = n + 1)
    grDevices::hcl(h = hues, l = 65, c = 100)[1:n]
}
```

# Simulation data

This section contains all the results and calculations (and plots them).
The whole analysis takes approximatively 30 minutes to run (single core 2.2 GHz).

## Metrics analysed

```{r metrics_list, echo = FALSE}
## All metrics
## Small metrics list (for testing)
metrics_list <- list("av.pairwise" = function(matrix) return(mean(pairwise.dist(matrix)^2)),
                    "Procrustes" = function(matrix) return(sum(matrix^2)/nrow(matrix)),
                    "av.displac" = c(mean, displacements),
                    "av.neighbo" = c(mean, neighbours))

## 
metric_names <- c("Average squared\ndistance", "Procrustes\nvariance", "Mean\ndisplacement",
                  "Mean nearest\nneighbours distance")
```

The metrics analysed are the `r paste(metric_names, collapse = ", ")`.

## Generating the data

This section runs and summarises the simulations.
The simulations are run silently in this markdown file (and are not printed on the compiled version of this document).
The code is available within this R markdown file (un-compiled).

```{r toggle_simulations, echo = FALSE}
## Set the overall number of replicates
n_replicates <- 20

## Set the overall number of elements
#elements <- function() sample(20:200) #TG: possibility to use a variable number of elements
elements <- function() 200

## Simulation seed
set.seed(42)
```

```{r generate_spaces, echo = FALSE, warning = FALSE, results = 'hide'}
## List of distributions
distributions_list <- list(
    "unifor" = list(distribution = runif, arguments = list(list("min" = -0.5, "max" = 0.5))),
    "normal" = list(distribution = rnorm),
    "random" = list(distribution = "random"),
    "unicor" = list(distribution = runif, arguments = list(list("min" = -0.5, "max" = 0.5)),
                    cor.matrix = "random"),
    "norcor" = list(distribution = rnorm, cor.matrix = "random"),
    "pcalik" = list(distribution = rnorm, scree = "lognormal"),
    "pcolik" = list(distribution = rnorm, scree = "normal")
    )

## Generate all 13 spaces
all_spaces <- list(uniform3 = space.simulation(distributions_list$unifor, dimensions = 3,
                                               elements = elements(), replicates = n_replicates),
                   uniform15 = space.simulation(distributions_list$unifor, dimensions = 15,
                                               elements = elements(), replicates = n_replicates),
                   uniform50 = space.simulation(distributions_list$unifor, dimensions = 50,
                                               elements = elements(), replicates = n_replicates),
                   uniform100 = space.simulation(distributions_list$unifor, dimensions = 100,
                                               elements = elements(), replicates = n_replicates),
                   uniform150 = space.simulation(distributions_list$unifor, dimensions = 150,
                                               elements = elements(), replicates = n_replicates),
                   uniformc50 = space.simulation(distributions_list$unicor, dimensions = 50,
                                               elements = elements(), replicates = n_replicates),
                   normal3 = space.simulation(distributions_list$normal, dimensions = 3,
                                               elements = elements(), replicates = n_replicates),
                   normal15 = space.simulation(distributions_list$normal, dimensions = 15,
                                               elements = elements(), replicates = n_replicates),
                   normal50 = space.simulation(distributions_list$normal, dimensions = 50,
                                               elements = elements(), replicates = n_replicates),
                   uniform100 = space.simulation(distributions_list$unifor, dimensions = 100,
                                               elements = elements(), replicates = n_replicates),
                   normal150 = space.simulation(distributions_list$normal, dimensions = 150,
                                               elements = elements(), replicates = n_replicates),
                   normalc50 = space.simulation(distributions_list$norcor, dimensions = 50,
                                               elements = elements(), replicates = n_replicates),
                   random50 = space.simulation(distributions_list$random, dimensions = 50,
                                               elements = elements(), replicates = n_replicates),
                   pca_like = space.simulation(distributions_list$pcalik, dimensions = 50,
                                               elements = elements(), replicates = n_replicates),
                   pco_like = space.simulation(distributions_list$pcolik, dimensions = 50,
                                               elements = elements(), replicates = n_replicates))

#TG: Warnings are due to inexact correlations
```


```{r shift_spaces, echo = FALSE, warning = FALSE, results = 'hide'}
## Shifting each space
shift_groups <- lapply(all_spaces, lapply, shift.group.simulation, remove = 0.5)
```

```{r get_disparity, echo = FALSE, warning = FALSE, results = 'hide'}
## Measuring disparity
remove_05 <- mapply(metrics.simulation, all_spaces, shift_groups,
                  MoreArgs = list(metrics = metrics_list, rare.dim = NULL, verbose = TRUE),
                  SIMPLIFY = FALSE)

## Saving the results
save.results(remove_05)
```

