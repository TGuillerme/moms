---
title: "Shifting spaces: which disparity or dissimilarity measurement best summarise occupancy in multidimensional spaces?"
author: "Thomas Guillerme, Mark N. Puttick, Ariel E. Marcy, Vera Weisbecker"
bibliography: references.bib
csl: mee.csl
date: "`r Sys.Date()`"
output:
  html_document:
    fig_width: 8
    fig_height: 8
---


<!-- Keywords: disparity, dissimilarity, ecology, evolution, multidimensionality, statistics -->


<!-- When toggling to html, toggle snippet `compilation_html` below to eval = TRUE -->

<!-- To build the line numbered version (for submission) use the following yaml header snippet
output:
  pdf_document:
    fig_width: 8
    fig_height: 8
    keep_tex: true
  self_contained: false

Instead of

output:
  html_document:
    fig_width: 8
    fig_height: 8
---
and edit the save .tex file to add the following

\usepackage{lineno} %in the package header

\linespread{2} %in the document header

\modulolinenumbers[1] % just after the \begin{document} tag
\linenumbers

 -->


```{r header, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}
## Repeatability note:
## This whole paper is entirely reproducible and compiles as a single document. The data, figures
## and tables are all generated through the code snippets in this file. Note that the first time
## that this paper is compiled, it will generate the data which will take substantial time
## as the shiftingspace_supplementary.Rmd file completion takes ~10 minutes. Subsequent compilations
## will be much faster!

## Loading the packages
if(!require(devtools)) install.packages("devtools")
if(!require(knitr)) install.packages("knitr"); library(knitr)
if(!require(rmarkdown)) install.packages("rmarkdown"); library(rmarkdown)
if(!require(ape)) install.packages("ape"); library(ape)
if(!require(dispRity)) install.packages("dispRity"); library(dispRity)
if(packageVersion("dispRity") < "1.2.4") {
    ## dispRity must be above v1.2.3
    devtools::install_github("TGuillerme/dispRity"); library(dispRity)
}
if(!require(moms)) devtools::install_github("TGuillerme/moms"); library(moms)

## Setting the datapath
DATA_PATH <- "../data/processed/"

## Create data directory
if(!dir.exists(DATA_PATH)) {
    dir.create(path = DATA_PATH, showWarnings = FALSE)
}

## Setting the default parameters for the space plots
defaults <- list(pch = 20,
                 xlim = c(-3, 3),
                 ylim = c(-3, 3),
                 col1 = "grey",
                 col2 = "black",
                 xlab = "Trait",
                 ylab = "Trait",
                 cex = 1)
## Generating the default palette
default.palette <- function(n) {
    hues <- seq(15, 375, length = n + 1)
    grDevices::hcl(h <- hues, l = 65, c = 100)[1:n]
}

## Checking whether the data exists
if(!all(c("remove_05.Rda") %in% list.files(DATA_PATH))) {
    ## Run The supplementary material (simulation) ~ 30 minutes
    rmarkdown::render("shiftingspace_supplementary_simulation.Rmd", "html_document")    
}
if(!all(c("empirical_results.Rda") %in% list.files(DATA_PATH))) {
    ## Run The supplementary material ~ 15 minutes
    rmarkdown::render("shiftingspace_supplementary_empirical.Rmd", "html_document")
}
```

```{r table_counter, echo = FALSE}
## Table and figure counter
element.counter <- function(name, all_names, increment = FALSE) {
    if(increment) {
        ## Numbering a table or a figure
        all_names <- c(all_names[[2]], name)
        ## Print the table number
        # length(all_names)
        return(list(print = length(all_names), list = all_names))
    } else {
        ## Printing the number of the table of figure
        # cat(which(all_names %in% name))
        return(list(print = which(all_names[[2]] %in% name), list = all_names[[2]]))
    }
}
## Initialising the elements counters
tables <- list(print = NULL, list = character())
figures <- list(print = NULL, list = character())

## Function wrappers
table <- function(name, add = FALSE, all_names = tables) {
    return(element.counter(name, all_names, increment = add))
}
figure <- function(name, add = FALSE, all_names = figures) {
    return(element.counter(name, all_names, increment = add))
}

```


```{r compilation_html, echo = FALSE, eval = TRUE}
## Changing defaults
body(plot.id)[[2]] <- substitute(type <- ".png")
```

# Abstract


1. Multidimensional analysis of traits are now a common toolkit in ecology and evolution and are based on <font style="color:blue">trait spaces</font> in which each dimension summarises the observed trait combination (a morphospace or an ecospace).
Observations of interest will typically occupy a <font style="color:blue">subspace of this space</font>, and researchers will apply one or more measures to quantify the way in which organisms "inhabit" that <font style="color:blue">trait space</font>.
In macroevolution and ecology these measures are referred to as disparity or dissimilarity metrics and can be generalised as space occupancy measures. %AM: short explanation of what space occupancy means (or doesn't) - since reviewers were exacting about that? 
Researchers use these measures to investigate how space occupancy changes through time, in relation to other groups of organisms, and in response to global environmental changes, such as global warming events or mass extinctions.
However, the mathematical and biological meaning of most space occupancy measures is vague with the majority of widely-used measures lacking formal description.

2. Here we propose a broad classification of space occupancy measures into three categories that capture changes in <font style="color:blue">size</font>, density, or position.
We analyse the behaviour of 25 measures to study changes in <font style="color:blue">trait space size</font>, density and position on a series of simulated and empirical datasets.

3. We find no one measure describes all of <font style="color:blue">trait space</font> but that some measures are better at capturing certain aspects compared to other approaches and that their performance depends on both the <font style="color:blue">trait space</font> and the hypothesis analysed. 
However, our results confirm the three broad categories (<font style="color:blue">size</font>, density and position) and allow us to relate changes in any of these categories to biological phenomena.

4. Since the choice of space occupancy measures should be specific to the data and question at had, we introduced [`moms`](https://tguillerme.shinyapps.io/moms/), a user-friendly tool based on a graphical interface that allows users to both visualise and measure changes in space occupancy for any metrics in simulated or imported <font style="color:blue">trait spaces</font>.
Users are also provided with tools to transform their data in space (e.g. contraction, displacement, etc.). %AM: is metric the same as measure? As a person with less math background, I'm getting caught up on the noun measure and the verb measure, both of which are relevant for the paper. Would it be possible (maybe not in the abstract) to clarify that measure (noun) is the more precise word for metric which I think our target audience would more readily use for the term we're talking about?
This tool is designed to help researchers choose the right space occupancy measures, given the properties of their <font style="color:blue">trait space</font> and their biological question. %AM: I liked what you said re: this not being trivial at all and relating it to catalyzing collaborations between ecology and evolution - maybe worthy of a fifth benefit we're proposing if it fits?


# Introduction

Groups of species and environments share specific, easily recognisable, correlated characteristics of many kinds: guilds or biomes with shared phenotypic, physiological, phylogenetic or behavioural traits.
Organisms or environments should therefore be studied as a set of traits rather than some specific traits in isolation [@donohue2013; @hopkins2017].
Biologists have increasingly been using ordination techniques [see @legendre2012 for a summary] to create multidimensional <font style="color:blue">trait spaces</font> to either explore properties of the data or test hypotheses [@oksanen2007vegan; @adams2013geomorph; @momocs; @blonder2018; @disprity].
<!-- Optional: remove momocs -->
For example, in palaeobiology, @wright2017 <font style="color:blue">used trait spaces</font> to study how groups of species' characteristics change through time; in ecology, @jones2015 study evidence of competition by looking at trait overlap between two populations.
However, different fields use a different set of terms for such approaches (Table 1).
<!-- In macroevolution, they are commonly referred to as "morphospaces" with the whole procedure often being often called "disparity analysis" [e.g. @adams2013geomorph; @marcy2016; @wright2017], while in ecology, they can be called "functional spaces" and or "dissimilarity analysis" [e.g. @diaz2016; @mammola2019].-->
Nonetheless, they are the same mathematical objects: matrices with columns representing an original or transformed trait value and rows representing observations, such as taxon, field site, etc. [@disprity].

In mathematics | In ecology | In macroevolution | In this paper
---------------|------------|-------------------|---------------
Matrix ($n \times d$) | Function-space, Eco-space, etc. | Morphospace, traitspace, etc. | trait space
Rows (*n*) | Taxa, field sites, environments, etc. | Taxa, specimen, populations, etc. | observations
Columns (*d*) | Traits, Ordination scores, distances, etc. | Traits, Ordination scores, distances, etc. | dimensions
Matrix subset ($m \times d$; $m \leq n$) | Treatments, phylogenetic group (clade), etc. | Clades, geological stratum, etc. | group
Statistic | Dissimilarity index or metric, hypervolume, functional diversity | Disparity metric or index | space occupancy measure
Multidimensional analysis | Dissimilarity analysis, trait analysis, etc. | Disparity analysis, disparity-through-time, etc. | multidimensional analysis
Table 1: terms and equivalence between mathematics, ecology and macroevolution.

Ecologists and evolutionary biologists also often use <font style="color:blue">trait spaces</font> with respect to the same fundamental questions:
<font style="color:blue">are groups occupying the same amount of trait space?
Do some groups have contain more species than others in the same amount of trait space?
Are some specific factors correlated to different patterns of occupancy of the trait space (e.g. are some factors correlated with more occupancy)?</font>?
<font style="color:blue">Because of the multidimensional nature of these trait spaces, it is often not possible to study them using bi- or tri-variate techniques.</font> %AM: typo was quoted in the response letter (reviewers seemed really keen on those) just fyi
Studying the occupancy of <font style="color:blue">trait spaces</font> can be achieved using disparity metrics in macroevolution [@wills2001; @hopkins2017; @disprity] or comparing hypervolumes in ecology [@donohue2013; @diaz2016; @blonder2018; @mammola2019].
Despite the commonalities between the space occupancy measures used in ecology and evolution, surprisingly little work has been published on their behaviour [but see @ciampaglio2001; @villéger2008; @mammola2019]. %AM: just trying to avoid "however, although" - totaly stylistic

Different space occupancy measures capture different aspects of the <font style="color:blue">trait space</font> [ciampaglio2001; @villéger2008; @mammola2019].
It may be widely-known by many in the field, but to our knowledge this is infrequently mentioned in peer-reviewed papers.
First, space occupancy measures are often named as the biological aspect they are describing (e.g. "disparity" or "functional diversity") rather than what they are measuring (e.g. the average pairwise distances), which obscures the differences or similarities between studies.
Second, in many studies in ecology and evolution, authors have focused on measuring the <font style="color:blue">size</font> of the <font style="color:blue">trait space</font> with different measures [e.g. ellipsoid volume @donohue2013; hypervolume @diaz2016; product of variance @wright2017; Procrustes variance @marcy2016].
However, <font style="color:blue">the size of the trait space</font> only represents a single aspects of occupancy, disregarding others such as the density [@geiger2008] or position [@wills2001; @ciampaglio2001].
For example, if two groups <font style="color:blue">have the same trait space size</font>, this will lead to supporting certain biological conclusions.
Yet, an alternative aspect of space occupancy may indicate that the groups' position are different; this would likely lead to a different biological conclusion (e.g. the groups are equally diverse but occupy different niches).
Using metrics that only measure one aspect of the multidimensional <font style="color:blue">trait space</font> may restrain the potential of multidimensional analysis [@villéger2008]. %AM: issue of measure noun vs verb in this sentence - replace measure (v) with "capture"? See throughout paper (e.g. line 207)

Here we propose a broad classification of space occupancy measures as used across ecology and evolution and analyse their power to detect changes in <font style="color:blue">trait space</font> occupancy in simulated and empirical data.
<font style="color:blue">Note that we refer to occupancy here as the general term for where observations are in a trait space.
This definition excludes whether spaces are are truly "occupiable" (e.g. are there limits to the space, are some regions of the space inapplicable, etc.) which might be of importance in particulare spaces (e.g. in tree spaces; @Hillis2005). </font>
We provide an assessment of each broad type of space occupancy measures along with a unified terminology to foster communication between ecology and evolution. %AM: Yes! Emphasize in abstract :) 
Unsurprisingly, we found no one measure describes all changes through a <font style="color:blue">trait space</font> and the results from each measurement are dependent on the characteristics of the space and the hypotheses.
Furthermore, because there can potentially be an infinite number of measures, it would be impossible to propose clear generalities to space occupancy measures behavior.
Therefore, we propose [`moms`](https://tguillerme.shinyapps.io/moms/), a user-friendly tool allowing researchers to design, experiment and visualise their own space occupancy measure tailored for their specific project as well as helping them to understand the "null" behavior of their measures of interest.


## Space occupancy measures

<font style="color:blue">In this paper, we define trait spaces as any matrix where rows are observations and columns are traits, where both observations and traits are structurally related (e.g. there is a phylogenetic relation between observations - and traits, etc.).</font>
These traits can widely vary in number and types: they could be coded as discrete [e.g. presence or absence of a bone; @beck2014; @wright2017], continuous measurements [e.g. leaf area; @diaz2016] or more sophisticated measures [e.g. landmark position; @marcy2016; Fourier ellipses; @momocs].
Traits can also be measured by using relative observations [e.g. community compositions; @jones2015] or distance between observations [e.g. @close2015].
However, regardless of the methodology used to build a <font style="color:blue">trait space</font>, three broad occupancy measures can be used: the <font style="color:blue">size</font> which will approximate the amount of space occupied, the density which will approximate the distribution in space and the position which will approximate the location in space [Fig. 1; @villéger2008].
Of course any combination of these three aspects is always possible.

```{r fig_measures_types, echo = FALSE, fig.height = 3, fig.width = 9, results = 'hide', fig.cap = paste("Figure 1: different type of information captured by space occupancy measures. A - Size (e.g. sum of ranges); B - Density (e.g. pairwise distances); C - Position (e.g. distances from centre).") }

set.seed(11)
## Plot space function (utility shortcut)
## The elements
elements <- 10

## Trait space
trait_space <- space.maker(elements, 2, distribution = rnorm)

## Graphical parameters
op <- par(mfrow = c(1,3), bty = "n")

## The size
plot(trait_space, pch = defaults$pch, main = "A - Size", xlab = "Trait 1", ylab = "Trait 2")
## The range lines
lines(x = range(trait_space[,1]), y = rep(mean(trait_space[,2]), 2), col = defaults$col1)
lines(x = rep(mean(trait_space[,1]), 2), y = range(trait_space[,2]), col = defaults$col1)

## The density
plot(trait_space, pch = defaults$pch, main = "B - Density", xlab = "Trait 1", ylab = "")
## Plotting the pairwise lines
pair.line <- function(line, trait_space, defaults) {
    lines(x = trait_space[line,1], y = trait_space[line,2], col = defaults$col1)
}
apply(combn(1:elements, 2), 2, pair.line, trait_space, defaults)
points(trait_space, pch = defaults$pch)

## The position
plot(trait_space, pch = defaults$pch, main = "C - Position", xlab = "Trait 1", ylab = "")
## Plotting the center of the space
points(0,0, pch = 13, cex = 2)
arrows(x0 = 0, y0 = 0, x1 = trait_space[,1], y1 = trait_space[,2], code = 0, col = defaults$col1)
points(trait_space, pch = defaults$pch)

par(op)
```

#### 1. Size

<font style="color:blue">Size</font> measures the spread of a group in the <font style="color:blue">trait space</font>.
They can be interpreted as the amount of the <font style="color:blue">trait space</font> that is occupied by observations.
Typically, larger values for such measures indicate the presence of more extreme trait combinations.
For example, if group A is bigger than group B, the observations in A achieve more extreme trait combinations than in B.
This type of measure is widely used in both ecology [e.g. the hypervolume; @blonder2018] and in evolution [e.g. the sum or product of ranges or variances; @wills2001].

Although <font style="color:blue">size</font> measures are suitable indicators of a group's <font style="color:blue">trait space</font> occupancy, they are limited to comparing the range of trait-combinations between groups.
<font style="color:blue">Size</font> measures do not take into account the distribution of the observations within a group <font style="color:blue">and can be sensible to unoccupied "holes" in it [@blonder2018].</font> %AM: sensible --> insensitive? it --> trait space or distribution?
In other words, they can make it difficult to determine whether all the observations are on the edge of the volume or whether the <font style="color:blue">size</font> is simply driven by a small number of extreme observations.

<!-- This aspect of space occupancy is used routinely in ecology and macroevolution:
for example @wright2017 uses the <font style="color:blue">size</font> of <font style="color:blue">trait space</font> to analyse how crinoid ecology changes through time relative to all the observed ecologies in the the crinoid <font style="color:blue">trait space</font>.
A larger "spread" at a specific point in time [e.g. 360 to 330 million years ago (Mya); @wright2017] indicates a larger diversity of ecological feeding strategies.
In general the <font style="color:blue">size</font> of a group in the <font style="color:blue">trait space</font> indicates how much trait combinations that group achieves in the <font style="color:blue">trait space</font>. --> %AM: I'm not sure I understood the last part of the sentence; much --> many if trait combos "increase" with size... but size/volume makes me think of distance so is "how many diverse trait combos?" accurate? Just thinking out loud!

#### 2. Density

<font style="color:blue">Density measures give an indication of the quantity of observations in the trait space. %AM: per unit of trait space? Or is that implied in the definition of trait space?
They can be interpreted as the distribution of the observations *within* a group in the trait space.
Groups with higher density contain more observations (i.e. more observations per approximation of size) that will tend to be more similar to each other.
For example, if group A is greater than group B and both have the same density (observations are equally distant within each group), similar mechanisms could be driving both groups' trait space occupancy. %AM: what do you mean by "greater" here? More numerous?
Indeed, this pattern could suggest that A is older and has had more time to achieve both its greater numbers and its more extreme trait combinations under essentially the same process as younger, smaller group B [@endler2005]. %AM: I did a lot of editing of these two sentences so double check I understood what you were saying!
Note that density based measures can be sensitive to sampling.
Density measures are less common compared to size measures, but they are still used in both ecology [e.g. the minimum spanning tree length; @oksanen2007vegan] and evolution [e.g. the average pairwise distance; @geiger2008]. </font>

#### 3. Position

Position measures where a group lies in <font style="color:blue">trait space</font>.
They can be interpreted as where a group lies in the <font style="color:blue">trait space</font> either relative to the space itself or relative to another group.
For example, if group A has a different position than group B, observations in A will have a different mean trait-combination than in B. %AM: okay to insert mean?

Position measures may be harder to interpret in multidimensional spaces.
<font style="color:blue">For example in a 2D space, two groups can be equally distant from a fixed point but in different parts of the space left, right, up, or down (with the position possibilities increasing with the number of dimensions).</font>
However, when thinking about unidimensional data (one trait), this measure is obvious: two groups A or B could have the same variance (i.e. "<font style="color:blue">size</font>" or spread) with the same number of observations (i.e. density) but could have two different means and thus be in different positions.
These measures have been used in ecology to compare the position of two groups relative to each other [@mammola2019].


<!-- @@@Add here orientation?  -->

## No measure to rule them all: benefits of considering multiple measures

The use of multiple measurements to assess <font style="color:blue">trait space</font> occupancy has the benefit of providing a more detailed characterisation of occupancy changes.
If the question of interest is, say, to look at how space occupancy changes in response to mass extinction, using a single space occupancy measure can miss part of the picture: a change in <font style="color:blue">size</font> could be decoupled from a change in position or density in <font style="color:blue">trait space</font>.
For example, the <font style="color:blue">Cretaceous-Paleogene</font> extinction (66 million years ago - Mya) has been linked to an increase in <font style="color:blue">size</font> of the mammalian <font style="color:blue">trait space</font> [adaptive radiation; @halliday2015] but more specific questions can be answered by looking at other aspects of <font style="color:blue">trait space</font> occupancy: does the radiation <font style="color:blue">expand</font> on previously existing morphologies [elaboration, increase in density; @endler2005] or does it explore new regions of the <font style="color:blue">trait space</font> [innovation, change in position; @endler2005]?
Similarly, in ecology, if two groups have the same <font style="color:blue">trait space size</font>, it can be interesting to look at differences in density within these two groups: different selection pressure can lead to different density within equally <font style="color:blue">sized</font> groups.


```{r fig_measure_captures, echo = FALSE, fig.height = 3, fig.width = 9, results = 'hide', fig.cap = paste("Figure 2: Illustration how three different size (size. - product of ranges), density (den. - average nearest neighbour distance) and position (pos. - average displacement) measurements capture different occupancy aspects in this simplified trait space. This illustrates how using only one specific space occupancy measure (e.g. the size) will fail to capture changes in B (no change in size), or partial changes in C (also change in density and position)."), eval = FALSE}

## Making the volume/density/position space
vdp_space <- moms::vdp.make()

## Measuring disparity
vdp_disp <- moms::vdp.dispRity(vdp_space,
                         volume = c(prod, ranges),
                         density = c(mean, neighbours),
                         position = c(mean, displacements))

## Checking the table of volume changes
silent <- moms::vdp.check.table(vdp_disp, vdp_space)

## Plotting the results
moms::vdp.plot(vdp_space, plots = c(1, 4, 8), disparity = vdp_disp, mfrow = c(1, 3),
        plot.names = c("A - Base (no changes)", #A
                       "B - Change in position", #D
                       "C - Change in vol. den. & pos.")) #I
```


Here, we provide the first interdisciplinary review of 25 space occupancy measures that uses the broad classification of measures into <font style="color:blue">size</font>, density and position to capture pattern changes in <font style="color:blue">trait space</font>.
We assess the behaviour of measures using simulations and six interdisciplinary empirical datasets covering a wide range of potential data types and biological questions.
We also introduce a tool for measuring occupancy in multidimensional space ([`moms`](https://tguillerme.shinyapps.io/moms/)), which is a user-friendly, open-source, graphical interface to allow the tailored testing of measurement behaviour for any use case.
[`moms`](https://tguillerme.shinyapps.io/moms/) will allow workers to comprehensively assess the properties of their <font style="color:blue">trait space</font> and the measures associated with their specific biological question.






<!--  -->
<!--  -->
<!--  -->
<!-- METHODS SECTION -->
<!--  -->
<!--  -->
<!--  -->








# Methods

```{r metrics_list, echo = FALSE}
## Loading the list of measures
source("list.of.metrics.R")
```

We tested how 25 different space occupancy measures relate to each other, are affected by modifications of traits space and affect group comparisons in empirical data.
To do so, we performed the following steps (explained in more detail below):

1.  We simulated 13 different spaces with different sets of parameters;
2.  We transformed these spaces by removing 50% of the observations following four different scenarios corresponding to different empirical scenarios: randomly, by limit (e.g. expansion or reduction of niches), by density (e.g. different degrees of competition within a guild) and by position (e.g. ecological niche shift).
3.  We measured occupancy on the resulting transformed spaces using `r metric.names()` different space occupancy measures;
4.  We applied the same space occupancy measures to six empirical datasets (covering a range of disciplines and a range of dataset properties). %AM: need to change to measures? Or is that too nitpicky :P 

<font style="color:blue">Note that the paper contains the results for only `r metric.names()` measures which were selected as representative of common metrics covering the <font style="color:blue">size</font>, density and position <font style="color:blue">trait space</font> aspects.</font>
However, the results for the additional 17 measures is available in the supplementary material 4.

## Generating spaces

We generated <font style="color:blue">trait spaces</font> using the following combinations of size, distributions, variance and correlation:

| space name | size  | distribution(s)                | dimensions variance | correlation |
|------------|-------|--------------------------------|---------------------|-------------|
| Uniform3   |200*3  | Uniform (min = -0.5, max = 0.5)| Equal            | None        |
| Uniform15  |200*15 | Uniform                        | Equal            | None        |
| Uniform50  |200*50 | Uniform                        | Equal            | None        |
| Uniform150 |200*150| Uniform                        | Equal            | None        |
| Uniform50c |200*50 | Uniform                        | Equal            | Random (between 0.1 and 0.9) |
| Normal3    |200*3  | Normal  (mean = 0, sd = 1)     | Equal            | None        |
| Normal15   |200*15 | Normal                         | Equal            | None        |
| Normal50   |200*50 | Normal                         | Equal            | None        |
| Normal150  |200*150| Normal                         | Equal            | None        |
| Normal50c  |200*50 | Normal                         | Equal            | Random (between 0.1 and 0.9) |
| Random     |200*50 | Normal, Uniform, Lognormal (meanlog = 0, sdlog = 1)| Equal            | None        |
| PCA-like   |200*50 | Normal                         | Multiplicative           | None        |
| PCO-like   |200*50 | Normal                         | Additive              | None        |
Table 2: different simulated space distribution.
<font style="color:blue"> *Name* of the simulated space in this paper; *dimensions* of the matrix (row\*columns); *distribution(s)* of the data on each dimensions (for the 'Random' space, each dimension is randomly chosen to be Normal, Uniform or Lognormal); *dimension variance*: distribution of the variance between dimensions (when equal, the dimensions have the same variance, otherwise, the variance per dimensions is decreasing either lognormally (multiplicative) or normally (additive); *correlation* between dimensions. </font>

The differences in <font style="color:blue">trait space</font> sizes (200 $\times$ 3, 200 $\times$ 15, 200 $\times$ 50 or 200 $\times$ 150) reflects the range of dimensions in literature: "low-dimension" spaces ($<15$) are common in ecology [@mammola2019] whereas high dimension spaces ($>100$) are common in macroevolution [@hopkins2017].
We used a range of distributions (uniform, normal or <font style="color:blue">a random combination of uniform, normal and lognormal</font>) to test the effect of observation distributions on the measurements.
We used different levels of variance for each dimensions in the spaces by making the variance on each dimension either equal ($\sigma_{D1} \simeq \sigma_{D2} \simeq \sigma_{Di}$) or decreasing ($\sigma_{D1} < \sigma_{D2} < \sigma_{Di}$) with the decreasing factor being either multiplicative (using the cumulative product of the inverse of the number of dimensions: $\prod_i^d(1/d)$) or additive ($\sum_i^d(1/d)$).
Both multiplicative and cumulative reductions of variance are used to illustrate the properties of ordinations where the variance decreases per dimensions [in a lognormal way in principal components analysis - PCA; e.g. @marcy2016; @healy2019; and in a normal way in Multidimensional Scaling - MDS, PCO or PCoA; e.g. @close2015; @wright2017].
Finally, we added a correlation parameter to take into account the potential correlation between different traits <font style="color:blue">to illustrate the effect of co-linearity between traits (especially in non-ordinated trait spaces).</font>
We repeated the simulation of each <font style="color:blue">trait space</font> 20 times (resulting in 260 <font style="color:blue">trait spaces</font>).

## Spatial occupancy measures

We then measured `r metric.names()` different metrics on the resulting transformed spaces, including a new measure we produced, the average displacement, which we expect to be influenced by changes in <font style="color:blue">trait space</font> position.

| Name | Definition | Captures | Source | Notes  |
|------|------------|----------|--------|--------|
| Average Euclidean distance from centroid | $\frac{\sqrt{\sum_{i}^{n}{({k}_{n}-Centroid_{k})^2}}}{d}$ | Size | @laliberté2010 | equivalent to the functional dispersion (FDis) in @laliberté2010 (without abundance) |
| Sum of variances | $\sum_{i}^{d}{\sigma^{2}{k_i}}$ | Size | @foote1992 | common metric used in palaeobiology [@ciampaglio2001; @wills2001] |
| Sum of ranges | $\sum_{i}^{d}{\|\text{max}(d_{i})-\text{min}(d_{i})\|}$ | Size | @foote1992 | more sensitive to outliers than the sum of variances |
| Ellipsoid volume | $\frac{\pi^{d/2}}{\Gamma(\frac{d}{2}+1)}\displaystyle\prod_{i}^{d} (\lambda_{i}^{0.5})$ | Size | @donohue2013 | less sensitive to outliers than the convex hull hypervolume [@diaz2016; @blonder2018] |
| Minimum spanning tree average distance | $\frac{\sum(\text{branch length})}{n}$ | Density | @sedgewick1990 | similar to the unscaled functional evenness [@villéger2008] |
| Minimum spanning tree distances evenness | $\frac{\sum\text{min}\left(\frac{\text{branch length}}{\sum\text{branch length}}\right)-\frac{1}{n-1}}{1-\frac{1}{n-1}}$ | Density | @villéger2008 | the functional evenness without weighted abundance [FEve; @villéger2008] |
| Average nearest neighbour distance | $\sqrt{\sum_{i}^{n}{min({q}_{i}-p_{i})^2}})\times \frac{1}{n}$ | Density | @foote1992 | the density of pairs of observations in the trait space |
| Average displacement | $\frac{\sqrt{\sum_{i}^{n}{({k}_{n})^2}}}{\sqrt{\sum_{i}^{n}{({k}_{n}-Centroid_{k})^2}}}$ | Position | This paper | the ratio between the observations' position from their centroid and the centre of the trait space (coordinates: 0, 0, 0, ...). A value of 1 indicates that the observations' centroid is the centre of the trait space |
Table 3: List of measures with *n* being the number of observations, *d* the total number of dimensions, *k* any specific row in the matrix, *Centroid* being their mean and $\sigma^{2}$ their variance. $\Gamma$ is the Gamma distribution and $\lambda_{i}$ the <font style="color:blue">eigenvalue</font> of each dimension and ${q}_{i}$ and $p_{i}$ are any pairs of coordinates.

We selected these `r metric.names()` space occupancy measures to illustrate how they capture different aspects of space occupancy (but note that this is not an expression of our preference).
The supplementary material 4 contains the same analysis as described below, performed on a total of 25 measures.
<font style="color:blue">Note that these measures are specific to trait spaces that are Euclidean (distances in the space reflect true distances between points) and isotropic (it is as easy to traverse the space in any direction).</font>
Furthermore, [`moms`](https://tguillerme.shinyapps.io/moms/) allows exploration into the effect of many more measures as well as the customisation of measures by combining them or using user-designed functions.

<!--  -->
<!--  -->
<!--  -->
<!-- COMPARING METRICS -->
<!--  -->
<!--  -->
<!--  -->


## Measure comparisons

We compared the space occupancy measures correlations across all simulations between each pair of measures to assess <font style="color:blue">their</font> captured signal [@villéger2008; @laliberté2010].
We used the measures on the full 13 <font style="color:blue">trait spaces</font> described above.
We then scaled the results and measured the pairwise Pearson correlation to test whether measures were capturing a similar signal (high positive correlation), a different signal (correlation close to 0) or an opposite signal (high negative correlations) using the `psych` package [@psych].

<!--  -->
<!--  -->
<!--  -->
<!-- SHIFTING SPACES -->
<!--  -->
<!--  -->
<!--  -->

## Changing space {#changing-spaces}

To assess how the measures responded to changes within <font style="color:blue">trait spaces</font>, we removed 50% of observations each time using the following algorithms:

* **Randomly:** by randomly removing 50% of observations (Fig. 2-A).
This reflects a "null" biological model of changes in <font style="color:blue">trait space</font>: the case when observations are removed regardless of their intrinsic characteristics.
For example, if diversity is reduced by 50% but the <font style="color:blue">trait space size</font> remains the same, there is a decoupling between diversity and space occupancy [@ruta2013].
Our selected measures are expected to not be affected by this change.

* **Limit:** by removing all observations with a distance from the centre of the <font style="color:blue">trait space</font> lower or greater than a radius $\rho$ (where $\rho$ is chosen such that 50% observations are selected) generating two limit removals: *maximum* and *minimum* (respectively in orange and blue; Fig. 2-B).
This can reflect a strict selection model where observations with trait values below or above a threshold are removed leading to an expansion or a contraction of the <font style="color:blue">trait space</font>.
<font style="color:blue">Size</font> measures are expected to be most affected by this change.

* **Density:** by removing any pairs of point with a distance $D$ from each other where (where $D$ is chosen such that 50% observations are selected) generating two density removals: *high* and *low* (respectively in orange and blue; Fig. 2-C).
This can reflect changes within groups in the <font style="color:blue">trait space</font> due to ecological factors [e.g. competition can generate niche repulsion - lower density; @grant2006].
Density measures are expected to be most affected by this change.

* **Position:** by removing points similarly as for **Limit** but using the distance from the furthest point from the centre generating two position removals: *positive* and *negative* (respectively in orange and blue; Fig. 2-D).
This can reflect global changes in <font style="color:blue">trait space</font> due, for example, to an entire group remaining diverse but occupying a different niche.
Position measures are expected to be most affected by this change.

The algorithm to select $\rho$ or $D$ is described in greater detail in in the Supplementary material 1.

```{r fig_reduce_space, echo = FALSE, fig.height = 12, fig.width = 8, results = 'hide', fig.cap = paste("Figure 2: different type of space reduction. Each panel displays two groups of 50% of the data points each. Each group (orange and blue) are generated using the following algorithm: A - randomly; B - by limit (maximum and minimum limit); C - by density (high and low); and D - by position (positive and negative). Panel E et F represents two typical display of the reduction results displayed in Table 5: the dots represent the median space occupancy values across all simulations for each scenario of trait space change (Table 2), the solid and dashed line respectively the 50% and 95% confidence intervals. Results in grey are the random 50% reduction (panel A). Results in blue and orange represent the opposite scenarios from panels B, C, and D. The displayed value is the amount of overlap (Bhattacharrya Coefficient) between the blue or orange distributions and the grey one. Panel E and F shows respectively the \"ideal\" and \"worst\" results for any type of measures, where the space occupancy measurement respectively manages or fails to captures a specific type of reduction (i.e. size, position or density; Table 5).")}

set.seed(42)

## Change colors
defaults$col1 <- "blue"
defaults$col2 <- "orange"

op <- par(mfrow = c(3,2), bty = "n")
## The elements
elements <- 300
## The amount to remove
remove <- 0.5

## Trait space
trait_space <- space.maker(elements, 2, distribution = rnorm)

## Random removal colours
defaults$col1 <- "black"
defaults$col2 <- "grey"

## The randomly removed space
random_rm <- reduce.space(trait_space, type = "random", remove = 0.5)
## Plotting the reduction
plot.space(trait_space, random_rm, main = "A - Random removal", defaults)

## Back to normal colours
defaults$col1 <- "blue"
defaults$col2 <- "orange"

## The limit removal
limit_rm <- reduce.space(trait_space, type = "limit", remove = 0.5)
## Plotting the reduction
plot.space(trait_space, limit_rm, main = "B - Limit", defaults)

## The density removal
density_rm <- reduce.space(trait_space, type = "density", remove = 0.5)
## Plotting the reduction
plot.space(trait_space, density_rm, main = "C - Density", defaults)

## The displacement removal
displace_rm <- reduce.space(trait_space, type = "displacement", remove = 0.5)
## Moving the space to the upper right corner (positive)
plot.space(trait_space, displace_rm, main = "D - Position", defaults)


## Test example (positive)
set.seed(42)
colours <- c("grey", "orange", "blue")
par(bty = "n")
## Plot size
plot(NULL, ylim = c(0.8, 3.2), pch = 19, xlim = c(-1,1), xlab = "Centred and scaled space occupancy", ylab = "", xaxt = "n", yaxt = "n", main = "E - Space reduction \"ideal\" results example (Table 5)")
## Adding lines
abline(v = 0, lty = 2, col = colours, lwd = 2)
## Adding the x axis
axis(1, at = c(-1, -0.5, 0, 0.5, 1), labels = TRUE, tick = TRUE, col.ticks = "black", col = "black", lwd = 2)
## Adding the values
values <- cbind(rnorm(30, mean = 0, sd = 0.15),
                rnorm(30, mean = -0.75, sd = 0.15),
                rnorm(30, mean = 0.75, sd = 0.2))
quantile_vals <- apply(values, 2, quantile, probs = c(0.025, 0.250, 0.750, 0.975))
centtend_vals <- apply(values, 2, median)

## Loop through the lines
for(column in 1:3) {
    ## Get the x y values
    line_x_vals <- quantile_vals[, column]
    line_y_vals <- rep(column, 2)

    ## Add the lines
    n_cis <- 4
    for(ci in 1:(n_cis/2)) {
        lines(x = line_x_vals[c(ci, n_cis-(ci-1))], y = line_y_vals, lty = (n_cis/2 - ci + 1), lwd = ci * 1.5 * 2, col = colours[column])
    }
}
## Add the points
points(x = centtend_vals, y = 1:ncol(values), pch = 19, col = colours, cex = 1.5 + 2)

bc_1 <- dispRity::bhatt.coeff(values[,2], values[,1])
bc_2 <- dispRity::bhatt.coeff(values[,3], values[,1])

text(x = 0.2, y = 3,  labels = round(bc_2, 3), cex = 1.4)
text(x = 0.2, y = 2.9,  labels = paste0("\n(Probability of overlap between\nthe blue and the grey distributions)"), cex = 0.8)
text(x = -0.2, y = 2,  labels = round(bc_1, 3), cex = 1.4)
text(x = - 0.2, y = 1.9,  labels = paste0("\n(Probability of overlap between\nthe orange and the grey distributions)"), cex = 0.8)

## Test example (negative)
set.seed(42)
colours <- c("grey", "orange", "blue")
par(bty = "n")
## Plot size
plot(NULL, ylim = c(0.8, 3.2), pch = 19, xlim = c(-1,1), xlab = "Centred and scaled space occupancy", ylab = "", xaxt = "n", yaxt = "n", main = "F -Space reduction \"worst\" results example (Table 5)")
## Adding lines
abline(v = 0, lty = 2, col = colours, lwd = 2)
## Adding the x axis
axis(1, at = c(-1, -0.5, 0, 0.5, 1), labels = TRUE, tick = TRUE, col.ticks = "black", col = "black", lwd = 2)
## Adding the values
values <- cbind(rnorm(30, mean = 0, sd = 0.15),
                rnorm(30, mean = 0, sd = 0.17),
                rnorm(30, mean = 0, sd = 0.2))
quantile_vals <- apply(values, 2, quantile, probs = c(0.025, 0.250, 0.750, 0.975))
centtend_vals <- apply(values, 2, median)

## Loop through the lines
for(column in 1:3) {
    ## Get the x y values
    line_x_vals <- quantile_vals[, column]
    line_y_vals <- rep(column, 2)

    ## Add the lines
    n_cis <- 4
    for(ci in 1:(n_cis/2)) {
        lines(x = line_x_vals[c(ci, n_cis-(ci-1))], y = line_y_vals, lty = (n_cis/2 - ci + 1), lwd = ci * 1.5 * 2, col = colours[column])
    }
}
## Add the points
points(x = centtend_vals, y = 1:ncol(values), pch = 19, col = colours, cex = 1.5 + 2)

bc_1 <- dispRity::bhatt.coeff(values[,2], values[,1])
bc_2 <- dispRity::bhatt.coeff(values[,3], values[,1])

text(x = 0.5, y = 3,  labels = round(bc_2, 3), cex = 1.4)
text(x = -0.6, y = 2,  labels = round(bc_1, 3), cex = 1.4)

```

To assess the effect of space reduction, distribution and dimensionality on each measure, we scaled the measure to be relative to the non-reduced space for each dimension distribution or number of dimensions.
We subtracted the observed occupancy with no space reduction to all the occupancy measures of the reduced spaces and then divided it by the resulting maximum observed occupancy.
<font style="color:blue">Since the occupancy measures are dependent on their trait space, we scaled and centred them between -1 and 1 to make them comparable.</font>
A value of 0 indicating no effect of the space reduction and $>0$ and $<0$ respectively indicating an increase or decrease in the occupancy measure value.
We then measured the <font style="color:blue">amount</font> of overlap between the non-random removals (limit, density and position) and the random removals using the Bhattacharrya Coefficient [<font style="color:blue">amount</font> of overlap between two distributions; @bhattacharyya1943].

### Measuring the effect of space and dimensionality on shifting spaces

Distribution differences and the number of dimensions can have an effect on the measure results.
For example, in a normally distributed space, an <font style="color:blue">increase</font> in density can often lead to a <font style="color:blue">decrease</font> in <font style="color:blue">size</font>.
This is not necessarily true in log-normal spaces or in uniform spaces for certain measures.<!--  (e.g. the convex hull volume of a lognormal space will be less sensitive to changes in density) -->
Furthermore, high dimensional spaces (>10) are subject to the "curse of multidimensionality" [@cursedimensionality]: data becomes sparser with increasing number of dimensions.
<font style="color:blue">This can have two main unforeseen mathematical consequences: 1) the probability of overlap between two groups decreases as a product of the number of dimensions; and 2) the amount of samples needed to "fill" the spaces increases exponentially [see this interactive illustration by Toph Tucker](https://observablehq.com/@tophtucker/theres-plenty-of-room-in-the-corners).
Furthermore computational time can be increased exponentially rather than linearly with the number of dimensions.</font>
Therefore, the "curse" can make the interpretation of high dimensional data counter-intuitive.
For example if a group expands in multiple dimensions (i.e. increase in <font style="color:blue">size</font>), the actual hypervolume <font style="color:blue">($\prod_{i}^{d} range_{Di}$)</font> can decrease (Fig. 3 and Tables 6, 7).

We measured the effect of space distribution and dimensionality using an ANOVA ($occupancy \sim distribution$ and $occupancy \sim dimensions$) by using all spaces with 50 dimensions and the uniform and normal spaces with equal variance and no correlation with 3, 15, 50, 100 and 150 dimensions (Table 2) for testing respectively the effect of distribution and dimensions.
The results of the ANOVAs (*p*-values) are reported in Table 5 (see supplementary material 3 for the full ANOVA result tables).


<!--  -->
<!--  -->
<!--  -->
<!-- EMPIRICAL EXAMPLES -->
<!--  -->
<!--  -->
<!--  -->

## Empirical examples

We analysed the effect of the different space occupancy measures on six different empirical studies covering a broad range of fields that employ <font style="color:blue">trait space</font> analyses (palaeobiology, macroevolution, evo-devo, ecology, etc.).
For each of these studies we generated <font style="color:blue">trait spaces</font> from the data published with the papers.
We divided each <font style="color:blue">trait spaces</font> into two biologically-relevant groups and tested whether the measures differentiated the groups in different ways.
Both the grouping and the questions <font style="color:blue">were</font> based on a simplified version of the topics of these papers (with no intention to re-analyse the data but to be representative of the diversity of questions in ecology and evolution).
The procedures to generate the data and the groups varies from one study to the other but is detailed and fully reproducible in the supplementary materials 2.


study | field | taxonomic Group | traits (data) | trait space | size | groups (orange/blue in Table 6) | type of question |
------|-------|-----------------|---------------|-------------|------|--------|------------------|
@beck2014 | Palaeontology | Mammalia | discrete morphological phylogenetic data | Ordination of a distance matrix (PCO) | 106*105 | 52 crown vs. 54 stem | Are crown mammals more disparate than stem mammals?|
@wright2017 | Palaeontology | Crinoidea | discrete morphological phylogenetic data | Ordination of a distance matrix (PCO) | 42*41 | 16 before vs. 23 after | Is there a difference in disparity before and after the Ordovician mass extinction?|
@marcy2016 | Evolution | Rodentia | skull 2D landmark coordinates  | Ordination of a Procrustes Superimposition (PCA) | 454*134 | 225 *Megascapheus* vs. 229 *Thomomys* | Are two genera of gopher morphologically distinct? |
@hopkins2016 | Evolution | Trilobita | 3D landmark coordinates | Ordination of a Procrustes Superimposition (PCA) | 46*46 | 36 adults vs. 10 juveniles | Are juvenile trilobites a subset of adult ones? |
@jones2015 | Ecology | Plantae | Communities species compositions | Ordination of a Jaccard distance matrix (PCO) | 48*47 | 24 aspens vs. 24 grasslands | Is there a difference in species composition between aspens and grasslands? |
@healy2019 | Ecology | Animalia | Life history traits | Ordination of continuous traits (PCA) | 285*6 | 83 ecthotherms vs. 202 endotherms | Do endotherms have more diversified life history strategies than ectotherms? |
Table 4: details of the six empirical trait spaces.

For each empirical <font style="color:blue">trait space</font> we bootstrapped each group 500 times [@disprity] and applied the `r metric.names()` space occupancy measure to each pairs of groups.
<!-- Note that when space occupancy could not be calculated (e.g. due to the "curse of multidimensionality"), we collapsed the measure value to 0 (i.e. no space occupancy was captured). -->
We then compared the means of each groups using the Bhattacharrya Coefficient [@bhattacharyya1943].

<!--  -->
<!--  -->
<!--  -->
<!-- RESULTS SECTION -->
<!--  -->
<!--  -->
<!--  -->








# Results

```{r loading_results, echo = FALSE}
## Loading the results
remove_05 <- load.results("remove_05")
```

```{r running_tests, echo = FALSE}
## Anova function
anova.fun <- function(data) {return(aov(glm(disparity ~ factor, data = data)))}

## Running the tests
all_test <- test.simulation(remove_05, test = anova.fun, scale = TRUE)
all_dim_test <- test.simulation(remove_05, test = anova.fun, scale = TRUE,
                      factors = c("uniform3", "uniform15", "uniform50", "uniform100", "uniform150",
                                  "normal3", "normal15", "normal50", "normal100", "normal150"))
space_test <- test.simulation(remove_05, test = anova.fun, scale = TRUE,
                              factors = c("uniform50", "uniform50c", "normal50", "normal50c",
                                          "random50", "pca_like", "pco_like"))
```

## Measure comparisons 


```{r fig_measure_correlation, echo = FALSE, fig.height = 8, fig.width = 8, results = 'hide', fig.cap = paste("Figure 3: pairwise correlation between the scaled measures. Numbers on the upper right corner are the Pearson correlations. The red line are linear regressions (with the confidence intervals in grey).")}

## Adding proper names
results_pairwise <- remove_05
names(results_pairwise[[1]]) <- metric_names

## Plotting the pairwise results
pairwise.plot(results_pairwise, scale = TRUE, type = "base", plot = "cor")
```

All the measures were either positively correlated (Pearson correlation of 0.99 for the average Euclidean distance from centroid and sum of variance or 0.97 for the average nearest neighbour distance and minimum spanning tree average length; Fig. 3) or somewhat correlated (ranging from 0.66 for the sum of variances and the ellipsoid volume to -0.09 between the average displacement and the average Euclidean distance from centroid; Fig. 3).
All measures but the ellipsoid volume were normally (or nearly normally) distributed (Fig. 3).
<!-- This is due to the ellipsoid volume being more sensitive to the curse of multidimensionality (many values close to 0).
 -->
More comparisons between measures are available in the supplementary materials 4.

## Space shifting

```{r fable_results, fig.show='hide', echo=FALSE, fig.height=3, fig.width=3}
## The measures names (shortened vector)
name <- metric_names

## Making a list of parameters for each mini plot
plot.param <- list(scaler = 3,
                   bg.col = "black",
                   col = c("grey", "orange", "blue"),
                   quantiles = c(95, 50),
                   cent.tend = median,
                   pch = 19,
                   metric.max = length(metrics_list),
                   cex = 2)

## Looping through each mini plot for every measure
for(metric in 1:length(metrics_list)) {
    generate.fable.plot(data = remove_05, metric = metric, what = "limits", plot.param = plot.param, overlap = TRUE)
    generate.fable.plot(data = remove_05, metric = metric, what = "densit", plot.param = plot.param, overlap = TRUE)
    generate.fable.plot(data = remove_05, metric = metric, what = "displa", plot.param = plot.param, overlap = TRUE)
}

```

```{r, echo = FALSE, eval = FALSE}
## Function for printing the table in the R console
print.fable <- function(n_measures, byrow, ncol, test) {
  ## Make the plot.id table 
  ids <- matrix(1:(n_measures*ncol), ncol = ncol, byrow = byrow)

  for(one_measure in 1:n_measures) {
    ## Print all the rows one by one
    text <- c(paste0("`r name[", one_measure, "]`"), paste0("`r plot.id(", ids[one_measure, ], ")`"))
    ## Add some tests?
    if(test) {
      text <- c(text, paste0("`r s.test(", one_measure, ", \"s\")`"), paste0("`r s.test(", one_measure, ", \"r\")`"))
    }
    ## Print the line
    cat(paste(text, collapse = " | "))
    cat("|\n")
  }
}
## Getting the fable to copy paste under the table header below.
print.fable(length(metrics_list), byrow = TRUE, ncol = 3, test = TRUE)
```

Measure      | Size change  | Arrangement change | Position change | Distribution effect | Dimensions effect |
:-----------|----------------|-----------------|----------------|---------------------|-------------------|
`r name[1]` | `r plot.id(1)` | `r plot.id(2)` | `r plot.id(3)` | `r s.test(1, "s")` | `r s.test(1, "r")`|
`r name[2]` | `r plot.id(4)` | `r plot.id(5)` | `r plot.id(6)` | `r s.test(2, "s")` | `r s.test(2, "r")`|
`r name[3]` | `r plot.id(7)` | `r plot.id(8)` | `r plot.id(9)` | `r s.test(3, "s")` | `r s.test(3, "r")`|
`r name[4]` | `r plot.id(10)` | `r plot.id(11)` | `r plot.id(12)` | `r s.test(4, "s")` | `r s.test(4, "r")`|
`r name[5]` | `r plot.id(13)` | `r plot.id(14)` | `r plot.id(15)` | `r s.test(5, "s")` | `r s.test(5, "r")`|
`r name[6]` | `r plot.id(16)` | `r plot.id(17)` | `r plot.id(18)` | `r s.test(6, "s")` | `r s.test(6, "r")`|
`r name[7]` | `r plot.id(19)` | `r plot.id(20)` | `r plot.id(21)` | `r s.test(7, "s")` | `r s.test(7, "r")`|
`r name[8]` | `r plot.id(22)` | `r plot.id(23)` | `r plot.id(24)` | `r s.test(8, "s")` | `r s.test(8, "r")`|
Table 5: Results of the effect of space reduction, space dimension distributions and dimensions number of the different space occupancy measures. See Fig. 2 for interpretation of the figures distributions and values. F-values for distribution effect and dimensions effect represents respectively the effect of the ANOVAs space occupancy ~ distributions and space occupancy ~ dimension represent the ratio of sum squared difference within and between groups (the higher, the more the factor has an effect on the measure) and associated _p_-values (0 '\*\*\*' 0.001 '\*\*' 0.01 '\*' 0.05 '.' 0.1 '' 1). This figure illustrates how different measures can be influenced by different aspects of changes in the trait space. For example, the Average Euclidean distance from centroid (row 1) captures mainly changes in <font style="color:blue">size</font> (column 1), but also captures changes in density (column 2) but does not capture changes in position (column 3).


As expected, some different measures capture different aspects of space occupancy.
However, it can be hard to predict the behaviour of each measure when 50% of the observations are removed.
We observe a clear decrease in median metric in less than a third of the space reductions (10/36).

In terms of change in <font style="color:blue">size</font>, only the average Euclidean distance from centroid and the sum of variances seem to capture a clear change in both directions.
However, the increase in <font style="color:blue">size</font> does not correspond to an *actual* increase in volume in the <font style="color:blue">trait space</font> (i.e. the volume from the blue observations in Fig. 2-B is equivalent to the one in Fig. 2-A).
In terms of change in density, only the minimum spanning tree average distance and the average nearest neighbour distance seem to capture a clear change in both directions.
In terms of change in position, only the average displacement metric seems to capture a clear change in direction (albeit not in both directions).
This is not surprising, since the notion of positions becomes more and more complex to appreciate as dimensionality increases (i.e. beyond left/right, up/down and front/back).

## Empirical example

```{r test_empirical, echo = FALSE}
## Loading the results
empirical_results <- load.results("empirical_results")

## Testing the differences for each distributions
bhatt.coeff.safe <- function(x, y, tol = 1e-16, ...) {
  if(all(x < tol) | all(y < tol)) {
    bhatt.coeff(1, 0)
  } else {
    bhatt.coeff(x, y, ...)
  }
} 
disparity_test <- lapply(empirical_results, lapply, test.dispRity, test = bhatt.coeff.safe)
```

```{r fable_results_empirical, fig.show='hide', echo=FALSE, fig.height=3, fig.width=3}
## Plotting parameters
plot.param <- list(cex = 2,
                   col = c("#F7B27E", "#BFE4E3"),
                   border = c("#F65205", "#3E9CBA"),
                   na.cex = 3,
                   scaler = 3)

## Looping through each mini plot for every measure
data_names <- c("Beck and Lee 2014", "Wright 2017", "Marcy et al. 2016",
                "Hopkins and Pearson 2016", "Jones et al. 2015", "Healy et al. 2019")

for(dataset in 1:length(data_names)){
    for(measure in 1:length(metrics_list)){
        ## Plotting the results
        generate.fable.empirical(data = empirical_results[[dataset]][[measure]],
                                 test = disparity_test[[dataset]][[measure]],
                                 precision = 1e-5, plot.param, dataset = dataset)
    }
}
```

```{r change_plotid_chain, echo = FALSE, eval = TRUE}
## Changing defaults
body(plot.id)[[3]] <- substitute(chain <- "fable_results_empirical")
```

```{r, echo = FALSE, eval = FALSE}
print.fable(length(metrics_list), byrow = FALSE, ncol = 6, test = FALSE)
```

Measure     | Beck and Lee 2014  | Wright 2017 | Marcy et al. 2016 | Hopkins and Pearson 2016 | Jones et al. 2015 | Healy et al. 2019  |
:-----------|----------------|-----------------|------------------|----------------|------------------|----------------|
`r name[1]` | `r plot.id(1)` | `r plot.id(9)` | `r plot.id(17)` | `r plot.id(25)` | `r plot.id(33)` | `r plot.id(41)`|
`r name[2]` | `r plot.id(2)` | `r plot.id(10)` | `r plot.id(18)` | `r plot.id(26)` | `r plot.id(34)` | `r plot.id(42)`|
`r name[3]` | `r plot.id(3)` | `r plot.id(11)` | `r plot.id(19)` | `r plot.id(27)` | `r plot.id(35)` | `r plot.id(43)`|
`r name[4]` | `r plot.id(4)` | `r plot.id(12)` | `r plot.id(20)` | `r plot.id(28)` | `r plot.id(36)` | `r plot.id(44)`|
`r name[5]` | `r plot.id(5)` | `r plot.id(13)` | `r plot.id(21)` | `r plot.id(29)` | `r plot.id(37)` | `r plot.id(45)`|
`r name[6]` | `r plot.id(6)` | `r plot.id(14)` | `r plot.id(22)` | `r plot.id(30)` | `r plot.id(38)` | `r plot.id(46)`|
`r name[7]` | `r plot.id(7)` | `r plot.id(15)` | `r plot.id(23)` | `r plot.id(31)` | `r plot.id(39)` | `r plot.id(47)`|
`r name[8]` | `r plot.id(8)` | `r plot.id(16)` | `r plot.id(24)` | `r plot.id(32)` | `r plot.id(40)` | `r plot.id(48)`|
Table 6: Comparisons of pairs of groups in different empirical trait spaces. NAs are used for cases where space occupancy could not be measured due to the curse of multidimensionality. The displayed values are the <font style="color:blue">amount</font> of overlap between both groups (Bhattacharrya Coefficient). The orange and blue boxplots represent the trait space occupancy for the following groups from left to right: crown *vs.* stem mammals; crinoids before *vs.* after the end-Ordovician extinction;  *Megascapheus* *vs.* *Thomomys*; adults *vs.* juveniles trilobites; aspens *vs.* grasslands communities; ecthotherms *vs.* endotherms.

Similarly as for the simulated results, the empirical ones indicate that there <font style="color:blue">can be</font> no perfect one-size-fit all measurement.
For all `r metric.names()` measures (<font style="color:blue">except</font> the ellipsoid volume) we see either one group or the other having a bigger mean than the other and no consistent case where a group has a bigger mean than the other for all the measures.
For example, in the @beck2014's dataset, there is a clear <font style="color:blue">difference in  size</font> using the average Euclidean distance from centroid or the sum of variances (overlaps of respectively 0.175 and 0.159) but no overlap when measuring the <font style="color:blue">size</font> using the sum of ranges (0.966).
However, for the @hopkins2016's dataset, this pattern is reversed (no clear differences for the average Euclidean distance from centroid or the sum of variances - 0.701 and 0.865 respectively) but a clear difference for the sum of ranges (0).
Furthermore, for each dataset, the absolute differences between each groups is not consistent depending on the measures.
For example, in @hopkins2016's dataset, the orange group's mean is clearly higher than the blue one when measuring the sum of ranges (0) and the inverse is true when measuring the average displacement (0).


<!--  -->
<!--  -->
<!--  -->
<!-- DISCUSSION SECTION -->
<!--  -->
<!--  -->
<!--  -->








# Discussion

Here we tested 25 measures of <font style="color:blue">trait space</font> occupancy on simulated and empirical datasets to assess how each measure captures changes in <font style="color:blue">trait space size</font>, density and position.
Our results show that the correlation between measures can vary both within and between measure categories (Fig. 3), highlighting the importance of understanding the measure classification for the interpretation of results.
Furthermore, our simulations show that different measures capture different types of <font style="color:blue">trait space</font> change (Table 5), meaning that the use of multiple measures is important for comprehensive interpretation of <font style="color:blue">trait space</font> occupancy.
We also show that the choice of measure impacts the interpretation of group differences in empirical datasets (Table 6), again emphasizing that measure choice has a real impact on the interpretation of specific biological questions


#### Measures comparisons

Measures within the same category of <font style="color:blue">trait space</font> occupancy (<font style="color:blue">size</font>, density or position) do not have the same level of correlation with each other.
For example, the average Euclidean distance from centroid (<font style="color:blue">size</font>) is highly correlated to the sum of variances (<font style="color:blue">size</font> - correlation of 0.99) and somewhat correlated with the minimum spanning tree average distance (density - correlation of 0.66) but poorly with the ellipsoid volume (<font style="color:blue">size</font> - correlation of 0.17) and the minimum spanning tree distances evenness (density - correlation of -0.05).
Furthermore, the fact that we have such a range of correlations for normal distributions suggests that each measure can capture different summaries of space occupancy ranging from obvious differences (for measures not strongly correlated) to subtle ones (for measures strongly correlated).

<!-- Analysing the properties of measures in a <font style="color:blue">trait space</font> prior to using them to answer macroevolutionary or ecological questions can bring valuable insights into what aspect of space occupancy they are capturing.
For example, if some space occupancy measures captures the same pattern using the sum of variances and the sum of ranges, it is possible that the <font style="color:blue">trait space</font> have really similar properties (i.e. space with equal normal dimensions).
 -->

#### Space shifting

Most measures capture no changes in space occupancy for the "null" (random) space reduction (in grey in Table 5).
This is a desirable behaviour for space occupancy measures since it will likely avoid false positive errors in empirical studies that estimate biological processes from space occupancy patterns [e.g. competition @brusatte2008, convergence @marcy2016, life history traits @healy2019].
However, the average nearest neighbour distance and the sum of ranges have a respectively positive and negative "null" median.
This is not especially a bad property but it should be kept in mind that even random processes can increase or decrease these measures' <font style:"color=blue">values</font>.

Regarding the changes in <font style="color:blue">size</font>, the sum of variances and the average Euclidean distance from centroid are good descriptors (Table 5).
However, as illustrated in the 2D examples in Fig. 2-B only the blue change results (maximum limit - Table 5) should not result in a direct change in <font style="color:blue">overall size</font> since the <font style="color:blue">trait space</font> is merely "hollowed" out.
That said, "hollowing" is harder to conceptualise in many dimensions and the measures can still be interpreted for comparing groups (orange has a smaller volume than blue).

Regarding changes in density, the average nearest neigbhour distance and the minimum spanning tree average distance consistently detect changes in density with more precision for low density <font style="color:blue">trait spaces</font> (in blue in Table 5).
However, we can observe some degree of correlation between the changes in density and the changes in <font style="color:blue">size</font> for most measure picking either signal.
This could be due to the use of normally distributed spaces where a change in density often leads to a change in <font style="color:blue">size</font>.
This is not necessarily the case with empirical data.

Regarding the changes in position of the <font style="color:blue">trait space</font>, only the average displacement measure seems unable to distinguish between a random change and a displacement of the <font style="color:blue">trait space</font> (Table 5). %AM: I think I kept the original meaning here but please double check :)
Furthermore, the average displacement measure does not distinguish between and positive or a negative displacement of the <font style="color:blue">trait space</font>: this might be due to the inherent complexity of *position* in a multidimensional <font style="color:blue">trait space</font>.

<!-- Regarding the effect of dimensions and <font style="color:blue">trait space</font> distribution, measures seems to be either affected by neither of these factors or by both (Table 5).
Again, this should not preclude using measures that are sensitive to <font style="color:blue">trait spaces</font>' dimensions and distributions [e.g. the ellispoid volume is a good <font style="color:blue">size</font> descriptor up until a moderate number of dimensions; @jackson2011; @donohue2013] but should be kept in mind.
 -->

#### Empirical examples

Although most differences are fairly consistent within each dataset with one group having a higher space occupancy score than the other for multiple measures, this difference can be more or less pronounced within each dataset (ranging from no to nearly full overlap - BC $\in(0;0.995)$) and sometimes even reversed.
This indicates that opposite conclusions can be drawn from a dataset depending on which space occupancy measure is considered.
For example, in @wright2017, crinoids after the Ordovician mass extinction have a higher median measure value for all measures but for the average displacement.
These differences depending on the measures are also more pronounced in the empirical datasets where the observations per group are unequal [@hopkins2016; @healy2019].
<!-- Finally, it is worth noting that the ellispoid volume only picks up accurate differences between groups in the @healy2019 dataset which is yet another illustration of the curse of multidimensionality: the @healy2019 dataset has only 6 dimensions compared to all the other ones having more than 41 dimensions [and the @marcy2016 dataset having 136 dimensions for which the ellipsoid volume can't be calculated; Table 6; @cursedimensionality].
 -->

### Caveats

While our simulations have been useful to illustrate the behavior of diverse space occupancy measures, they have several caveats.
First, the simulated observations in the <font style="color:blue">trait spaces</font> are independent.
This is not the case in biology where observations can be spatially [@jones2015] or phylogenetically correlated [e.g. @beck2014].
Second, the algorithm used to reduce the <font style="color:blue">trait spaces</font> might not always accurately <font style="color:blue">reflect</font> changes.
This might favour some specific measures over others, in particular for the changes in density that modify the nearest neighbour density rather than changing the global density.
This algorithmic choice was made in order to not confound changes in density along with changes in <font style="color:blue">size</font>.
However, the results presented here probably capture the general behaviour of each measure since results are consistent between the simulated and empirical analysis.
Furthermore, [`moms`](https://tguillerme.shinyapps.io/moms/) allows workers to test the caveats mentioned above by uploading empirical <font style="color:blue">trait spaces</font>.

### Suggestions

We insist that no measure is better than the next one and that researchers should identify the most appropriate measures based on their <font style="color:blue">trait space</font> properties as well as their specific biological question.
However, following the findings of this study we make several suggestions:

First, we suggest using multiple measures to tackle different aspects of the <font style="color:blue">trait space</font>. 
This follows the same logical thinking that the mean might not be sufficient to describe a distribution (e.g. the variance might be <font style="color:blue">a</font> good additional descriptor).
Although using multiple measures is not uncommon in macroevolutionary studies [e.g. @halliday2015] or in ecology [@mammola2019], they often do not cover contrasted aspects of the <font style="color:blue">trait space</font>. %AM: instead of contrast, something to the effect of "do no cover more than one of the three categories of trait space measures"?

Second, we suggest selecting the measures that best address the biological question <font style="color:blue">at</font> hand.
If one studies an adaptive radiation in a group of organisms, it is worth thinking what would be the expected null model: would the group's <font style="color:blue">size</font> increase (radiation in all directions), would it increase in density (niche specialisation) or would it shift in position (radiation into a new set of niches)?

Third, we suggest to not name measures after the biological aspect they often describe <font style="color:blue">which can be vague</font> (e.g. "disparity" or "functional dispersion") but rather after what they are measuring <font style="color:blue">and why</font> (e.g. <font style="color:blue">"we used sum of ranges to capture the trait space size"</font>).
We believe this will support both a clearer understanding of what *is* measured as well as better communication between ecology and evolution research where measures can be similar but have different names (Fig. 3).

Multidimensional analyses have been acknowledged as essential tools in modern biology but they can often be counter-intuitive [@cursedimensionality].
It is thus crucial to accurately describe patterns in multidimensional <font style="color:blue">trait spaces</font> to be able to link them to biological processes.
When summarising <font style="color:blue">trait spaces</font>, it is important to remember that a pattern captured by a specific space occupancy measure is often dependent on the properties of the <font style="color:blue">trait space</font> and of the particular biological question of interest. %AM: add: of the underlying dataset? or is that redundant with trait space?
We believe that having a clearer understanding of both the properties of the <font style="color:blue">trait space</font> and the associated space occupancy measures (e.g. using [`moms`](https://tguillerme.shinyapps.io/moms/)) as well as using novel space occupancy measures to answer specific questions will be of great use to study biological processes in a multidimensional world.


# Acknowledgements

We thank Natalie Jones and Kevin Healy for helping with the empirical ecological datasets and two anonymous reviewer for their comments.
We acknowledge funding from the Australian Research Council DP170103227 and FT180100634 awarded to VW.

# Authors contributions

TG, MNP, AEM and VW designed the project.
TG and AEM collected the empirical dataset.
TG ran the analyses and designed the software.
TG, MNP, AEM and VW wrote the manuscript.

# Data Availability, repeatability and reproducibility

The raw empirical data is available from the original papers [@beck2014; @jones2015, @marcy2016; @hopkins2016; @wright2017; @healy2019].
The subsets of the empirical data used in this analysis are available on figshare 
[DOI: 10.6084/m9.figshare.9943181.v1](https://doi.org/10.6084/m9.figshare.9943181.v1).
The modified empirical data are available in the package accompanying this manuscript (`data(moms::demo_data)`).
This manuscript (including the figures, tables and supplementary material) is repeatable and reproducible by compiling the vignette of the [GitHub `moms R` package](https://github/TGuillerme/moms).
The code for the `moms` shiny app is available from the [GitHub `moms R` package](https://github/TGuillerme/moms).

# References
