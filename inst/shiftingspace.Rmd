---
title: "Shifting spaces: which disparity or dissimilarity metrics best summarise occupancy in multidimensional spaces?"
author: "Thomas Guillerme, Mark N. Puttick, Ariel E. Marcy, Vera Weisbecker"
bibliography: references.bib
csl: mee.csl
date: "`r Sys.Date()`"
output:
  html_document:
    fig_width: 8
    fig_height: 8
---


<!-- Keywords: disparity, dissimilarity, ecology, evolution, multidimensionality, statistics -->


<!-- When toggling to html, toggle snippet `compilation_html` below to eval = TRUE -->

<!-- To build the line numbered version (for submission) use the following yaml header snippet
output:
  pdf_document:
    fig_width: 8
    fig_height: 8
    keep_tex: true
  self_contained: false


output:
  html_document:
    fig_width: 8
    fig_height: 8
---
and edit the save .tex file to add the following

\usepackage{lineno} %in the package header

\linespread{2} %in the document header

\modulolinenumbers[1] % just after the \begin{document} tag
\linenumbers

 -->


```{r header, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}
## Repeatability note:
## This whole paper is entirely reproducible and compiles as a single document. The data, figures
## and tables are all generated through the code snippets in this file. Note that the first time
## that this paper is compiled, it will generate the data which will take substantial time
## as the shiftingspace_supplementary.Rmd file completion takes ~10 minutes. Subsequent compilations
## will be much faster!

## Loading the packages
if(!require(devtools)) install.packages("devtools")
if(!require(knitr)) install.packages("knitr"); library(knitr)
if(!require(rmarkdown)) install.packages("rmarkdown"); library(rmarkdown)
if(!require(ape)) install.packages("ape"); library(ape)
if(!require(dispRity)) install.packages("dispRity"); library(dispRity)
if(packageVersion("dispRity") < "1.2.4") {
    ## dispRity must be above v1.2.3
    devtools::install_github("TGuillerme/dispRity"); library(dispRity)
}
if(!require(moms)) devtools::install_github("TGuillerme/moms"); library(moms)

## Setting the datapath
DATA_PATH <- "../data/processed/"

## Create data directory
if(!dir.exists(DATA_PATH)) {
    dir.create(path = DATA_PATH, showWarnings = FALSE)
}

## Setting the default parameters for the space plots
defaults <- list(pch = 20,
                 xlim = c(-3, 3),
                 ylim = c(-3, 3),
                 col1 = "grey",
                 col2 = "black",
                 xlab = "Trait",
                 ylab = "Trait",
                 cex = 1)
## Generating the default palette
default.palette <- function(n) {
    hues <- seq(15, 375, length = n + 1)
    grDevices::hcl(h <- hues, l = 65, c = 100)[1:n]
}

## Checking whether the data exists
if(!all(c("remove_05.Rda") %in% list.files(DATA_PATH))) {
    ## Run The supplementary material (simulation) ~ 30 minutes
    rmarkdown::render("shiftingspace_supplementary_simulation.Rmd", "html_document")    
}
if(!all(c("empirical_results.Rda") %in% list.files(DATA_PATH))) {
    ## Run The supplementary material ~ 15 minutes
    rmarkdown::render("shiftingspace_supplementary_empirical.Rmd", "html_document")
}
```

```{r table_counter, echo = FALSE}
## Table and figure counter
element.counter <- function(name, all_names, increment = FALSE) {
    if(increment) {
        ## Numbering a table or a figure
        all_names <- c(all_names[[2]], name)
        ## Print the table number
        # length(all_names)
        return(list(print = length(all_names), list = all_names))
    } else {
        ## Printing the number of the table of figure
        # cat(which(all_names %in% name))
        return(list(print = which(all_names[[2]] %in% name), list = all_names[[2]]))
    }
}
## Initialising the elements counters
tables <- list(print = NULL, list = character())
figures <- list(print = NULL, list = character())

## Function wrappers
table <- function(name, add = FALSE, all_names = tables) {
    return(element.counter(name, all_names, increment = add))
}
figure <- function(name, add = FALSE, all_names = figures) {
    return(element.counter(name, all_names, increment = add))
}

```


```{r compilation_html, echo = FALSE, eval = FALSE}
## Changing defaults
body(plot.id)[[2]] <- substitute(type <- ".png")
```

# Abstract


1. Multidimensional analysis of traits are now a common toolkit in ecology and evolution and are based on trait-spaces in which each dimension summarise the observed trait combination (a morphospace or an ecospace).
Observations of interest will typically occupy a subset of this trait-space, and researchers will apply one or more metrics to quantify the way in which organisms "inhabit" that trait-space.
In macroevolution and ecology these metrics are referred to as disparity or dissimilarity metrics and can be generalised as space occupancy metrics.
Researchers use these metrics to investigate how space occupancy changes through time, in relation to other groups of organisms, and in response to global environmental changes, such as global warming events or mass extinctions.
However, the mathematical and biological meaning of most space occupancy metrics is vague with the majority of widely-used metrics lacking formal description.

2. Here we propose a broad classification of space occupancy metrics into three categories that capture changes in volume, density, or position.
We analyse the behaviour of 25 metrics to study changes in trait-space volume, density and position on a series of simulated and empirical datasets.

3. We find no one metric describes all of trait-space but that some metrics are better at capturing certain aspects compared to other approaches and that their performance depends on both the trait-space and the hypothesis analysed. 
However, our results confirm the three broad categories (volume, density and position) and allow to relate changes in any of these categories to biological phenomena.

4. Since the choice of space occupancy metric should be specific to the data and question at had, we introduced [`moms`](https://tguillerme.shinyapps.io/moms/), a user-friendly tool based on a graphical interface that allows users to both visualise and measure changes space occupancy for any metric in simulated or imported trait-spaces.
Users are also provided with tools to transform their data in space (e.g. contraction, displacement, etc.).
This tool is designed to help researchers choose the right space occupancy metrics, given the properties of their trait-space and their biological question.


# Introduction

Groups of species and environments share specific, easily recognisable, correlated characteristics of many kinds: guilds or biomes with shared phenotypic, physiological, phylogenetic or behavioural traits.
Organisms or environments should therefore be studied as a set of traits rather than some specific traits in isolation [@donohue2013; @hopkins2017].
Biologists have increasingly been using ordination techniques [see @legendre2012 for a summary] to create multidimensional trait-spaces to either explore properties of the data or test hypotheses [@oksanen2007vegan; @adams2013geomorph; @momocs; @blonder2018; @disprity].
<!-- Optional: remove momocs -->
For example, in palaeobiology, @wright2017 use trait-spaces to study how groups of species' characteristics change through time; in ecology, @jones2015 study evidence of competition by looking at trait overlap between two populations.
However, different fields use a different set of terms for such approaches (Table 1).
<!-- In macroevolution, they are commonly referred to as "morphospaces" with the whole procedure often being often called "disparity analysis" [e.g. @adams2013geomorph; @marcy2016; @wright2017], while in ecology, they can be called "functional spaces" and or "dissimilarity analysis" [e.g. @diaz2016; @mammola2019].-->
Nonetheless, they are the same mathematical objects: matrices with columns representing an original or transformed trait value and rows representing observations, such as taxon, field site, etc. [@disprity].

In mathematics | In ecology | In macroevolution | In this paper
---------------|------------|-------------------|---------------
Matrix ($n \times d$) | Function-space, Eco-space, etc. | Morphospace, traitspace, etc. | trait-space
Rows (*n*) | Taxa, field sites, environments, etc. | Taxa, specimen, populations, etc. | observations
Columns (*d*) | Traits, Ordination scores, distances, etc. | Traits, Ordination scores, distances, etc. | dimensions
Matrix subset ($m \times d$; $m \leq n$) | Treatments, phylogenetic group (clade), etc. | Clades, geological stratum, etc. | group
Statistic | Dissimilarity index or metric, hypervolume, functional diversity | Disparity metric or index | space occupancy metric
Multidimensional analysis | Dissimilarity analysis, trait analysis, etc. | Disparity analysis, disparity-through-time, etc. | multidimensional analysis
Table 1: terms and equivalence between mathematics, ecology and macroevolution.

Ecologists and evolutionary biologists also often use trait-spaces with respect to the same fundamental questions: are groups overlapping in the trait-space?
Are some regions of the trait-space not occupied?
How do specific factors influence the occupancy of the trait-space?
Studying the occupancy of trait-spaces can be achieved using disparity metrics in macroevolution [@wills2001; @hopkins2017; @disprity] or comparing hypervolumes in ecology [@donohue2013; @diaz2016; @blonder2018; @mammola2019].
However, although these space occupancy metrics are common in ecology and evolution, surprisingly little work has been published on their behaviour [but see @ciampaglio2001; @villéger2008; @mammola2019].

Different space occupancy metrics capture different aspects of the trait-space [ciampaglio2001; @villéger2008; @mammola2019].
It may be widely-known by many in the field, but to our knowledge this is infrequently mentioned in peer-reviewed papers.
First, space occupancy metrics are often named as the biological aspect they are describing (e.g. "disparity" or "functional diversity") rather than what they are measuring (e.g. the average pairwise distances) which obscures the differences or similarities between studies.
Second, in many studies in ecology and evolution, authors have focused on measuring the volume of the trait-space with different metrics [e.g. ellipsoid volume @donohue2013; hypervolume @diaz2016; product of variance @wright2017; Procrustes variance @marcy2016].
However, volume only represents a single aspects of space occupancy, disregarding others such as the density [@geiger2008] or position [@wills2001; @ciampaglio2001].
For example, if two groups occupy the same volume in trait-space, this will lead to supporting certain biological conclusions.
Yet, an alternative aspect of space occupancy may indicate that the groups' position are different; this would likely lead to a different biological conclusion (e.g. the groups are equally diverse but occupy different niches).
Using metrics that only measure one aspect of the multidimensional trait-space may restrain the potential of multidimensional analysis [@villéger2008].

Here we propose a broad classification of space occupancy metrics as used across ecology and evolution and analyse their power to detect changes in trait-space occupancy in simulated and empirical data.
We provide an assessment of each broad type of space occupancy metrics along with a unified terminology to foster communication between ecology and evolution.
Unsurprisingly, we found no one metric describes all changes through a trait-space and the results from each metric are dependent on the characteristics of the space and the hypotheses.
Furthermore, because there can potentially be an infinite number of metrics, it would be impossible to propose clear generalities to space occupancy metrics behavior.
Therefore, we propose [`moms`](https://tguillerme.shinyapps.io/moms/), a user-friendly tool allowing researchers to design, experiment and visualise their own space occupancy metric tailored for their specific project and helping them understanding the "null" behavior of their metrics of interest.


## Space occupancy metrics

In this paper, we define trait-spaces as any matrix where rows are observations and columns are traits.
These traits can widely vary in number and types: they could be coded as discrete [e.g. presence or absence of a bone; @beck2014; @wright2017], continuous measurements [e.g. leaf area; @diaz2016] or more sophisticated measures [e.g. landmark position; @marcy2016; Fourier ellipses; @momocs].
Traits can also be measured by using relative observations [e.g. community compositions; @jones2015] or distance between observations [e.g. @close2015].
However, regardless of the methodology used to build a trait-space, three broad occupancy metrics can be measured: the volume which will approximate the amount of space occupied, the density which will approximate the distribution in space and the position which will approximate the location in space [Fig. 1; @villéger2008].
Of course any combination of these three aspects is always possible.

```{r fig_metrics_types, echo = FALSE, fig.height = 3, fig.width = 9, results = 'hide', fig.cap = paste("Figure 1: different type of information captured by space occupancy metrics. A - Volume (e.g. sum of ranges); B - Density (e.g. average squared pairwise distances); C - Position (e.g. median distance from centroid).") }

set.seed(11)
## Plot space function (utility shortcut)
## The elements
elements <- 10

## Trait space
trait_space <- space.maker(elements, 2, distribution = rnorm)

## Graphical parameters
op <- par(mfrow = c(1,3), bty = "n")

## The volume
plot(trait_space, pch = defaults$pch, main = "A - Volume", xlab = "Trait 1", ylab = "Trait 2")
## The range lines
lines(x = range(trait_space[,1]), y = rep(mean(trait_space[,2]), 2), col = defaults$col1)
lines(x = rep(mean(trait_space[,1]), 2), y = range(trait_space[,2]), col = defaults$col1)

## The density
plot(trait_space, pch = defaults$pch, main = "B - Density", xlab = "Trait 1", ylab = "")
## Plotting the pairwise lines
pair.line <- function(line, trait_space, defaults) {
    lines(x = trait_space[line,1], y = trait_space[line,2], col = defaults$col1)
}
apply(combn(1:elements, 2), 2, pair.line, trait_space, defaults)
points(trait_space, pch = defaults$pch)

## The position
plot(trait_space, pch = defaults$pch, main = "C - Position", xlab = "Trait 1", ylab = "")
## Plotting the center of the space
points(0,0, pch = 13, cex = 2)
arrows(x0 = 0, y0 = 0, x1 = trait_space[,1], y1 = trait_space[,2], code = 0, col = defaults$col1)
points(trait_space, pch = defaults$pch)

par(op)
```

#### 1. Volume

Volume metrics measure the spread of a group in the trait-space.
They can be interpreted as the amount of the trait-space that is occupied by observations.
Typically, larger values for such metrics indicate the presence of more extreme trait combinations.
For example, if group A has a bigger volume than group B, the observations in A achieve more extreme trait combinations than in B.
This type of metric is widely used in both ecology [e.g. the hypervolume; @blonder2018] and in evolution [e.g. the sum or product of ranges or variances; @wills2001].

Although volume metrics are a suitable indicator for comparing a group's trait-space occupancy, it is limited to comparing the range of trait-combinations between groups.
Volume metrics do not take into account the distribution of the observations within a group.
In other words, they can make it difficult to determine whether all the observations are on the edge of the volume or whether the volume is simply driven by small number of extreme observations.

<!-- This aspect of space occupancy is used routinely in ecology and macroevolution:
for example @wright2017 uses the volume of trait-space to analyse how crinoid ecology changes through time relative to all the observed ecologies in the the crinoid trait-space.
A larger "spread" at a specific point in time [e.g. 360 to 330 million years ago (Mya); @wright2017] indicates a larger diversity of ecological feeding strategies.
In general the volume of a group in the trait-space indicates how much trait combinations that group achieves in the trait-space. -->

#### 2. Density

Density metrics measure the distribution of a group in the trait-space.
They can be interpreted as the distribution of the observations *within* a group in the trait-space.
Groups with higher density have observations within it that tend to be more similar to each other.
For example, if group A has a greater volume than group B but both have the same density, similar mechanisms could be driving both groups' trait-space occupancy.
However, this might suggest that A is older and had more time to achieve more extreme trait combinations under essentially the same process [@endler2005].
Density is less commonly measured compared to volume, but it is still used in both ecology [e.g. the minimum spanning tree length; @oksanen2007vegan] and evolution [e.g. the average pairwise distance; @geiger2008].

#### 3. Position

Position metrics measure where a group lies in trait-space.
They can be interpreted as where a group lies in the trait-space either relative to the space itself or relative to another group.
For example, if group A has a different position than group B, observations in A will have a different trait-combination than B.

Position metrics may be harder to interpret in multidimensional spaces (i.e. beyond left/right, up/down and front/back).
However, when thinking about unidimensional data (one trait), this metric is obvious: two groups A or B could have the same variance (i.e. "volume" or spread) with the same number of observations (i.e. density) but could have a different mean and thus be in different positions.
These metrics have been used in ecology to compare the position of two groups relatively to each other [@mammola2019].

## No metric to rule them all: benefits of considering multiple metrics

The use of multiple metrics to assess trait-space occupancy has the benefit of providing a more detailed characterisation of occupancy changes.
If the question of interest is, say, to look at how space occupancy changes in response to mass extinction, using a single space occupancy metric can miss part of the picture: a change in volume could be decoupled from a change in position or density in trait-space.
For example, the Cretaceous-Palaeogene extinction (66 million years ago - Mya) has been linked to an increase in volume of the mammalian trait-space [adaptive radiation; @halliday2015] but more specific questions can be answered by looking at other aspects of trait-space occupancy: does the radiation expands on previously existing morphologies [elaboration, increase in density; @endler2005] or does it explore new regions of the trait-space [innovation, change in position; @endler2005]?
Similarly, in ecology, if two groups occupy the same volume in the trait-space, it can be interesting to look at differences in density within these two groups: different selection pressure can lead to different density within equal volume groups.


```{r fig_metric_captures, echo = FALSE, fig.height = 3, fig.width = 9, results = 'hide', fig.cap = paste("Figure 2: Illustration how three different volume (vol. - product of ranges), density (den. - average nearest neighbour distance) and position (pos. - average displacement) metrics capture different occupancy aspects in this simplified trait-space. This illustrates how using only one specific space occupancy metric (e.g. the volume) will fail to capture changes in B (no change in volume), or partial changes in C (also change in density and position)."), eval = FALSE}

## Making the volume/density/position space
vdp_space <- moms::vdp.make()

## Measuring disparity
vdp_disp <- moms::vdp.dispRity(vdp_space,
                         volume = c(prod, ranges),
                         density = c(mean, neighbours),
                         position = c(mean, displacements))

## Checking the table of volume changes
silent <- moms::vdp.check.table(vdp_disp, vdp_space)

## Plotting the results
moms::vdp.plot(vdp_space, plots = c(1, 4, 8), disparity = vdp_disp, mfrow = c(1, 3),
        plot.names = c("A - Base (no changes)", #A
                       "B - Change in position", #D
                       "C - Change in vol. den. & pos.")) #I
```


Here, we provide the first interdisciplinary review of 25 space occupancy metrics that uses the broad classification of metrics into volume, density and position to capture pattern changes in trait-space.
We assess the behaviour of metrics using simulations and six interdisciplinary empirical datasets covering a wide range of potential data types and biological questions.
We also introduce a tool for measuring occupancy in multidimensional space ([`moms`](https://tguillerme.shinyapps.io/moms/)), which is a user-friendly, open-source, graphical interface to allow the tailored testing of metric behaviour for any use case.
[`moms`](https://tguillerme.shinyapps.io/moms/) will allow workers to comprehensively assess the properties of their trait-space and the metrics associated with their specific biological question.






<!--  -->
<!--  -->
<!--  -->
<!-- METHODS SECTION -->
<!--  -->
<!--  -->
<!--  -->








# Methods

```{r metrics_list, echo = FALSE}
## Loading the list of metrics
source("list.of.metrics.R")
```

We tested how 25 different space occupancy metrics relate to each other, are affected by modifications of traits space and affect group comparisons in empirical data.
To do so, we performed the following steps (explained in more detail below):

1.  We simulated 13 different spaces with different sets of parameters;
2.  We transformed these spaces by removing 50% of the observations following four different scenarios corresponding to different empirical scenarios: randomly, by limit (e.g. expansion or reduction of niches), by density (e.g. different degrees of competition within a guild) and by position (e.g. ecological niche shift).
3.  We measured occupancy on the resulting transformed spaces using `r metric.names()` different space occupancy metrics;
4.  We applied the same space occupancy metrics to six empirical datasets (covering a range of disciplines and a range of dataset properties).

Note that the paper contains the results for only `r metric.names()` metrics, the results for the additional 17 metrics is available in the supplementary material 4.

## Generating spaces

We generated trait-spaces using the following combinations of size, distributions, variance and correlation:

| space name | size  | distribution(s)                | dimensions variance | correlation |
|------------|-------|--------------------------------|---------------------|-------------|
| Uniform3   |200*3  | Uniform (min = -0.5, max = 0.5)| Equal            | None        |
| Uniform15  |200*15 | Uniform                        | Equal            | None        |
| Uniform50  |200*50 | Uniform                        | Equal            | None        |
| Uniform150 |200*150| Uniform                        | Equal            | None        |
| Uniform50c |200*50 | Uniform                        | Equal            | Random (between 0.1 and 0.9) |
| Normal3    |200*3  | Normal  (mean = 0, sd = 1)     | Equal            | None        |
| Normal15   |200*15 | Normal                         | Equal            | None        |
| Normal50   |200*50 | Normal                         | Equal            | None        |
| Normal150  |200*150| Normal                         | Equal            | None        |
| Normal50c  |200*50 | Normal                         | Equal            | Random (between 0.1 and 0.9) |
| Random     |200*50 | Normal, Uniform, Lognormal (meanlog = 0, sdlog = 1)| Equal            | None        |
| PCA-like   |200*50 | Normal                         | Multiplicative           | None        |
| PCO-like   |200*50 | Normal                         | Additive              | None        |
Table 2: different simulated space distributions.

The differences in trait-space sizes (200 $\times$ 3, 200 $\times$ 15, 200 $\times$ 50 or 200 $\times$ 150) reflects the range of dimensions in literature: "low-dimension" spaces ($<15$) are common in ecology [@mammola2019] whereas high dimension spaces ($>100$) are common in macroevolution [@hopkins2017].
We used a range of distributions (uniform, normal or random) to test the effect of observation distributions on the metrics.
We used different levels of variance for each dimensions in the spaces by making the variance on each dimension either equal ($\sigma_{D1} \simeq \sigma_{D2} \simeq \sigma_{Di}$) or decreasing ($\sigma_{D1} < \sigma_{D2} < \sigma_{Di}$) with the decreasing factor being either multiplicative (using the cumulative product of the inverse of the number of dimensions: $\prod_i^d(1/d)$) or additive ($\sum_i^d(1/d)$).
Both multiplicative and cumulative reductions of variance are used to illustrate the properties of ordinations where the variance decreases per dimensions [in a lognormal way in principal components analysis - PCA; e.g. @marcy2016; healy2019; and in a normal way in Multidimensional Scaling - MDS, PCO or PCoA; e.g. @close2015; @wright2017].
Finally, we added a correlation parameter to take into account the potential correlation between different traits.
We repeated the simulation of each trait-space 20 times (resulting in 260 trait-spaces).

## Spatial occupancy metrics

We then measured `r metric.names()` different metrics on the resulting transformed spaces, including a new metric we produced, the average displacement, which we expect to be influenced by changes in trait-space position.

| Name | Definition | Captures | Source | Notes  |
|------|------------|----------|--------|--------|
| Average distance from centroid | $\frac{\sqrt{\sum_{i}^{n}{({k}_{n}-Centroid_{k})^2}}}{d}$ | Volume | @laliberté2010 | equivalent to the functional dispersion (FDis) in @laliberté2010 (without abundance) |
| Sum of variances | $\sum_{i}^{d}{\sigma^{2}{k_i}}$ | Volume | @wills2001 | common metric used in palaeobiology [@ciampaglio2001] |
| Sum of ranges | $\sum_{i}^{d}{\|\text{max}(d_{i})-\text{min}(d_{i})\|}$ | Volume | @wills2001 | more sensitive to outliers than the sum of variances |
| Ellipsoid volume | $\frac{\pi^{d/2}}{\Gamma(\frac{d}{2}+1)}\displaystyle\prod_{i}^{d} (\lambda_{i}^{0.5})$ | Volume | @donohue2013 | less sensitive to outliers than the convex hull hypervolume [@diaz2016; @blonder2018] |
| Minimum spanning tree average distance | $\frac{\sum(\text{branch length})}{n}$ | Density | @oksanen2007vegan | similar to the unscaled functional evenness [@villéger2008] |
| Minimum spanning tree distances evenness | $\frac{\sum\text{min}\left(\frac{\text{branch length}}{\sum\text{branch length}}\right)-\frac{1}{n-1}}{1-\frac{1}{n-1}}$ | Density | @villéger2008 | the functional evenness without weighted abundance [FEve; @villéger2008] |
| Average nearest neighbour distance | $min\left(\sqrt{\sum_{i}^{n}{({q}_{i}-p_{i})^2}}\right)\times \frac{1}{n}$ | Density | @foote1990 | the density of pairs of observations in the trait-space |
| Average displacement | $\frac{\sqrt{\sum_{i}^{n}{({k}_{n})^2}}}{\sqrt{\sum_{i}^{n}{({k}_{n}-Centroid_{k})^2}}}$ | Position | This paper | the ratio between the observations' position from their centroid and the centre of the trait-space. A value of 1 indicates that the observations' centroid is the centre of the trait-space |
Table 3: List of metrics with *n* being the number of observations, *d* the total number of dimensions, *k* any specific row in the matrix, *Centroid* being their mean and $\sigma^{2}$ their variance. $\Gamma$ is the Gamma distribution and $\lambda_{i}$ the eigen value of each dimension and ${q}_{i}$ and $p_{i}$ are any pairs of coordinates.

<!-- We selected these `r metric.names()` space occupancy metrics to illustrate how they capture different aspects of space occupancy (but note that this is not an expression of our preference).
The supplementary material 4 contains the same analysis as described below, performed on a total of 25 metrics.
Furthermore, [`moms`](https://tguillerme.shinyapps.io/moms/) allows exploring the effect of many more metrics as well as the customisation of metrics by combining them or using user-designed functions. -->

<!--  -->
<!--  -->
<!--  -->
<!-- COMPARING METRICS -->
<!--  -->
<!--  -->
<!--  -->


## Metric comparisons

We compared the space occupancy metrics correlations across all simulations between each pair of metrics to assess they captured signal [@villéger2008; @laliberté2010].
We used the metrics on the full 13 trait-spaces described above.
We then scaled the results and measured the pairwise Pearson correlation to test whether metrics were capturing a similar signal (high positive correlation), a different signal (correlation close to 0) or an opposite signal (high negative correlations) using the `psych` package [@psych].

<!--  -->
<!--  -->
<!--  -->
<!-- SHIFTING SPACES -->
<!--  -->
<!--  -->
<!--  -->

## Changing space {#changing-spaces}

To measure how the metrics responded to changes within trait-spaces, we removed 50% of observations each time using the following algorithms:

* **Randomly:** by randomly removing 50% of observations (Fig. 2-A).
This reflects a "null" biological model of changes in trait-space: the case when observations are removed regardless of their intrinsic characteristics.
For example, if diversity is reduced by 50% but the trait-space volume remains the same, there is a decoupling between diversity and space occupancy [@ruta2013].
Our selected metrics are expected to not be affected by this change.

* **Limit:** by removing all observations with a distance from the centre of the trait-space lower or greater than a radius $\rho$ (where $\rho$ is chosen such that 50% observations are selected) generating two limit removals: *maximum* and *minimum* (respectively in orange and blue; Fig. 2-B).
This can reflect a strict selection model where observations with trait values below or above a threshold are removed leading to an expansion or a contraction of the trait-space.
Volume metrics are expected to be most affected by this change.

* **Density:** by removing any pairs of point with a distance $D$ from each other where (where $D$ is chosen such that 50% observations are selected) generating two density removals: *high* and *low* (respectively in orange and blue; Fig. 2-C).
This can reflect changes within groups in the trait-space due to ecological factors [e.g. competition can generate niche repulsion - lower density; @grant2006].
Density metrics are expected to be most affected by this change.

* **Position:** by removing points similarly as for **Limit** but using the distance from the furthest point from the centre generating two position removals: *positive* and *negative* (respectively in orange and blue; Fig. 2-D).
This can reflect global changes in trait-space due, for example, to an entire group remaining diverse but occupying a different niche.
Position metrics are expected to be most affected by this change.

The algorithm to select $\rho$ or $D$ is described in greater detail in in the Supplementary material 1.

```{r fig_reduce_space, echo = FALSE, fig.height = 12, fig.width = 8, results = 'hide', fig.cap = paste("Figure 2: different type of space reduction. Each panel displays two groups of 50% of the data points each. Each group (orange and blue) are generated using the following algorithm: A - randomly; B - by limit (maximum and minimum limit); C - by density (high and low); and D - by position (positive and negative). Panel E represents a typical display of the reduction results displayed in Table 5: the dots represent the median space occupancy values across all simulations for each scenario of trait-space change (Table 2), the solid and dashed line respectively the 50% and 95% confidence intervals. Results in grey are the random 50% reduction (panel A). Results in blue and orange represent the opposite scenarios from panels B, C, and D. The displayed value is the probability of overlap (Bhattacharrya Coefficient) between the blue or orange distributions and the grey one.")}

set.seed(42)

## Change colors
defaults$col1 <- "blue"
defaults$col2 <- "orange"

op <- par(mfrow = c(3,2), bty = "n")
## The elements
elements <- 300
## The amount to remove
remove <- 0.5

## Trait space
trait_space <- space.maker(elements, 2, distribution = rnorm)

## Random removal colours
defaults$col1 <- "black"
defaults$col2 <- "grey"

## The randomly removed space
random_rm <- reduce.space(trait_space, type = "random", remove = 0.5)
## Plotting the reduction
plot.space(trait_space, random_rm, main = "A - Random removal", defaults)

## Back to normal colours
defaults$col1 <- "blue"
defaults$col2 <- "orange"

## The limit removal
limit_rm <- reduce.space(trait_space, type = "limit", remove = 0.5)
## Plotting the reduction
plot.space(trait_space, limit_rm, main = "B - Limit", defaults)

## The density removal
density_rm <- reduce.space(trait_space, type = "density", remove = 0.5)
## Plotting the reduction
plot.space(trait_space, density_rm, main = "C - Density", defaults)

## The displacement removal
displace_rm <- reduce.space(trait_space, type = "displacement", remove = 0.5)
## Moving the space to the upper right corner (positive)
plot.space(trait_space, displace_rm, main = "D - Position", defaults)

## Test example
set.seed(42)
colours <- c("grey", "orange", "blue")
par(bty = "n")
## Plot size
plot(NULL, ylim = c(0.8, 3.2), pch = 19, xlim = c(-1,1), xlab = "Centred and scaled space occupancy", ylab = "", xaxt = "n", yaxt = "n", main = "E - Space reduction results example (Table 5)")
## Adding lines
abline(v = 0, lty = 2, col = colours, lwd = 2)
## Adding the x axis
axis(1, at = c(-1, -0.5, 0, 0.5, 1), labels = TRUE, tick = TRUE, col.ticks = "black", col = "black", lwd = 2)
## Adding the values
values <- cbind(rnorm(30, mean = 0, sd = 0.2),
                rnorm(30, mean = -0.75, sd = 0.13),
                rnorm(30, mean = 0.75, sd = 0.2))
quantile_vals <- apply(values, 2, quantile, probs = c(0.025, 0.250, 0.750, 0.975))
centtend_vals <- apply(values, 2, median)

## Loop through the lines
for(column in 1:3) {
    ## Get the x y values
    line_x_vals <- quantile_vals[, column]
    line_y_vals <- rep(column, 2)

    ## Add the lines
    n_cis <- 4
    for(ci in 1:(n_cis/2)) {
        lines(x = line_x_vals[c(ci, n_cis-(ci-1))], y = line_y_vals, lty = (n_cis/2 - ci + 1), lwd = ci * 1.5 * 2, col = colours[column])
    }
}
## Add the points
points(x = centtend_vals, y = 1:ncol(values), pch = 19, col = colours, cex = 1.5 + 2)

bc_1 <- dispRity::bhatt.coeff(values[,2], values[,1])
bc_2 <- dispRity::bhatt.coeff(values[,3], values[,1])

text(x = 0.2, y = 3,  labels = round(bc_1, 3), cex = 1.4)
text(x = 0.2, y = 2.9,  labels = paste0("\n(Probability of overlap between\nthe blue and the grey distributions)"), cex = 0.8)
text(x = -0.2, y = 2,  labels = round(bc_2, 3), cex = 1.4)
text(x = - 0.2, y = 1.9,  labels = paste0("\n(Probability of overlap between\nthe orange and the grey distributions)"), cex = 0.8)

## Some arrows
arrows(x1 = centtend_vals[3], y1 = 2.5,
       x0 = centtend_vals[3], y0 = 2.9,
       col = "black", lwd = 1, length = 0.1, code = 1)
text(labels = "Metric score from the\nremoval displayed in blue above\n(Limit, Density or Position).",
     x = centtend_vals[3]-0.35, y = 2.35, cex = 0.8)

arrows(x1 = centtend_vals[2], y1 = 2.1,
       x0 = centtend_vals[2], y0 = 2.5,
       col = "black", lwd = 1, length = 0.1, code = 2)
text(labels = "Metric score from\nthe removal displayed\nin orange above\n(Limit, Density or Position).",
     x = centtend_vals[2]+0.05, y = 2.75, cex = 0.8)

arrows(x1 = centtend_vals[1]+0.4, y1 = 1.2,
       x0 = centtend_vals[1]+0.05, y0 = 1.05,
       col = "black", lwd = 1, length = 0.1, code = 1)
text(labels = "Metric score from\nthe random removal.",
     x = centtend_vals[1]+0.55, y = 1.3, cex = 0.8)
```

To measure the effect of space reduction, distribution and dimensionality on the metric, we scaled the metric to be relative to the non-reduced space for each dimension distribution or number of dimensions.
We subtracted the observed occupancy with no space reduction to all the occupancy measurements of the reduced spaces and then divided it by the resulting maximum observed occupancy.
Our occupancy metrics where scaled between -1 and 1 with a value of 0 indicating no effect of the space reduction and $>0$ and $<0$ respectively indicating an increase or decrease in the occupancy metric value.
We then measured the probability of overlap of the between the non-random removals (limit, density and position) and the random removals using the Bhattacharrya Coefficient [probability of overlap between two distributions; @bhattacharyya1943].

### Measuring the effect of space and dimensionality on shifting spaces

Distribution differences and the number of dimensions can have an effect on the metric results.
For example, in a normally distributed space, a decrease in density can often lead to an increase in volume.
This is not necessarily true in log-normal spaces or in uniform spaces for certain metrics.<!--  (e.g. the convex hull volume of a lognormal space will be less sensitive to changes in density) -->
Furthermore, high dimensional spaces (>10) are subject to the "curse of multidimensionality" [@cursedimensionality]: data becomes sparser with increasing number of dimensions, such that the probability of two points A and B overlapping in *n* dimensions is the product of the probability of the two points overlapping on each dimensions($\prod_{i}^{d} P(A = B)_{Di}$).
This probability decreases as a product of the number of dimensions.
Therefore, the "curse" can make the interpretation of high dimensional data counter-intuitive.
For example if a group expands in multiple dimensions (i.e. increase in volume), the actual hypervolume can decrease (Fig. 3 and Tables 6, 7).

We measured the effect of space distribution and dimensionality using an ANOVA ($occupancy \sim distribution$ and $occupancy \sim dimensions$) by using all spaces with 50 dimensions and the uniform and normal spaces with equal variance and no correlation with 3, 15, 50, 100 and 150 dimensions (Table 2) for testing respectively the effect of distribution and dimensions.
The results of the ANOVAs (*p*-values) are reported in Table 5 (see supplementary material 3 for the full ANOVA result tables).


<!--  -->
<!--  -->
<!--  -->
<!-- EMPIRICAL EXAMPLES -->
<!--  -->
<!--  -->
<!--  -->

## Empirical examples

We analysed the effect of the different space occupancy metrics on six different empirical studies covering a broad range of fields that employ trait-space analyses (palaeobiology, macroevolution, evo-devo, ecology, etc.).
For each of these studies we generated trait-spaces from the data published with the papers.
We divided each trait-spaces into two biologically-relevant groups and tested whether the metrics differentiated the groups in different ways.
Both the grouping and the questions where based on a simplified version of the topics of these papers (with no intention to re-analyse the data but to be representative of  the diversity of questions in ecology and evolution).
The procedures to generate the data and the groups varies from one study to the other but is detailed and fully reproducible in the supplementary materials 2.


study | field | taxonomic Group | traits (data) | trait-space | size | groups (orange/blue in Table 6) | type of question |
------|-------|-----------------|---------------|-------------|------|--------|------------------|
@beck2014 | Palaeontology | Mammalia | discrete morphological phylogenetic data | Ordination of a distance matrix (PCO) | 106*105 | 52 crown vs. 54 stem | Are crown mammals more disparate than stem mammals?|
@wright2017 | Palaeontology | Crinoidea | discrete morphological phylogenetic data | Ordination of a distance matrix (PCO) | 42*41 | 16 before vs. 23 after | Is there a difference in disparity before and after the Ordovician mass extinction?|
@marcy2016 | Evolution | Rodentia | skull 2D landmark coordinates  | Ordination of a Procrustes Superimposition (PCA) | 454*134 | 225 *Megascapheus* vs. 229 *Thomomys* | Are two genera of gopher morphologically distinct? |
@hopkins2016 | Evolution | Trilobita | 3D landmark coordinates | Ordination of a Procrustes Superimposition (PCA) | 46*46 | 36 adults vs. 10 adults | Are juvenile trilobites a subset of adult ones? |
@jones2015 | Ecology | Plantae | Communities species compositions | Ordination of a Jaccard distance matrix (PCO) | 48*47 | 24 aspens vs. 24 grasslands | Is there a difference in species composition between aspens and grasslands? |
@healy2019 | Ecology | Animalia | Life history traits | Ordination of continuous traits (PCA) | 285*6 | 83 ecthotherms vs. 202 endotherms | Do endotherms have more diversified life history strategies than ectotherms? |
Table 4: details of the six empirical trait-spaces.

For each empirical trait-space we bootstrapped each group 500 times [@disprity] and applied the `r metric.names()` space occupancy metric to each pairs of groups.
<!-- Note that when space occupancy could not be calculated (e.g. due to the "curse of multidimensionality"), we collapsed the metric value to 0 (i.e. no space occupancy was captured). -->
We then compared the means of each groups using the Bhattacharrya Coefficient [@bhattacharyya1943].

<!--  -->
<!--  -->
<!--  -->
<!-- RESULTS SECTION -->
<!--  -->
<!--  -->
<!--  -->








# Results

```{r loading_results, echo = FALSE}
## Loading the results
remove_05 <- load.results("remove_05")
```

```{r running_tests, echo = FALSE}
## Anova function
anova.fun <- function(data) {return(aov(glm(disparity ~ factor, data = data)))}

## Running the tests
all_test <- test.simulation(remove_05, test = anova.fun, scale = TRUE)
all_dim_test <- test.simulation(remove_05, test = anova.fun, scale = TRUE,
                      factors = c("uniform3", "uniform15", "uniform50", "uniform100", "uniform150",
                                  "normal3", "normal15", "normal50", "normal100", "normal150"))
space_test <- test.simulation(remove_05, test = anova.fun, scale = TRUE,
                              factors = c("uniform50", "uniform50c", "normal50", "normal50c",
                                          "random50", "pca_like", "pco_like"))
```

## Metric comparisons 


```{r fig_metric_correlation, echo = FALSE, fig.height = 8, fig.width = 8, results = 'hide', fig.cap = paste("Figure 3: pairwise correlation between the scaled metrics. Numbers on the upper right corner are the Pearson correlations. The red line are linear regressions (with the confidence intervals in grey).")}

## Adding proper names
results_pairwise <- remove_05
names(results_pairwise[[1]]) <- metric_names

## Plotting the pairwise results
pairwise.plot(results_pairwise, scale = TRUE, type = "base", plot = "cor")
```

All the metrics were either positively correlated (Pearson correlation of 0.99 for the average distance from centroid and sum of variance or 0.97 for the average nearest neighbour distance and minimum spanning tree average length; Fig. 3) or somewhat correlated (ranging from 0.66 for the sum of variances and the ellipsoid volume to -0.09 between the average displacement and the average distance from centroid; Fig. 3).
All metrics but the ellipsoid volume were normally (or nearly normally) distributed (Fig. 3).
<!-- This is due to the ellipsoid volume being more sensitive to the curse of multidimensionality (many values close to 0).
 -->
More comparisons between metrics are available in the supplementary materials 4.

## Space shifting

```{r fable_results, fig.show='hide', echo=FALSE, fig.height=3, fig.width=3}
## The metrics names (shortened vector)
name <- metric_names

## Making a list of parameters for each mini plot
plot.param <- list(scaler = 3,
                   bg.col = "black",
                   col = c("grey", "orange", "blue"),
                   quantiles = c(95, 50),
                   cent.tend = median,
                   pch = 19,
                   metric.max = length(metrics_list),
                   cex = 2)

## Looping through each mini plot for every metric
for(metric in 1:length(metrics_list)) {
    generate.fable.plot(data = remove_05, metric = metric, what = "limits", plot.param = plot.param, overlap = TRUE)
    generate.fable.plot(data = remove_05, metric = metric, what = "densit", plot.param = plot.param, overlap = TRUE)
    generate.fable.plot(data = remove_05, metric = metric, what = "displa", plot.param = plot.param, overlap = TRUE)
}

```

```{r, echo = FALSE, eval = FALSE}
## Function for printing the table in the R console
print.fable <- function(n_metrics, byrow, ncol, test) {
  ## Make the plot.id table 
  ids <- matrix(1:(n_metrics*ncol), ncol = ncol, byrow = byrow)

  for(one_metric in 1:n_metrics) {
    ## Print all the rows one by one
    text <- c(paste0("`r name[", one_metric, "]`"), paste0("`r plot.id(", ids[one_metric, ], ")`"))
    ## Add some tests?
    if(test) {
      text <- c(text, paste0("`r s.test(", one_metric, ", \"s\")`"), paste0("`r s.test(", one_metric, ", \"r\")`"))
    }
    ## Print the line
    cat(paste(text, collapse = " | "))
    cat("|\n")
  }
}
## Getting the fable to copy paste under the table header below.
print.fable(length(metrics_list), byrow = TRUE, ncol = 3, test = TRUE)
```

Metric      | Volume change  | Density change | Position change | Distribution effect | Dimensions effect |
:-----------|----------------|-----------------|----------------|---------------------|-------------------|
`r name[1]` | `r plot.id(1)` | `r plot.id(2)` | `r plot.id(3)` | `r s.test(1, "s")` | `r s.test(1, "r")`|
`r name[2]` | `r plot.id(4)` | `r plot.id(5)` | `r plot.id(6)` | `r s.test(2, "s")` | `r s.test(2, "r")`|
`r name[3]` | `r plot.id(7)` | `r plot.id(8)` | `r plot.id(9)` | `r s.test(3, "s")` | `r s.test(3, "r")`|
`r name[4]` | `r plot.id(10)` | `r plot.id(11)` | `r plot.id(12)` | `r s.test(4, "s")` | `r s.test(4, "r")`|
`r name[5]` | `r plot.id(13)` | `r plot.id(14)` | `r plot.id(15)` | `r s.test(5, "s")` | `r s.test(5, "r")`|
`r name[6]` | `r plot.id(16)` | `r plot.id(17)` | `r plot.id(18)` | `r s.test(6, "s")` | `r s.test(6, "r")`|
`r name[7]` | `r plot.id(19)` | `r plot.id(20)` | `r plot.id(21)` | `r s.test(7, "s")` | `r s.test(7, "r")`|
`r name[8]` | `r plot.id(22)` | `r plot.id(23)` | `r plot.id(24)` | `r s.test(8, "s")` | `r s.test(8, "r")`|
Table 5: Results of the effect of space reduction, space dimension distributions and dimensions number of the different space occupancy metrics. See Fig. 2 for interpretation of the figures. _p_-values for distribution effect and dimensions effect represents respectively the effect of the ANOVAs space occupancy ~ distributions and space occupancy ~ dimensions (0 '\*\*\*' 0.001 '\*\*' 0.01 '\*' 0.05 '.' 0.1 '' 1).

As expected, some different metrics capture different aspects of space occupancy.
However, it can be hard to predict the behaviour of each metric when 50% of the observations are removed.
We observe a clear decrease in median metric in less than a third of the space reductions (10/36).

In terms of change in volume, only the average distance from centroid and the sum of variances seem to capture a clear change in both directions.
However, the increase in volume does not correspond to an *actual* increase in volume in the trait-space (i.e. the volume from the blue observations in Fig. 2-B is equivalent to the one in Fig. 2-A).
In terms of change in density, only the minimum spanning tree average distance and the average nearest neighbour distance seem to capture a clear change in both directions.
In terms of change in position, only the average displacement metric seems to capture a change a clear change in direction (albeit not in both directions).
This is not surprising, since the notion of positions becomes more and more complex to appreciate as dimensionality increases (i.e. beyond left/right, up/down and front/back).

## Empirical example

```{r test_empirical, echo = FALSE}
## Loading the results
empirical_results <- load.results("empirical_results")

## Testing the differences for each distributions
bhatt.coeff.safe <- function(x, y, tol = 1e-16, ...) {
  if(all(x < tol) | all(y < tol)) {
    bhatt.coeff(1, 0)
  } else {
    bhatt.coeff(x, y, ...)
  }
} 
disparity_test <- lapply(empirical_results, lapply, test.dispRity, test = bhatt.coeff.safe)
```

```{r fable_results_empirical, fig.show='hide', echo=FALSE, fig.height=3, fig.width=3}
## Plotting parameters
plot.param <- list(cex = 2,
                   col = c("#F7B27E", "#BFE4E3"),
                   border = c("#F65205", "#3E9CBA"),
                   na.cex = 3,
                   scaler = 3)

## Looping through each mini plot for every metric
data_names <- c("Beck and Lee 2014", "Wright 2017", "Marcy et al. 2016",
                "Hopkins and Pearson 2016", "Jones et al. 2015", "Healy et al. 2019")

for(dataset in 1:length(data_names)){
    for(metric in 1:length(metrics_list)){
        ## Plotting the results
        generate.fable.empirical(data = empirical_results[[dataset]][[metric]],
                                 test = disparity_test[[dataset]][[metric]],
                                 precision = 1e-5, plot.param, dataset = dataset)
    }
}
```

```{r change_plotid_chain, echo = FALSE, eval = TRUE}
## Changing defaults
body(plot.id)[[3]] <- substitute(chain <- "fable_results_empirical")
```

```{r, echo = FALSE, eval = FALSE}
print.fable(length(metrics_list), byrow = FALSE, ncol = 6, test = FALSE)
```

Metric     | Beck and Lee 2014  | Wright 2017 | Marcy et al. 2016 | Hopkins and Pearson 2016 | Jones et al. 2015 | Healy et al. 2019  |
:-----------|----------------|-----------------|------------------|----------------|------------------|----------------|
`r name[1]` | `r plot.id(1)` | `r plot.id(9)` | `r plot.id(17)` | `r plot.id(25)` | `r plot.id(33)` | `r plot.id(41)`|
`r name[2]` | `r plot.id(2)` | `r plot.id(10)` | `r plot.id(18)` | `r plot.id(26)` | `r plot.id(34)` | `r plot.id(42)`|
`r name[3]` | `r plot.id(3)` | `r plot.id(11)` | `r plot.id(19)` | `r plot.id(27)` | `r plot.id(35)` | `r plot.id(43)`|
`r name[4]` | `r plot.id(4)` | `r plot.id(12)` | `r plot.id(20)` | `r plot.id(28)` | `r plot.id(36)` | `r plot.id(44)`|
`r name[5]` | `r plot.id(5)` | `r plot.id(13)` | `r plot.id(21)` | `r plot.id(29)` | `r plot.id(37)` | `r plot.id(45)`|
`r name[6]` | `r plot.id(6)` | `r plot.id(14)` | `r plot.id(22)` | `r plot.id(30)` | `r plot.id(38)` | `r plot.id(46)`|
`r name[7]` | `r plot.id(7)` | `r plot.id(15)` | `r plot.id(23)` | `r plot.id(31)` | `r plot.id(39)` | `r plot.id(47)`|
`r name[8]` | `r plot.id(8)` | `r plot.id(16)` | `r plot.id(24)` | `r plot.id(32)` | `r plot.id(40)` | `r plot.id(48)`|
Table 6: Comparisons of pairs of groups in different empirical trait-spaces. NAs are used for cases where space occupancy could not be measured due to the curse of multidimensionality. The displayed values are the probability of overlap between both groups (Bhattacharrya Coefficient).

Similarly as for the simulated results, the empirical ones indicate that there is no perfect one-size-fit all metric.
For all `r metric.names()` metrics (expect the ellipsoid volume) we see either one group or the other having a bigger mean than the other and no consistent case where a group has a bigger mean than the other for all the metrics.
For example, in the @beck2014's dataset, there is a clear non-overlap in space occupancy volume using the average distance from centroid or the sum of variances (overlaps of respectively 0.175 and 0.159) but no overlap when measuring the volume using the sum of ranges (0.966).
However, for the @hopkins2016's dataset, this pattern is reversed (no clear differences for the average distance from centroid or the sum of variances - 0.701 and 0.865 respectively) but a clear difference for the sum of ranges (0).
Furthermore, for each dataset, the absolute differences between each groups is not consistent depending on the metrics.
For example, in @hopkins2016's dataset, the orange group's mean is clearly higher than the blue one when measuring the sum of ranges (0) and the inverse is true when measuring the average displacement (0).


<!--  -->
<!--  -->
<!--  -->
<!-- DISCUSSION SECTION -->
<!--  -->
<!--  -->
<!--  -->








# Discussion

Here we tested 25 metrics of trait-space occupancy on simulated and empirical datasets to assess how each metric captures changes in trait-space volume, density and position.
Our results show that the correlation between metrics can vary both within and between metric categories (Fig. 3), highlighting the importance of understanding the metric classification for the interpretation of results.
Furthermore, our simulations show that different metrics capture different types of trait-space change (Table 5), meaning that the use of multiple metrics is important for comprehensive interpretation of trait-space occupancy.
We also show that the choice of metric impacts the interpretation of group differences in empirical datasets (Table 6), again emphasizing that metric choice has a real impact on the interpretation of specific biological questions


#### Metrics comparisons

Metrics within the same category of trait-space occupancy (volume, density or position) do not have the same level of correlation with each other.
For example, the average distance from centroid (volume) is highly correlated to the sum of variances (volume - correlation of 0.99) and somewhat correlated with the minimum spanning tree average distance (density - correlation of 0.66) but poorly with the ellipsoid volume (volume - correlation of 0.17) and the minimum spanning tree distances evenness (density - correlation of -0.05).
Furthermore, the fact that we have such a range of correlations for normal distributions suggests that each metric can capture different summaries of space occupancy ranging from obvious differences (for metrics not strongly correlated) to subtle ones (for metrics strongly correlated).

<!-- Analysing the properties of metrics in a trait-space prior to using them to answer macroevolutionary or ecological questions can bring valuable insights into what aspect of space occupancy they are capturing.
For example, if some space occupancy metrics captures the same pattern using the sum of variances and the sum of ranges, it is possible that the trait-space have really similar properties (i.e. space with equal normal dimensions).
 -->

#### Space shifting

Most metrics capture no changes in space occupancy for the "null" (random) space reduction (in grey in Table 5).
This is a desirable behaviour for space occupancy metrics since it will likely avoid false positive errors in empirical studies that estimate biological processes from space occupancy patterns [e.g. competition @brusatte2008, convergence @marcy2016, life history traits @healy2019].
However, the average nearest neighbour distance and the sum of ranges have a respectively positive and negative "null" median.
This is not especially a bad property but it should be kept in mind that even random processes can increase or decrease these metric value.

Regarding the changes in volume, the sum of variances and the average distance from centroid are good descriptors (Table 5).
However, as illustrated in the 2D examples in Fig. 2-B only the blue change results (maximum limit - Table 5) should not result in a direct change in volume since the trait-space is merely "hollowed" out.
That said, "hollowing" is more hard to conceptualise in many dimensions and the metrics can still be interpreted for comparing groups (orange has a smaller volume than blue).

Regarding changes in density, the average nearest neigbhour distance and the minimum spanning tree average distance consistently detect changes in density with more precision for low density trait-spaces (in blue in Table 5).
However, we can observe some degree of correlation between the changes in density and the changes in volume for most metric picking either signal.
This could be due to the use of normally distributed spaces where a change in density often leads to a change in volume.
This is not necessary the case with empirical data.

Regarding the changes in position of the trait-space, all but the average displacement metric seems to not be able to distinguish between a random change and a displacement of the trait-space (Table 5).
Furthermore, the average displacement metric does not distinguish between and positive or a negative displacement of the trait-space: this might be due to the inherent complexity of *position* in a multidimensional trait-space.

<!-- Regarding the effect of dimensions and trait-space distribution, metrics seems to be either affected by neither of these factors or by both (Table 5).
Again, this should not preclude using metrics that are sensitive to trait-spaces' dimensions and distributions [e.g. the ellispoid volume is a good volume descriptor up until a moderate number of dimensions; @jackson2011; @donohue2013] but should be kept in mind.
 -->

#### Empirical examples

Although most differences are fairly consistent within each dataset with one group having a higher space occupancy score than the other for multiple metrics, this difference can be more or less pronounced within each dataset (ranging from no to nearly full overlap - BC $\in(0;0.995)$) and sometimes even reversed.
This indicates that opposite conclusions can be drawn from a dataset depending on which space occupancy metric is considered.
For example, in @wright2017, crinoids after the Ordovician mass extinction have a higher median metric value for all metrics but for the average displacement.
These differences depending on the metrics are also more pronounced in the empirical datasets where the observations per group are unequal [@hopkins2016; @healy2019].
<!-- Finally, it is worth noting that the ellispoid volume only picks up accurate differences between groups in the @healy2019 dataset which is yet another illustration of the curse of multidimensionality: the @healy2019 dataset has only 6 dimensions compared to all the other ones having more than 41 dimensions [and the @marcy2016 dataset having 136 dimensions for which the ellipsoid volume can't be calculated; Table 6; @cursedimensionality].
 -->
### Caveats

While our simulations have been useful to illustrate the behavior of diverse space occupancy metrics, they have several caveats.
First, the simulated observations in the trait-spaces are independent.
This is not the case in biology where observations can be spatially [@jones2015] or phylogenetically correlated [e.g. @beck2014].
Second, the algorithm used to reduce the trait-spaces might not always accurately empirical changes.
This might favour some specific metrics over others, in particular for the changes in density that modifies the nearest neighbour density rather than changing the global density.
This algorithmic choice was made in order to not confound changes in density along with changes in volume.
However, the results presented here probably capture the general behaviour of each metric since results are consistent between the simulated and empirical analysis.
Furthermore, [`moms`](https://tguillerme.shinyapps.io/moms/) allows to test the caveats mentioned above by uploading empirical trait-space.

### Suggestions

We insist that no metric is better than the next one and that researchers should use the most appropriate metrics based on the metric and trait-space properties as well as their specific biological question.
However, following the findings of this study we suggest several points:

First, we suggest using multiple metrics to tackle different aspects of the trait-space. 
This follows the same logical thinking that the mean might not be sufficient to describe a distribution (e.g. the variance might be good additional descriptor).
Although using multiple metrics is not uncommon in macroevolutionary studies [e.g. @halliday2015] or in ecology [@mammola2019], they often do not cover contrasted aspects of the trait-space.

Second, we suggest selecting the metrics that best help answering the biological question a hand.
If one studies an adaptive radiation in a group of organisms, it is worth thinking what would be the expected null model: would the group's volume increase (radiation in all directions), would it increase in density (niche specialisation) or would it shift in position (radiation into a new set of niches)?

Third, we suggest to not name metrics as the biological aspect they are describing (e.g. "disparity" or "functional dispersion") but rather what they are measuring (e.g. "sum of dimensions variance").
We believe this will allow both a clearer understanding of what *is* measured and a better communication between ecology and evolution research where metrics can be similar but have different names (Fig. 3).

Multidimensional analyses have been acknowledged to be an essential tool-kit modern biology but can often be counter-intuitive [@cursedimensionality].
It is thus crucial to accurately describe patterns in multidimensional trait-spaces to be able to link them to biological processes.
When summarising trait-spaces, it is important to remember that a pattern captured by a specific space occupancy metric is often dependent on the properties of the trait-space and of the particular biological question of interest.
We believe that having a clearer understanding of both the properties of the trait-space and the associated space occupancy metrics (e.g. using [`moms`](https://tguillerme.shinyapps.io/moms/)) as well as using novel space occupancy metrics to answer specific questions will be of great use to study biological processes in a multidimensional world.


# Acknowledgements

We thank Natalie Jones and Kevin Healy for helping with the empirical ecological datasets.
We acknowledge funding from the Australian Research Council DP170103227 and FT180100634 awarded to VW.

# Authors contributions

TG, MNP, AEM and VW designed the project.
TG and AEM collected the empirical dataset.
TG ran the analyses and designed the software.
TG, MNP, AEM and VW wrote the manuscript.

# Data Availability, repeatability and reproducibility

The raw empirical data is available from the original papers [@beck2014; @jones2015, @marcy2016; @hopkins2016; @wright2017; @healy2019].
The subsets of the empirical data used in this analysis are available on figshare 
[DOI: 10.6084/m9.figshare.9943181.v1](https://doi.org/10.6084/m9.figshare.9943181.v1).
The modified empirical data are available in the package accompanying this manuscript (`data(moms::demo_data)`).
This manuscript (including the figures, tables and supplementary material) is repeatable and reproducible by compiling the vignette of the [GitHub `moms R` package](https://github/TGuillerme/moms).
The code for the `moms` shiny app is available from the [GitHub `moms R` package](https://github/TGuillerme/moms).

# References
