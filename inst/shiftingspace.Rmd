---
title: "Shifting spaces: how to summarise multidimensional spaces occupancy? "
author: "Thomas Guillerme, Mark Puttick, Ariel Marcy, Vera Weisbecker"
bibliography: references.bib
date: "`r Sys.Date()`"
output:
  html_document:
    fig_width: 8
    fig_height: 8
---

<!-- When toggling to html, toggle snippet `compilation_html` below to eval = TRUE -->

<!-- To build the line numbered version (for submission) use the following yaml header snippet
output:
  pdf_document:
    fig_width: 8
    fig_height: 8
    keep_tex: true
  self_contained: false


output:
  html_document:
    fig_width: 8
    fig_height: 8
---
and edit the save .tex file to add the following

\usepackage{lineno} %in the package header

\linespread{2} %in the document header

\modulolinenumbers[1] % just after the \begin{document} tag
\linenumbers
 -->


```{r header, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}
## Repeatability note:
## This whole paper is entirely reproducible and compiles as a single document. The data, figures
## and tables are all generated through the code snippets in this file. Note that the first time
## that this paper is compiled, it will generate the data which will take substantial time
## as the shiftingspace_supplementary.Rmd file completion takes ~10 minutes. Subsequent compilations
## will be much faster!

## Loading the packages
if(!require(devtools)) install.packages("devtools")
if(!require(knitr)) install.packages("knitr"); library(knitr)
if(!require(rmarkdown)) install.packages("rmarkdown"); library(rmarkdown)
if(!require(ape)) install.packages("ape"); library(ape)
if(!require(dispRity)) install.packages("dispRity"); library(dispRity)
if(packageVersion("dispRity") < "1.2.4") {
    ## dispRity must be above v1.2.3
    devtools::install_github("TGuillerme/dispRity"); library(dispRity)
}
if(!require(moms)) devtools::install_github("TGuillerme/moms"); library(moms)

## Setting the datapath
DATA_PATH <- "../data/processed/"

## Create data directory
if(!dir.exists(DATA_PATH)) {
    dir.create(path = DATA_PATH, showWarnings = FALSE)
}

## Setting the default parameters for the space plots
defaults <- list(pch = 20,
                 xlim = c(-3, 3),
                 ylim = c(-3, 3),
                 col1 = "grey",
                 col2 = "black",
                 xlab = "Trait",
                 ylab = "Trait",
                 cex = 1)
## Generating the default palette
default.palette <- function(n) {
    hues <- seq(15, 375, length = n + 1)
    grDevices::hcl(h <- hues, l = 65, c = 100)[1:n]
}

## Checking whether the data exists
if(!all(c("remove_05.Rda") %in% list.files(DATA_PATH))) {
    ## Run The supplementary material (simulation) ~ 30 minutes
    rmarkdown::render("shiftingspace_supplementary_simulation.Rmd", "html_document")    
}
if(!all(c("empirical_results.Rda") %in% list.files(DATA_PATH))) {
    ## Run The supplementary material ~ 15 minutes
    rmarkdown::render("shiftingspace_supplementary_empirical.Rmd", "html_document")
}
```

```{r table_counter, echo = FALSE}
## Table and figure counter
element.counter <- function(name, all_names, increment = FALSE) {
    if(increment) {
        ## Numbering a table or a figure
        all_names <- c(all_names[[2]], name)
        ## Print the table number
        # length(all_names)
        return(list(print = length(all_names), list = all_names))
    } else {
        ## Printing the number of the table of figure
        # cat(which(all_names %in% name))
        return(list(print = which(all_names[[2]] %in% name), list = all_names[[2]]))
    }
}
## Initialising the elements counters
tables <- list(print = NULL, list = character())
figures <- list(print = NULL, list = character())

## Function wrappers
table <- function(name, add = FALSE, all_names = tables) {
    return(element.counter(name, all_names, increment = add))
}
figure <- function(name, add = FALSE, all_names = figures) {
    return(element.counter(name, all_names, increment = add))
}

```


```{r compilation_html, echo = FALSE, eval = TRUE}
## Changing defaults
body(plot.id)[[2]] <- substitute(type <- ".png")
```

# Abstract



<!-- Change order of things from 1)review/simulations 2)moms (as the last § of the intro) -->

Multidimensional analysis of traits are an increasingly common tool-kit in ecology and evolution.
Such analysis are based on multidimensional datasets in which each dimension represents an original or transformed trait.
Thus, analyses summarise all observed and potential trait combinations in a multidimensional trait-space (e.g.
a morphospace or an ecospace).
Taxa will typically only occupy a subset of this space, so researchers apply one or more metrics to quantify the way in which organisms "inhabit" that trait-space.
By using these metrics, researchers have investigated how trait-space occupancy changes through time, in relation to other groups of organisms, and in response to global environmental changes, such as global warming events or mass extinctions.
<!-- AM: Perhaps add a "for example" somewhere as this doesn't seem to be an exhaustive list (e.g. the trilobite paper we use looks more at change thru developmental events).  -->

Although a few space (well defined) occupancy metrics are used in ecology and evolution, we lack a general description of the majority of those metrics, especially in macroevolution.
In macroevolutionary studies these metrics are used as proxies for the concept of disparity.
Therefore the mathematical and biological meaning of such trait-space occupancy or disparity metrics can be vague.
This has consequences when interpreting changes in trait-space occupancy and linking them to biological phenomena.
For example, does a reduction in volume in trait-space correspond to episodes of extinction or changes in traits distribution? Does an overlap in trait-space mean overlapping niches?

Here we propose a user-friendly tool to Measure Occupancy in Multidimensional Spaces (moms) that allows visualisation of numerical changes of diverse metrics following space transformations (e.g. contraction, displacement, etc.).
It also allows the visualization of space changes through 2D projections.
This tool allows researchers to explore and visualise the properties of disparity metrics for their data under various parameters.
Furthermore, we propose a thorough review 
<!-- VW: This sounds too tacked on while it is a really important topic in its own right.  -->
of the behaviour of four common and two new metrics regarding various spatial properties (i.e. distribution, transformation, dimensionality).
As expected, we found that certain metrics are more appropriate than others in different disparity analyses.




# Introduction

Groups of species and environments share specific, easily recognisable, correlated characteristics (e.g. guilds or biomes) of many kinds (e.g. phenotypic, physiological, phylogenetic, behavioural). 
Organisms or environments should therefore be studied as a set of traits rather than some specific traits in isolation [e.g. @donohue2013; @hopkins2017].
increased computational power and statistical methods, as well as by the implementation of statistical methods in `R` packages [@oksanen2007vegan; @adams2013geomorph; @momocs; @blonder2018; @disprity] has facilitated a recent explosion of multiple traits studies approaches.

Ordination techniques (or dimensionality reduction) are a popular way to analyse sets of traits in concert and create a trait-space of the study system [see @legendre2012 for a summary].
Such trait-space approach has been successfully used across many sub-disciplines in biology to either explore properties of the data or test hypothesis.
For example, in palaeobiology, such trait-spaces can be used to look how groups of species change in terms of shared characteristics through time [e.g. @wright2017];
in ecology, it can be used to compare two populations and see whether their overlap can be related to ecological processes such as competition [e.g. @jones2015].
However, different fields use a different set of terms and approaches for such trait-space approaches (Table 1).
In macroevolution, for example, such trait-spaces are commonly referred to as "morphospaces" [with the whole procedure often being often called "disparity analysis"; e.g. @adams2013geomorph; @marcy2016; @wright2017], while in ecology, such trait-spaces can be called "functional spaces" [and "dissimilarity analysis"; e.g. @diaz2016; @mammola2019].
Nonetheless, they are the same mathematical objects: matrices with columns representing a trait (or a transformation thereof) and rows representing observations [taxon, field site, etc.; @disprity].

In mathematics | In ecology | In macroevolution | In this paper
---------------|------------|-------------------|---------------
Matrix ($n \times d$) | Function-space, Eco-space, etc. | Morphospace, traitspace, etc. | trait-space
Rows (*n*) | Taxa, field sites, environments, etc. | Taxa, specimen, populations, etc. | observations
Columns (*d*) | Traits, Ordination scores, distances, etc. | Traits, Ordination scores, distances, etc. | dimensions
Matrix subset ($m \times d$; $m \leq n$) | Treatments, phylogenetic group (clade), etc. | Clades, geological stratum, etc. | group
Statistic | Dissimilarity index or metric, hypervolume | Disparity metric or index | space occupancy metric
Multidimensional analysis | Dissimilarity analysis, trait analysis, etc. | Disparity analysis, disparity-through-time, etc. | multidimensional analysis
Table 1@@@: terms and equivalence between mathematics, ecology and macroevolution.

Ecologists and evolutionary biologists are also using trait-spaces for similar reasons.
Across many sub-disciplines they will look at how their observations occupy the trait-space, often with respect to the same fundamental questions: are two groups overlapping in the trait-space?
Are some regions of the trait-space not occupied?
Or how do specific factors influence the occupancy of the trait-space?
This is achieved in various ways such as using disparity metrics (or indices) in macroevolution [@wills2001; @hopkins2017; @disprity] or comparing hypervolumes in ecology [@donohue2013; @diaz2016; @blonder2018; @mammola2019].
Although these space occupancy metrics are common in ecology and evolution, surprisingly little work has been published on their behaviour [but see @ciampaglio2001; @villéger2008; @mammola2019].

Different space occupancy metrics capture different aspects of the trait-space [ciampaglio2001; @villéger2008; @mammola2019].
Although this does not come as a surprising property this has been rarely acknowledged to our knowledge.
First, space occupancy metrics are often named as the biological aspect they are describing (e.g. "disparity" or "functional dispersion") rather than what they are measuring (e.g. the sum of dimensions variance, etc.) which sometimes obscures the differences or similarities in space occupancy metrics between studies in both ecology and evolution.
Second, in many studies in ecology and evolution, authors have focused on measuring the volume of the trait-space [or a function thereof; e.g. ellipsoid volume @donohue2013; hypervolume @diaz2016; product of variance @wright2017; Procrustes variance @marcy2016] yet this only represents a single aspects of multidimensional occupancy that excludes other aspects that can be of interest [e.g. the density @geiger2008; the position @wills2001; @ciampaglio2001; or dissimilarity between groups @oksanen2007vegan; @close2015].
For example, the volume occupied by a group of taxa in the trait-space might remain constant while it's position changes.
Measuring the volume can miss this information that might be of interest to biologists (e.g. a group of species maintains the same diversity of traits while also shifting towards a new ecological niche).
This lack of diversity in multidimensional occupancy metrics may restrain the potential of multidimensional analysis [@villéger2008].

Here we propose a broad classification of space occupancy metrics as used across ecology [@villéger2008] and evolution [@wills2001] and analyse their power to detect changes in multidimensional space occupancy in empirical and simulated data.
We propose a review of each broad type of space occupancy metrics and a unified terminology aiming to foster easier communication between ecology and evolution.
Unsurprisingly, we found that there is no one-size-fits-all metric and that they are often dependent on the characteristics of the space and the question at hand.
However, a better understanding of the different metrics analysed here can help understanding their "null" behavior (i.e. how does occupancy change with random/non-random changes to the trait-space).
Furthermore, because there can potentially be as many metrics as there are trait-spaces and studies, it would be a daunting task to propose clear generalities to space occupancy metrics behavior.
Therefore, we propose a user friendly tool allowing researchers to design, experiment and visual their own space occupancy metric tailored for their specific project.

## Space occupancy metrics

For the purposes of this paper, we will call trait-spaces any matrix where rows are observations and columns are traits.
These traits can widely vary in number and types.
For example, traits could be discrete observations on an organism [e.g. presence of absence of a bone; @beck2014; @wright2017], continuous ones [e.g. leaf area; @diaz2016] or more sophisticated continuous ones [e.g. landmark position; @marcy2016].
Traits can also be relative observations such as community composition [e.g. @jones2015] or even some distance between observations [e.g. @close2015].
However, regardless of the methodology used to build a trait-space, three main broad occupancy metrics can be measured to investigate how observations are distributed in the trait-space: the volume which will approximate the amount of space occupied, the density which will approximate the distribution in space and the position which will approximate the location in space [Fig. 1@@@; @villéger2008].
Of course any combination of these three aspects is always possible.

```{r fig_metrics_types, echo = FALSE, fig.height = 3, fig.width = 9, results = 'hide', fig.cap = paste("Figure 1: different type of information captured by disparity metrics. A - Volume (e.g. sum of ranges); B - Density (e.g. average squared pairwise distances); C - Position (e.g. median distance from centroid).") }

set.seed(11)
## Plot space function (utility shortcut)
## The elements
elements <- 10

## Trait space
trait_space <- space.maker(elements, 2, distribution = rnorm)

## Graphical parameters
op <- par(mfrow = c(1,3), bty = "n")

## The volume
plot(trait_space, pch = defaults$pch, main = "A - Volume", xlab = "Trait 1", ylab = "Trait 2")
## The range lines
lines(x = range(trait_space[,1]), y = rep(mean(trait_space[,2]), 2), col = defaults$col1)
lines(x = rep(mean(trait_space[,1]), 2), y = range(trait_space[,2]), col = defaults$col1)

## The density
plot(trait_space, pch = defaults$pch, main = "B - Density", xlab = "Trait 1", ylab = "")
## Plotting the pairwise lines
pair.line <- function(line, trait_space, defaults) {
    lines(x = trait_space[line,1], y = trait_space[line,2], col = defaults$col1)
}
apply(combn(1:elements, 2), 2, pair.line, trait_space, defaults)
points(trait_space, pch = defaults$pch)

## The position
plot(trait_space, pch = defaults$pch, main = "C - Position", xlab = "Trait 1", ylab = "")
## Plotting the center of the space
points(0,0, pch = 13, cex = 2)
arrows(x0 = 0, y0 = 0, x1 = trait_space[,1], y1 = trait_space[,2], code = 0, col = defaults$col1)
points(trait_space, pch = defaults$pch)

par(op)
```

#### 1. The volume

Volume metrics measure the spread of a group in the trait-space.
They can be interpreted as the amount of the trait-space that is occupied by observations.
Typically, larger values for such metrics indicate the presence of more extreme trait combinations in the sample.
For example, if group A has a bigger volume than group B, the observations in group A achieve more extreme trait combinations than in group B.
This type of metric is widely used in both ecology [the hypervolume; @blonder2018; for example to compare group's niche overlap @mammola2019] and in evolution [the sum or product of ranges or variances @wills2001; @ciampaglio2001 or the Procrustes variance @adams2013geomorph].
<!-- In general, such metrics are a variation of the hypercube volume.-->

Although volume metrics are a highly suitable indicator for comparing a group's trait space occupancy, it is limited to comparing the range of extreme trait-combinations between groups.
Typically, volume metrics do not take into account the spread of the observations within a group.
In other words, they can make it difficult to determine whether all the observations are on the edge of the volume or whether the volume is simply driven by small number of extreme observations.
<!-- This "outlier bias" has been acknowledged in palaeoecology, for example for the product of ranges metric (the exact size of the hypercube) which is highly sensitive to outliers [@Butler2012]; or in ecology with the use of convex-hypervolumes [@jackson2011].
However, this "outlier bias" issue can be easily alleviated by using lower confidence intervals [e.g. by only at 95% of the data; @jackson2011 or by using the variance instead of the range; @ciampaglio2001]. 
 -->
@@@ TODO @@@
Popular because often people look the "spread" of dissimilarities between observations:
for example, does group A achieve more trait combinations (higher dissimilarities/disparity) than group B?
<!-- AM: What does this mean? + Short paragraph about what questions are often/best tested with volume metrics? And/Or an example of what is missed if this is the only metric used? (same for density & position to reinforce main point of needing several) -->


#### 2. The density

Density metrics measure the distribution of a group in the trait-space.
They can be interpreted as an indication of the distribution of the observations *within* a group in the trait-space (i.e. "packedness": the higher the density, the more packed the observations).
For example, if group A is more dense than group B, observations in group A tend to be more similar between each other relatively than within group B.
Although density is an aspect of trait-space occupancy is measured less often than the volume, it is still used in both evolution [e.g. the average pairwise distance; @geiger2008] and in ecology [e.g. the minimum spanning tree length; @oksanen2007vegan].

Despite their relatively rare application, density metrics could be used more often in concert with a volume metric to investigate finer hypotheses.
For example, if group A has a greater volume than group B but both have the same density, similar mechanisms could be driving both groups' trait-space occupancy (e.g. a Brownian motion) but maybe group A is an older species and has had more time to evolve more extreme trait combinations.
<!-- VW: Good example but needs rewriting, I can do it but you said not to get too stuck into the wording. -->

#### 3. The position


Position metrics measure where a group lies in trait-space.
They can be interpreted as an indication of where a group lies in the trait-space either relative to the space itself or relative to another group.
For example, if group A has a different position than group B, observations in group A will have a different trait-combination than group B.

Position metrics may be harder to interpret in multidimensional spaces (i.e. beyond left/right and above/below) and are hence less often used.
However, when thinking about unidimensional data (one trait), this metric is obvious: for example, two groups A or B could have the same variance (i.e. "volume" or spread) with the same number of observations (i.e. the same density) but could have a totally different mean and thus be in different positions.
Although these metrics are rarer in macroevolution (to our knowledge), they have been used in ecology to compare the position of two groups relatively to each other [@mammola2019].




## No metric to rule them all: benefits of considering multiple metrics

The use of multiple metrics to assess traitspace occupancy has the benefit of providing a more detailed characterization of occupancy changes.
For example, if the question of interest is, say, to look at how trait-space occupancy changes in response to mass extinction, using a single metric to describe one aspect of occupancy (usually the volume) can miss part of the picture.
For example, when looking at the effect of mass extinction on trait-space occupancy, a change in volume (or the absence thereof) can be decoupled from a change in position or density of the observations trait-space.
The Cretaceous-Palaeogene extinction (66 million years ago - Mya) has been linked to an increase in volume of the mammalian trait-space [the mark of an adaptive radiation; @halliday2015] but more specific questions can be answered by looking at other aspects of trait-occupancy: does the radiation expands on previously existing morphologies [elaboration, increase in density; @endler2005] or does it explore entire new regions of the trait-space [innovation, change in position; @endler2005]?
Similarly, in ecology, if two groups occupy the same volume in the trait-space, it can be interesting to look at differences in density within these two hypothetical groups: different selection pressure can lead to different density within equal volume groups.


Such examples can be found throughout the literature in both evolution and ecology on different aspects of trait-space occupancy [e.g. @close2015; @diaz2016].
Figure 2@@@ illustrates this problem on a 2D trait space with eight hypothetical observation where the three aspects (volume, density and position) can change in concert or independently.
This illustrates how using only one specific space occupancy metric (e.g. the volume) will fail to capture changes in the trait-spaces C, D, and I.
<!-- VW: Hmm. Does there even need to be this figure? I mean, isn't it obvious? Or is it obvious but no one has thought of it? -->


<!-- Figure 2: Illustration how three different volume (Vol. - Product of ranges), density (Den. - Average nearest neighbour distance) and position (Pos. - Average displacement) metrics capture different occupancy aspects in this simplified trait-space. The numbers displayed are the values of the trait-space occupancy metrics. -->
<!-- VW: The caption probably needs to be a little more detailed. -->

```{r fig_metric_captures, echo = FALSE, fig.height = 4, fig.width = 8, results = 'hide', fig.cap = paste("Figure 2: Illustration how three different volume (Vol. - Product of ranges), density (Den. - Average nearest neighbour distance) and position (Pos. - Average displacement) metrics capture different occupancy aspects in this simplified trait-space.") }

## Making the volume/density/position space
vdp_space <- moms::vdp.make()

## Measuring disparity
vdp_disp <- moms::vdp.dispRity(vdp_space,
                         volume = c(prod, ranges),
                         density = c(mean, neighbours),
                         position = c(mean, displacements))

## Checking the table of volume changes
silent <- moms::vdp.check.table(vdp_disp, vdp_space)

## Plotting the results
moms::vdp.plot(vdp_space, disparity = vdp_disp,
        plot.names = c("A - Base (no changes)",
                       "B - Change in volume",
                       "C - Change in density",
                       "D - Change in position",
                       "E - Change in vol. & den.",
                       "F - Change in vol. & pos.",
                       "I - Change in den. & pos.",
                       "J - All changes"))
```

To allow a more confident assessment of whether trait space changes occur, and also to refine the characterization of trait space change, we suggest using multiple metrics to describe trait-space occupancy the same way that multiple statistics are required to describe distributions.
In this paper, we analyse the effect of changes in simulated and empirical trait-spaces on seven space occupancy metrics to explicitly measure trait-space density and position. As expected, we found no one-size-fits-all metric but provide guidance on which metric could be used in which specific scenario. We also propose a new user-friendly software with an intuitive graphical user interface (GUI) to look at the effect of changes in trait-space occupancy on user defined disparity metrics: [`moms`]().
<!-- VW: This needs to be more aggressive but I can help with that when you want deeper text changes. -->








<!--  -->
<!--  -->
<!--  -->
<!-- METHODS SECTION -->
<!--  -->
<!--  -->
<!--  -->








# Methods

```{r metrics_list, echo = FALSE}
## Loading the list of metrics
source("list.of.metrics.R")
```

Briefly, we tested how seven different space occupancy metrics relate to each other, are affected by modifications of traits space and affect group comparisons in empirical data.
To do so, we performed the following steps (explained in more detail below):

1.  We simulated 13 different spaces with different sets of parameters (dimensions, distributions, etc);
2.  We transformed these spaces by removing 50% of the observations following four different scenarios corresponding to different empirical scenarios: randomly, by limit (e.g. expansion or reduction of niches), by density (e.g. different degrees of competition within a guild) and by position (e.g. ecological niche shift).
3.  We measured occupancy on the resulting transformed spaces using `r metric.names()` different space occupancy metrics;
4.  We applied the same space occupancy metrics to six empirical datasets from the literature (covering a range of disciplines and a range of dataset properties).


| Test | Methods section | Results
|------|-----------------|------------------
| How do the metrics compare to each other? | Metrics comparisons       | Figure 4@@@
| How are metrics affected by space shifts? | Space shifts              | Table 6@@@
| How is that reflected in the real world?  | Empirical examples        | Table 7@@@
Table 2@@@: summary of the tests in this paper.

## Generating spaces

We generated trait spaces using the following combinations of size, distributions, variance and correlation:

| space name | size  | distribution(s)                | dimensions variance | correlation |
|------------|-------|--------------------------------|---------------------|-------------|
| Uniform3   |200*3  | Uniform (min = -0.5, max = 0.5)| Equal            | none        |
| Uniform15  |200*15 | Uniform                        | Equal            | none        |
| Uniform50  |200*50 | Uniform                        | Equal            | none        |
| Uniform150 |200*150| Uniform                        | Equal            | none        |
| Uniform50c |200*50 | Uniform                        | Equal            | Random (between 0.1 and 0.9) |
| Normal3    |200*3  | Normal  (mean = 0, sd = 1)     | Equal            | none        |
| Normal15   |200*15 | Normal                         | Equal            | none        |
| Normal50   |200*50 | Normal                         | Equal            | none        |
| Normal150  |200*150| Normal                         | Equal            | none        |
| Normal50c  |200*50 | Normal                         | Equal            | Random (between 0.1 and 0.9) |
| Random     |200*50 | Normal, Uniform, Lognormal (meanlog = 0, sdlog = 1)| Equal            | none        |
| PCA-like   |200*50 | Normal                         | Multiplicative           | none        |
| PCO-like   |200*50 | Normal                         | Additive              | none        |
Table 3@@@: different simulated space distributions.

The different in space sizes (200 $\times$ 3, 200 $\times$ 15, 200 $\times$ 50 or 200 $\times$ 150) reflects the range of trait-space dimensions in literature: "low-dimension" spaces ($<15$) are common in ecology [@mammola2019] whereas high dimension spaces ($>100$) are common in macroevolution [@hopkins2017].
We used a distinct range of distributions (uniform, normal or random) to test the effect of observation distributions on the metrics.
We used different levels of variance for each dimensions in the spaces by making the variance on each dimension either equal (i.e. $\sigma_{D1} \simeq \sigma_{D2} \simeq \sigma_{Di}$) or decreasing (i.e. $\sigma_{D1} < \sigma_{D2} < \sigma_{Di}$) with the decreasing factor being either multiplicative (using the cumulative product of the inverse of the number of dimensions: $\prod_i^d(1/d)$) or additive (using the cumulative sum of the inverse of the number of dimensions: $\sum_i^d(1/d)$).
Both multiplicative and cumulative reductions of variance are used to illustrate the properties of ordinations where the variance decreases per dimensions [in a lognormal way in Principal components analysis - PCA; e.g. @marcy2016; healy2019; and in a normal way in Multidimensional Scaling - MDS, PCO or PCoA; e.g. @close2015; @wright2017].
Finally, we added a correlation parameter to take into account the potential correlation between different traits.
We repeated the simulation of each trait-space 20 times (resulting in 260 trait-spaces).

## Spatial occupancy metrics

We then measured `r metric.names()` different metrics on the resulting transformed spaces, including a new metric we produced:
 <!-- VW: [Justification] : -->

| Name | Definition | Captures | Source | Notes  |
|------|------------|----------|--------|--------|
| Average distance from centroid | $\frac{\sqrt{\sum_{i}^{n}{({k}_{n}-Centroid_{k})^2}}}{d}$ | Volume | @laliberté2010 | equivalent to the functional dispersion (FDis) in @laliberté2010 (but not weighted by observation's abundance) |
| Sum of variances | $\sum_{i}^{d}{\sigma^{2}{k_i}}$ | Volume | @wills2001 | common metric used in palaeobiology [@ciampaglio2001] |
| Sum of ranges | $\sum_{i}^{d}{\|\text{max}(d_{i})-\text{min}(d_{i})\|}$ | Volume | @wills2001 | more sensitive to outliers than the sum of variances |
| Ellipsoid volume | $\frac{\pi^{d/2}}{\Gamma(\frac{d}{2}+1)}\displaystyle\prod_{i}^{d} (\lambda_{i}^{0.5})$ | Volume | @donohue2013 | less sensitive to outliers than the convex hull hypervolume [@diaz2016; @blonder2018] |
| Minimum spanning tree average distance | $\frac{\sum(\text{branch length})}{n}$ | Density | @oksanen2007vegan | similar to the unscaled functional evenness [@villéger2008] |
| Minimum spanning tree distances evenness | $\frac{\sum\text{min}\left(\frac{\text{branch length}}{\sum\text{branch length}}\right)-\frac{1}{n-1}}{1-\frac{1}{n-1}}$ | Density | @villéger2008 | the functional evenness without weighted abundance [FEve; @villéger2008] |
| Average nearest neighbour distance | $min\left(\sqrt{\sum_{i}^{n}{({q}_{i}-p_{i})^2}}\right)\times \frac{1}{n}$ | Density | @foote1990 | the density of pairs of observations in the trait-space (c.f. the Minimum spanning tree average distance above) |
| Average displacement | $\frac{\sqrt{\sum_{i}^{n}{({k}_{n})^2}}}{\sqrt{\sum_{i}^{n}{({k}_{n}-Centroid_{k})^2}}}$ | Position | This paper | the ratio between the observations' position from their centroid and the centre of the trait-space. A value of 1 indicates that the observations' centroid is the centre of the trait-space |
Table 4@@@: List of metric with *n* being the number of observations, *d* the total number of dimensions, *k* any specific row in the matrix, *Centroid* being their mean and $\sigma^{2}$ their variance. $\Gamma$ is the Gamma distribution and $\lambda_{i}$ the eigen value of each dimension and ${q}_{i}$ and $p_{i}$ are any pairs of coordinates.


We selected these `r metric.names()` trait-space occupancy metrics to illustrate how they capture different aspects of trait-space occupancy (but note that this is not an expression of  our preference).
The supplementary results contain the same analysis as described below, performed using additional metrics.
Additionally, the [`moms`](@@@) shiny App allows exploration the effect of many more metrics as well as allowing customization of metrics by combining them or entering user-designed functions.

<!--  -->
<!--  -->
<!--  -->
<!-- COMPARING METRICS -->
<!--  -->
<!--  -->
<!--  -->


## Metrics comparisons

We compared the trait-space occupancy correlations across all simulations between each pair of metrics to assess they captured similar signal [@villéger2008; @laliberté2010].
First, we used the metrics on the full 13 trait-spaces described above.
We then scaled the results and measured the pairwise Pearson correlation to test whether metrics were capturing a similar signal (high positive correlation), a different signal (correlation close to 0) or an opposite signal (high negative correlations).
We performed all the tests using the `psych` package [@psych].

<!--  -->
<!--  -->
<!--  -->
<!-- EFFECT OF DIMENSIONALITY -->
<!--  -->
<!--  -->
<!--  -->
<!--
## Effect of dimensionality

Furthermore, high dimensional spaces ($>> 3$) are subject to the "curse of multidimensionality" [@cursedimensionality].
This is link to the fact that the more dimensions, the more sparse the data becomes.
In other words the probability of two points A and B overlapping in *n* dimensions is the probability of point A having the same value as point point B on dimension 1, 2, 3, etc...
Thus this probability decreases as a product of the number of dimensions.
This "curse" can make the interpretation of high dimensional data counter-intuitive.

For example, the product of range is expected to decrease with the number of dimensions, regardless of the number of elements on each dimensions.
This is counter-intuitive because:
1) first, the range of values on a dimension is bounded to the number of elements on this dimensions (i.e. increasing the number of observations on one dimension can only increase the range, never decrease it);
2) second, products are a classical example of the "curse" where multiplying a higher number of dimensions with a non-null probability of having a range of zero will irremediably result in 0 (i.e. an infinite number of positive values by 0 is still 0).

-->

```{r fig_curse, eval=FALSE, echo = FALSE, fig.height = 8, fig.width = 8, results = 'hide', fig.cap = paste("Figure 3: Effect of the curse of dimensionality on different scaled disparity metrics. Metrics with containing products (ellipsoid volume, product of ranges or variances) are classically affected by the \"curse\" as they decrease more or less rapidly with an increase in dimensions. Note especially how the Product of Range actually increases and then decreases with the number of dimensions.")}
set.seed(42)
## Make a 50 dimensions space
space <- space.maker(300, 50, rnorm, scree = rev(cumsum(rep(1/50, 50))))

## Function wrappers
disparity <- function(metric, dimensions, space) {
    fast.disparity(group = 1:nrow(space), space = space, metric = metric, rare.dim = dimensions)
}
lapply.fun <- function(dimensions, metrics_list, space) {
    unlist(lapply(metrics_list, disparity, dimensions = dimensions, space = space))
}

## Curse results
curse_results <- sapply(2:50, lapply.fun, metrics_list = metrics_list, space = space)
curse_results <- apply(curse_results, 1, function(x) return(x/max(x)))

## Empty plot
hue_colors <- default.palette(ncol(curse_results))
par(bty = "n")
plot(NULL, xlim = c(2,50), ylim = c(0,1),
xlab = "Dimensions (decreasing variance)",
ylab = "Scaled disparity")
for(metric in 1:ncol(curse_results)) {
    lines(curse_results[, metric], col = hue_colors[metric])
}
legend("bottomleft", metric_names, lty = 1, col = hue_colors)
```
<!--  -->
<!--  -->
<!--  -->
<!-- SHIFTING SPACES -->
<!--  -->
<!--  -->
<!--  -->

## Changing space {#changing-spaces}

To measure how the metrics responded to changes within trait-spaces, we reduced the spaces by removing 50% of elements each time using the following algorithms:

(e.g. expansion or reduction of niches), by density (e.g. different degrees of competition within a guild) and by position (e.g. ecological niche shift).

* **Randomly:** by randomly removing 50% of elements (Fig. 3@@@A).
This reflects a "null" biological model of changes in trait-space: the case when observations (e.g. species) are removed regardless of their intrinsic characteristics.
For example, if diversity (i.e. number of species) is reduced by 50% but the trait-space volume remains the same, there is a decoupling between diversity and trait-space occupancy [@ruta2013; @hopkins2013].
Our selected metrics are expected to not be affected by this change.

* **Limit:** by removing all elements with a distance from the centre (mean point) of the space lower or greater than a radius $\rho$ (where \$rho$ is selected such that 50% elements are selected) generating two limit removals: *maximum* and *minimum* (respectively in orange and blue; Fig. 3@@@B).
This can reflect a strict selection model where observations with trait values below or above a threshold are removed leading to an expansion or a contraction of the trait-space.
Volume metrics are expected to be most affected by this change.
<!-- TG: we could cite Mark's disparity extinction paper here! -->

* **Density:** by removing any pairs of point with a distance $D$ from each other where (where $D$ is selected such that 50% elements are selected) generating two density removals: *high* and *low* (respectively in orange and blue; Fig. 3@@@C).
This can reflect changes within groups in the trait-space due to ecological factors [e.g. competition can generate niche repulsion - lower density; @grant2006].
Density metrics are expected to be most affected by this change.

* **Position:** by removing points similarly as for **Limit** but using the distance from the furthest point from the centre (max point) generating two position removals: *positive* and *negative* (respectively in orange and blue; Fig. 3@@@D).
This can reflect global changes in trait-space due, for example, to an entire group remaining diverse but occupying a different niche (e.g. in the transition from non-avian dinosaur to avian dinosaurs).
Position metrics are expected to be most affected by this change.

The algorithm to select $\rho$ or $D$ is described in greater detail in in the [Appendix](#Appendix_algorithm_reduce).

```{r fig_reduce_space, echo = FALSE, fig.height = 8, fig.width = 8, results = 'hide', fig.cap = paste("Figure 3: different type of space reduction. Each panel displays two groups (orange and blue) of 50% of the data points each. Each groups are generated using the following algorithm: A - randomly; B - by limit (maximum and minimum limit in respectively orange and blue); C - by density (high and low in respectively orange and blue); and D - by position (positive and negative in respectively orange and blue).")}
set.seed(42)

## Change colors
defaults$col1 <- "blue"
defaults$col2 <- "orange"

op <- par(mfrow = c(2,2), bty = "n")
## The elements
elements <- 300
## The amount to remove
remove <- 0.5

## Trait space
trait_space <- space.maker(elements, 2, distribution = rnorm)

## The randomly removed space
random_rm <- reduce.space(trait_space, type = "random", remove = 0.5)
## Plotting the reduction
plot.space(trait_space, random_rm, main = "A - Random removal", defaults)

## The limit removal
limit_rm <- reduce.space(trait_space, type = "limit", remove = 0.5)
## Plotting the reduction
plot.space(trait_space, limit_rm, main = "B - Limit", defaults)

## The density removal
density_rm <- reduce.space(trait_space, type = "density", remove = 0.5)
## Plotting the reduction
plot.space(trait_space, density_rm, main = "C - Density", defaults)

## The displacement removal
displace_rm <- reduce.space(trait_space, type = "displacement", remove = 0.5)
## Moving the space to the upper right corner (positive)
plot.space(trait_space, displace_rm, main = "D - Position", defaults)


## List of removals (for plotting the tables later)
typical_removal <- list(space = trait_space,
                        remove = list("random" = random_rm,
                                      "limit(min)" = limit_rm,
                                      "limit(max)" = !limit_rm,
                                      "density(high)" = density_rm,
                                      "density(low)" = !density_rm,
                                      "displace(positive)" = displace_rm,
                                      "displace(negative)" = !displace_rm))
```

To measure the effect of space reduction, distribution and dimensionality on the metric, we first scaled the metric to be relative to the non-reduced space for each dimension distribution or number of dimensions.
To do so, we subtracted the observed occupancy with no space reduction (i.e. base occupancy) to all the occupancy measurements of the reduced spaces and then divided it by the resulting maximum observed occupancy.
This way, our occupancy metrics where scaled between -1 and 1 with a value of 0 indicating no effect of the space reduction and $>0$ and $<0$ respectively indicating an increase or decrease in the occupancy metric value.
We then measured the probability of overlap of the between the non-random removals (limit (max/min), density (high/low) and displacement (positive/negative)) and the random removals using the Bhattacharrya Coefficient [i.e. the probability of overlap between two distributions; @bhattacharyya1943; @guillerme2016].

### Measuring the effect of space and dimensionality on shifting spaces

In some situations, distribution differences and the number of dimensions can have an effect on the metric results.
For example, in a normally distributed space, a decrease in density can often lead to an increase in volume.
This is not necessarily true in log-normal spaces or in uniform spaces for certain metrics (e.g. the convex hull of a lognormal space will be less sensitive to changes in density).
Furthermore, high dimensional spaces (>10) are subject to the "curse of multidimensionality" [@cursedimensionality] which makes them "behave" differently than their counterparts with a lower number of dimensions.
This is linked to data becoming sparser with increasing dimensions, such that the probability of two points A and B overlapping in *n* dimensions is the product of the probability of the two points overlapping on each dimensions($\prod_{i}^{d} P(A = B)_{Di}$).
This probability decreases as a product of the number of dimensions.
This "curse" can make the interpretation of high dimensional data counter-intuitive.
For example if a group expands in multiple dimensions (i.e. increase in volume), the actual hypervolume can decrease (Fig. 4@@@ and Tables 6@@@, 7@@@).

We measured the effect of space distribution and dimensionality using an ANOVA ($occupancy \sim distribution$ and $occupancy \sim dimensions$) by using all spaces with 50 dimensions and the uniform and normal spaces with equal variance and no correlation with 3, 15, 50, 100 and 150 dimensions (Table 3@@@) for testing respectively the effect of distribution and dimensions.
The results of the ANOVAs (*p*-values) are reported in Table 6@@@ (see supplementary material for the full ANOVA results).

<!--  -->
<!--  -->
<!--  -->
<!-- EMPIRICAL EXAMPLES -->
<!--  -->
<!--  -->
<!--  -->

## Empirical examples

To address the degree of which the simulations can be applied to real biological problems, we analysed the effect of the different trait-space occupancy metrics on six different empirical studies covering a broad range of fields that employ trait-spaces analysis (palaeobiology, macroevolution, evo-devo, ecology, etc.).
For each of these six studies we generated trait-spaces from the data published with the papers.
We then divided the trait-spaces into two groups and applied the trait-space occupancy metric to each pair of groups to test whether different metrics captured different differences between groups.
Both the grouping and the questions where based on a simplified version of the biological questions addressed in these papers (with no intention to re-analyse the data but to be representative of a sample of the diversity of questions).
The procedures to generate the data and the groups varies from one study to the other but is detailed and fully reproducible in the supplementary materials.

study | field | taxonomic Group | traits (data) | trait-space | size | groups (orange/blue in Table 7) | type of question |
------|-------|-----------------|---------------|-------------|------|--------|------------------|
@beck2014 | palaeontology | Mammalia | discrete morphological phylogenetic data | Ordination of a distance matrix (PCO) | 106*105 | 52 crown vs. 54 stem | Are crown mammals more disparate than stem mammals?|
@wright2017 | palaeontology | Crinoidea | discrete morphological phylogenetic data | Ordination of a distance matrix (PCO) | 42*41 | 16 before vs. 23 after | Is there a difference in disparity before and after the Ordovician mass extinction?|
@marcy2016 | geometrics morphometrics | Rodentia | skull 2D landmark coordinates  | Ordination of a Procrustes Superimposition (PCA) | 454*134 | 225 *Megascapheus* vs. 229 *Thomomys* | Are two genera of Gopher morphological distinct? |
@hopkins2016 | geometrics morphometrics | Trilobita | 3D landmark coordinates | Ordination of a Procrustes Superimposition (PCA) | 46*46 | 36 adults vs. 10 adults | Are juvenile trilobites a subset of adult ones? |
@jones2015 | Ecology | Plantae | Communities species compositions | Ordination of a Jaccard distance matrix (PCO) | 48*47 | 24 aspens vs. 24 grasslands | Is there a difference in species composition between aspens and grasslands? |
@healy2019 | Ecology | Animalia | Life history traits | Ordination (PCA) | 285*6 | 83 ecthotherms vs. 202 endotherms | Do endotherms have more diversified life history strategies than ectotherms? |
Table 5@@@: details of the six empirical trait-spaces.

For each empirical trait-space we bootstrapped each group 500 times [@disprity] and applied the `r metric.names()` trait-space occupancy metric to each pairs of groups.
Note that when trait-space occupancy could not be calculated (e.g. due to the curse of multidimensionality), we collapsed the metric value to 0 (i.e. no trait-space occupancy was captured).
We then compared the means of each groups using the Bhattacharrya Coefficient [i.e. the probability of overlap between two distributions; @bhattacharyya1943; @guillerme2016].
The are displayed in Table 7@@@.

<!--  -->
<!--  -->
<!--  -->
<!-- RESULTS SECTION -->
<!--  -->
<!--  -->
<!--  -->








# Results

```{r loading_results, echo = FALSE}
## Loading the results
remove_05 <- load.results("remove_05")
```

```{r running_tests, echo = FALSE}
## Anova function
anova.fun <- function(data) {return(aov(glm(disparity ~ factor, data = data)))}

## Running the tests
all_test <- test.simulation(remove_05, test = anova.fun, scale = TRUE)
all_dim_test <- test.simulation(remove_05, test = anova.fun, scale = TRUE,
                      factors = c("uniform3", "uniform15", "uniform50", "uniform100", "uniform150",
                                  "normal3", "normal15", "normal50", "normal100", "normal150"))
space_test <- test.simulation(remove_05, test = anova.fun, scale = TRUE,
                              factors = c("uniform50", "uniform50c", "normal50", "normal50c",
                                          "random50", "pca_like", "pco_like"))
```

## Metric comparisons 


```{r fig_metric_correlation, echo = FALSE, fig.height = 8, fig.width = 8, results = 'hide', fig.cap = paste("Figure 4: pairwise correlation between the scaled metrics. Numbers on the upper right corner are the Pearson correlations. The red line are linear regressions (with the confidence intervals in grey).")}

## Adding proper names
results_pairwise <- remove_05
names(results_pairwise[[1]]) <- metric_names

## Plotting the pairwise results
pairwise.plot(results_pairwise, scale = TRUE, type = "base", plot = "cor")
```

All the metrics selected were either positively correlated (Pearson correlation of 0.99 for the Average distance from centroid and Sum of variance or 0.97 for the Average nearest neighbour distance and Minimum spanning tree average length; Fig. 4@@@) or somewhat correlated (ranging from 0.66 for the Sum of Variances and the Ellispsoid Volume to -0.09 between the Average displacement and the Average distance from centroid; Fig. 4@@@).
Note that all metrics but the Ellipsoid Volume were normally (or nearly normally) distributed (Fig. 4@@@).
This is due to the Ellipsoid Volume being more sensitive to the curse of multidimensionality (many values close to 0).
More comparisons between metrics are available in the supplementary materials.

## Space shifting

```{r fable_results, fig.show='hide', echo=FALSE, fig.height=3, fig.width=3}
## The metrics names (shortened vector)
name <- metric_names

## Making a list of parameters for each mini plot
plot.param <- list(scaler = 3,
                   bg.col = "black",
                   col = c("grey", "orange", "blue"),
                   quantiles = c(95, 50),
                   cent.tend = median,
                   pch = 19,
                   metric.max = length(metrics_list),
                   cex = 2)

## Looping through each mini plot for every metric
for(metric in 1:length(metrics_list)) {
    generate.fable.plot(data = remove_05, metric = metric, what = "limits", plot.param = plot.param, overlap = TRUE)
    generate.fable.plot(data = remove_05, metric = metric, what = "densit", plot.param = plot.param, overlap = TRUE)
    generate.fable.plot(data = remove_05, metric = metric, what = "displa", plot.param = plot.param, overlap = TRUE)
}

```

```{r, echo = FALSE, eval = FALSE}
## Function for printing the table in the R console
print.fable <- function(n_metrics, byrow, ncol, test) {
  ## Make the plot.id table 
  ids <- matrix(1:(n_metrics*ncol), ncol = ncol, byrow = byrow)

  for(one_metric in 1:n_metrics) {
    ## Print all the rows one by one
    text <- c(paste0("`r name[", one_metric, "]`"), paste0("`r plot.id(", ids[one_metric, ], ")`"))
    ## Add some tests?
    if(test) {
      text <- c(text, paste0("`r s.test(", one_metric, ", \"s\")`"), paste0("`r s.test(", one_metric, ", \"r\")`"))
    }
    ## Print the line
    cat(paste(text, collapse = " | "))
    cat("|\n")
  }
}
## Getting the fable to copy paste under the table header below.
print.fable(length(metrics_list), byrow = TRUE, ncol = 3, test = TRUE)
```

Metric      | Volume change  | Density change | Position change | Distribution effect | Dimensions effect |
:-----------|----------------|-----------------|----------------|---------------------|-------------------|
`r name[1]` | `r plot.id(1)` | `r plot.id(2)` | `r plot.id(3)` | `r s.test(1, "s")` | `r s.test(1, "r")`|
`r name[2]` | `r plot.id(4)` | `r plot.id(5)` | `r plot.id(6)` | `r s.test(2, "s")` | `r s.test(2, "r")`|
`r name[3]` | `r plot.id(7)` | `r plot.id(8)` | `r plot.id(9)` | `r s.test(3, "s")` | `r s.test(3, "r")`|
`r name[4]` | `r plot.id(10)` | `r plot.id(11)` | `r plot.id(12)` | `r s.test(4, "s")` | `r s.test(4, "r")`|
`r name[5]` | `r plot.id(13)` | `r plot.id(14)` | `r plot.id(15)` | `r s.test(5, "s")` | `r s.test(5, "r")`|
`r name[6]` | `r plot.id(16)` | `r plot.id(17)` | `r plot.id(18)` | `r s.test(6, "s")` | `r s.test(6, "r")`|
`r name[7]` | `r plot.id(19)` | `r plot.id(20)` | `r plot.id(21)` | `r s.test(7, "s")` | `r s.test(7, "r")`|
`r name[8]` | `r plot.id(22)` | `r plot.id(23)` | `r plot.id(24)` | `r s.test(8, "s")` | `r s.test(8, "r")`|
Table 6@@@: Results of the effect of space reduction, space dimension distributions and dimensions number of the different trait-space occupancy metrics. The dots represent the median trait-space occupancy values across all simulations for each scenario of trait space change, the solid and dashed line respectively the 50% and 95% confidence intervals. Results in grey are the random 50% reduction. Results in blue and orange represent the blue and orange opposite scenarios in Fig. 3@@@ (blue,  the minimum limit, low density and negative shift orange, maximum limit, high density and positive shift) for respectively the volume, density and position changes.
The displayed value in the plots are the probability of overlap (Bhattacharrya Coefficient) between the blue and orange reductions and the random ones. _p_-values for distribution effect and dimensions effect represents respectively the effect of the ANOVAs trait-space occupancy ~ distributions and trait-space occupancy ~ dimensions (Signif. codes: 0 '\*\*\*' 0.001 '\*\*' 0.01 '\*' 0.05 '.' 0.1 '' 1).

<!-- VW: Let's workshop this to see if we can have it non-repeating. It may even be worth adding one extra table that dissects the figures because the amount of information is too high to stay in someone's brain easily. -->

As expected (Fig. 2@@@), some different metrics capture different aspects of trait-space occupancy.
In contrast to the clear hypothetical example in Fig. 2@@@, it can be hard to predict the behaviour of each metric when 50% of the observations are removed.
In fact we observe a clear decrease in median metric in less than a third of the space reductions (10/36).

In terms of change in volume (increase or decrease), only the Average distance from centroid and the Sum of variances seem to capture a clear change in both directions.
Note however that the increase in volume does not correspond to an *actual* increase in volume in the trait-space (i.e. the volume from the blue observations in Fig. 3@@@B is equivalent to the one in Fig. 3@@@A).
In terms of change in density (increase or decrease), only the Minimum spanning tree average distance and the Average nearest neighbour distance seem to capture a clear change in both directions.
In terms of change in position (increase or decrease), only the Average displacements metric seems to capture a change a clear change in direction (albeit not in both directions).
This is not surprising however, since the notion of positions becomes more and more complex to appreciate as dimensionality increases (i.e. beyond left/right (1D), up/down (2D) and front/back (3D)).
<!-- VW:But does it warrant a cautionary use of the displacement metrics because of this lack of human-interpretable directionality? -->
<!-- TG: I don't think so -->


## Empirical example

```{r test_empirical, echo = FALSE}
## Loading the results
empirical_results <- load.results("empirical_results")

## Testing the differences for each distributions
bhatt.coeff.safe <- function(x, y, tol = 1e-16, ...) {
  if(all(x < tol) | all(y < tol)) {
    bhatt.coeff(1, 0)
  } else {
    bhatt.coeff(x, y, ...)
  }
} 
disparity_test <- lapply(empirical_results, lapply, test.dispRity, test = bhatt.coeff.safe)
```

```{r fable_results_empirical, fig.show='hide', echo=FALSE, fig.height=3, fig.width=3}
## Plotting parameters
plot.param <- list(cex = 2,
                   col = c("#F7B27E", "#BFE4E3"),
                   border = c("#F65205", "#3E9CBA"),
                   na.cex = 3,
                   scaler = 3)

## Looping through each mini plot for every metric
data_names <- c("Beck and Lee 2014", "Wright 2017", "Marcy et al. 2016",
                "Hopkins and Pearson 2016", "Jones et al. 2015", "Healy et al. 2019")

for(dataset in 1:length(data_names)){
    for(metric in 1:length(metrics_list)){
        ## Plotting the results
        generate.fable.empirical(data = empirical_results[[dataset]][[metric]],
                                 test = disparity_test[[dataset]][[metric]],
                                 precision = 1e-5, plot.param, dataset = dataset)
    }
}
```

```{r change_plotid_chain, echo = FALSE, eval = TRUE}
## Changing defaults
body(plot.id)[[3]] <- substitute(chain <- "fable_results_empirical")
```

```{r, echo = FALSE, eval = FALSE}
print.fable(length(metrics_list), byrow = FALSE, ncol = 6, test = FALSE)
```

Metric     | Beck and Lee 2014  | Wright 2017 | Marcy et al. 2016 | Hopkins and Pearson 2016 | Jones et al. 2015 | Healy et al. 2019  |
:-----------|----------------|-----------------|------------------|----------------|------------------|----------------|
`r name[1]` | `r plot.id(1)` | `r plot.id(9)` | `r plot.id(17)` | `r plot.id(25)` | `r plot.id(33)` | `r plot.id(41)`|
`r name[2]` | `r plot.id(2)` | `r plot.id(10)` | `r plot.id(18)` | `r plot.id(26)` | `r plot.id(34)` | `r plot.id(42)`|
`r name[3]` | `r plot.id(3)` | `r plot.id(11)` | `r plot.id(19)` | `r plot.id(27)` | `r plot.id(35)` | `r plot.id(43)`|
`r name[4]` | `r plot.id(4)` | `r plot.id(12)` | `r plot.id(20)` | `r plot.id(28)` | `r plot.id(36)` | `r plot.id(44)`|
`r name[5]` | `r plot.id(5)` | `r plot.id(13)` | `r plot.id(21)` | `r plot.id(29)` | `r plot.id(37)` | `r plot.id(45)`|
`r name[6]` | `r plot.id(6)` | `r plot.id(14)` | `r plot.id(22)` | `r plot.id(30)` | `r plot.id(38)` | `r plot.id(46)`|
`r name[7]` | `r plot.id(7)` | `r plot.id(15)` | `r plot.id(23)` | `r plot.id(31)` | `r plot.id(39)` | `r plot.id(47)`|
`r name[8]` | `r plot.id(8)` | `r plot.id(16)` | `r plot.id(24)` | `r plot.id(32)` | `r plot.id(40)` | `r plot.id(48)`|
Table 7@@@: Comparisons of different pairs of groups in different empirical trait-spaces. NAs are used for cases where trait-space occupancy could not be measured due to the curse of multidimensionality. The displayed values are the probability of overlap between both groups (Bhattacharrya Coefficient).

Similarly as for the simulated results, the empirical ones indicate that there is no perfect one-size-fit all metric.
For all `r metric.names()` metrics (expect the Ellispoid volume) we see either one group or the other having a bigger mean than the other and no consistent case where a group has a bigger mean than the other for all the metrics.
For example, in the @beck2014's dataset, there is a clear non-overlap in trait-space occupancy volume using the average distance from centroif or the sum of variances (overlaps of respectively 0.175 and 0.159) but no overlap when measuring the volume using the sum of ranges (overlap of 0.966).
However, for the @hopkins2016's dataset, this pattern is reversed (no clear differences for the average distance from centroid or the sum of variances - overlap of 0.701 and 0.865 respectively) but a clear difference for the sum of ranges (overlap of 0).
Furthermore, for each dataset, the absolute differences between each groups (i.e. mean of the orange group higher or lower than the one of the blue group) is not consistent depending on the metrics.
For example, in @hopkins2016's dataset, the orange group's mean is clearly higher than the blue one when measuring the sum of ranges (overlap of 0) and the inverse is true when measuring the average displacements (overlap of 0).


<!--  -->
<!--  -->
<!--  -->
<!-- DISCUSSION SECTION -->
<!--  -->
<!--  -->
<!--  -->








# Discussion

As expected we see a range of differences between the metrics themselves (Fig. 4@@@), their response to space shifting (Table 6@@@) and their effect on capturing differences in empirical datasets (Table 7@@@).
This should not come as a surprise because a trait-space occupancy metric is bound to capture different summary of the trait-spaces depending on both the metric and the trait space properties.
<!-- VW: We need to work on this: We found what was expected and that's not surprising is perhaps not the best way to sell ! -->

#### Metrics comparisons

Metrics that capture the same aspect of trait space occupancy (volume, density or position) do not have the same level of correlation.
For volume metrics, only the average distance from centroid and the sum of variances are strongly correlated (Pearson correlation of 0.99; Fig. 4@@@) whereas the sum of ranges and the ellispsoid volume are more weekly correlated to them (ranging from 0.07 to 0.40; Fig. 4@@@).
This is due to the sum of ranges and the ellispsoid volume being more affected by the number of dimensions and the type of trait-spaces [Table 6@@@; @cursedimensionality].
This does not precludes using such metrics but raises caution about what they capture in which scenarios [@donohue2013; @Butler2012].
We see the same pattern for the density metrics with the minimum spanning tree average distance and the average nearest neighbour distance being strongly correlated (correlation of 0.97; Table 6@@@), conversely to the minimum spanning tree distances evenness (correlation of respectively 0.18 and 0.20; Table 6@@@) that is also more affected by the number of dimensions and the type trait-space (Table 6@@@).

Furthermore, all metrics seem to behave following a normal distribution except for the ellipsoid volume which demonstrates a classic "curse of multidimensionality" with values increasing logarithmically first and then quickly decreasing to 0 [Fig. 4@@@; @cursedimensionality].
Overall, the fact that we have such a range of correlations for such conserved distributions suggests that each metric can capture different summaries of trait-space occupancy ranging from obvious differences (for metrics not strongly correlated) to subtle ones (for metrics strongly correlated).
Comparisons between more metrics are available in the Supplementary Material 4@@@ and show the same wide range of patterns.

Analysing the properties of metrics in a trait-space prior to using them to answer macroevolutionary or ecological questions can bring valuable insights into what aspect of space occupancy they are capturing.
For example, if captures the same pattern using the sum of variances and the sum of ranges, it is possible that the trait space have really similar properties (i.e. space with equal normal dimensions).

#### Space shifting

Most metrics capture a normal "null" space shift with no changes in space occupancy on average (i.e. randomly removing 50% of the data - in grey in Table 6@@@).
This is a desirable behaviour for space occupancy metrics since most studies using trait-space occupancy look at potential processes resulting in the observed space occupancy patterns [e.g. competition @brusatte2008, convergence @marcy2016, life history traits @healy2019, etc.].
In this context, random changes in the trait-space occupancy should not be picked up as a pattern to avoid false positive errors.
However, the average nearest neighbour distance and the sum of ranges have a respectively positive and negative "null" median meaning that any decrease of elements will always lead to respectively and increase and a decrease of these metrics even when the process is random (Table 6@@@).
This is not especially a bad property for both metrics (i.e. they can still be used to analysis changes in space occupancy) but it should be kept in mind that even random processes will increase or decrease the metric value which can lead to false positives or negatives. 

Regarding the changes in volume of the trait-spaces, the sum of variances and the average distance from centroid are excellent descriptors, with both maximum and minimum limit changes leading to a clear increase or decrease of the metrics values.
However, as illustrated in the 2D examples in Fig. 3@@@B, only the minimum limit changes (orange) should actually lead to a decrease of volume of the trait-space; the volume of the maximum limit shifted trait-spaces should have the same volume as the non-modified trait-space but with a hole in its centre ("hollowing out").
Therefore, an increase in "volume" of the trait-space does not necessary always corresponds to an *actual* 3D volume increase but could also reflect a "hollowing" of the trait-space.
However, the shit from a small volume (orange; Fig. 3@@@B) to a bigger "hollow" volume (blue; Fig. 3@@@B) can still be interpreted has an increase in volume.

Regarding changes in density of the trait-spaces, the average nearest neigbhour distance and the minimum spanning tree average distance consistently detect changes in density with more precision for low density trait-spaces (in blue in Table 6@@@).
However, these metrics seem to be also associated to a "null" increase: a small increase in the metric value could be due to a random change (null) or a small decrease in density (see above).
In general, we can observe some degree of correlation between the changes in density and the changes in volume for most metric picking either signal (i.e. the average nearest neighbour distance picks both changes in density and in volume).
This could be due the generation of normally distributed spaces where a change in density often leads to a change in volume (i.e. to increase density in a normal distribution, one can simply reduce its tails).
This is not necessary the case with empirical data.

Regarding the changes in position of the trait-space, all but the average displacements metric seems to not be able to distinguish between a random change in trait-space (grey) and a positive or a negative displacement of the trait-space (blue and orange - Table 6@@@).
Furthermore the average displacements metric does not distinguish between and positive or a negative displacement of the trait-space: in both cases, the metric increases.
This might be due to the inherent complexity of "position" in a trait space that increases with the number of dimensions.
In fact, it is complex to intuitively describe position beyond a 2D (left/right) or 3D (up/down) space.

Regarding the effect of dimensions and trait-space distribution, metrics seems to be either affected by neither of these factors or by both (Table 6@@@).
Again, this should not preclude using metrics that are sensitive to trait-spaces' dimensions and distributions [e.g. the ellispoid volume is a good volume discriptor up until a moderate number of dimensions; @jackson2011; @donohue2013] but should be kept in mind.

#### Empirical examples

Although most differences are fairly consistent within each dataset with one group having a higher space occupancy score than the other for multiple metrics, this difference can be more or less pronounced within each dataset (ranging from no to nearly full overlap - BC $\in(0;0.995)$) and sometimes even reversed.
This indicates that opposite conclusions can be drawn from a dataset depending on which space occupancy metric is considered.
For example, in @wright2017 dataset where the blue group has a greater occupancy metric median value but for the average displacements metric showing a higher median displacement in the red group (Table 7@@@).
These differences in group's space occupancy depending on the metrics are also more pronounced in the empirical datasets where the elements per group is highly different [@hopkins2016; @healy2019].
This also highlights the influence of different groups size on top of the differences in trait spaces and metrics properties.
Finally it is worth noting that the ellispoid volume only picks up accurate differences between groups in the @healy2019 dataset which is yet another illustration of the curse of multidimensionality: the @healy2019 dataset has only 6 dimensions compared to all the other ones having more than 41 dimensions [and the @marcy2016 dataset having 136 dimensions for which the ellipsoid volume can't be calculated; Table 7@@@; @cursedimensionality].

## Caveats

While our simulations have been useful to illustrate the behavior of diverse trait-space occupancy metrics, they have several caveats. 
For example the trait spaces are simulated by treating each observation as independent.
This is not often the case in biology since observations might be spatially [@jones2015] or phylogenetically auto-correlated [e.g. @beck2014].
However, we can note that the we get expected results from the empirical data (where the observations are more realistically auto-correlated).
Furthermore, the algorithm used to reduce the multi-dimensional spaces might not always accurately reflect how trait-spaces are changed in nature.
They might indeed favour the response of specific metrics, in particular for the changes in density that only modifies the density between pairs of points rather than changing the global density.
This is a specific algorithmic choice was made in order to not confound changes in density along with changes in volume (i.e. a general change in density can be obtain by uniformly increasing/decreasing the volume).
<!-- VW: Conclusion sentence -->

## Suggestions

We insist that there is no metric better than another one and that researchers should use the most appropriate metrics based on their question and knowledge of both the metric and the trait-space properties.
However, the findings of this study might suggest several points:

First, we suggest using multiple metrics to tackle different aspects of the trait-space. 
This is suggestion is in the same logical thinking line that the mean can not be sufficient to describe a distribution (the variance and the type of distribution might be good additional indicators).
Although using multiple metrics is not uncommon in macroevolutionary studies [e.g. @halliday2015] or in ecology [@mammola2019], they often do not cover contrasted aspects of the trait-space (and are often different proxies of the volume of a trait-space).

Second, we suggest selecting a metric (or a series of metrics) that best help answering the biological question a hand.
In fact, if one studies an adaptive radiation in a group of organisms, it is worth thinking what would be the expected null model: would the group's volume increase (radiation in all directions), would it increase in density (niche specialisation) or would it shift in position (radiation into a new set of niches)?

Third, we suggest to not name metrics as the biological aspect they are potentially describing (e.g. disparity or functional dispersion) but rather what they are measuring (e.g. sum of dimensions variance or the average distance from centroids).
We believe this point will allow both a clearer understanding of what is measured (c.f. what is approximated) and a easier understanding between ecology and evolution for which the metrics can be the same but named differently and used for approximating different types of trait occupancy.
For example, the average squared pairwise distance [`geiger::dtt`; @geiger2008] and the Procrustes Variance [`geomorph::disparity`; @adams2013geomorph] often describe the same aspect of space occupancy (see Supplementary material 4@@@).
<!-- But are the the same, as your preceding sentence suggests? -->

# Conclusion

STILL DRAFT:
Multidimensional analysis is the future in biology.
It is important however to know what patterns we are describing from multidimensional data.
There are non one-size-fits-all trait-space occupancy metric.
Check the properties of your space and your metric (using [`moms`](@@@)!).
Use multiple metrics.
<!-- AM: Somehow I missed a mention / selling of the new metric you introduce in this paper. Can you prop that up?  -->


# Acknowledgements

Thanks to Natalie Jones for helping finding/sorting the ecological data.
Money from the ARC DP170103227, FT180100634

# References



# Supplementary material

## Algorithm for selecting the parameters to reduce the space ($radius$, $displacement$, $density$) {#Appendix_algorithm_reduce}

We used a recursive algorithm for selecting the parameter that removes $P$ = 50% elements.

1. Select a random reduction parameters $R$.
2. Remove elements from the space using $R$ resulting in $P'$ removed elements.
If the remaining number of elements is to the required proportion $P$ ; exit the algorithm;
Else go to 3.
3. Get the different between the proportion of removed elements $P'$ and $P$.
If the difference is positive set the increment parameter $R$ to $R = 1.1 \times R$, then go to 2.
Else set $R = 0.9 \times R$, then go to 2.

The algorithm is implemented in the `optimise.parameter` function in [reduce.space_fun.R](@@@).
