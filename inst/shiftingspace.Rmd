---
title: "Shifting spaces: how to summarise multidimensional spaces occupancy? "
author: "Thomas Guillerme, Mark Puttick, Ariel Marcy, Vera Weisbecker"
bibliography: references.bib
date: "`r Sys.Date()`"
output:
  html_document:
    fig_width: 8
    fig_height: 8
---

<!-- When toggling to html, toggle snippet `compilation_html` below to eval = TRUE -->

<!-- To build the line numbered version (for submission) use the following yaml header snippet
output:
  pdf_document:
    fig_width: 8
    fig_height: 8
    keep_tex: true
self_contained: false
---
and edit the save .tex file to add the following

\usepackage{lineno} %in the package header

\linespread{2} %in the document header

\modulolinenumbers[1] % just after the \begin{document} tag
\linenumbers
 -->


```{r header, echo = FALSE, results = 'hide', message = FALSE, warning = FALSE}
## Repeatability note:
## This whole paper is entirely reproducible and compiles as a single document. The data, figures
## and tables are all generated through the code snippets in this file. Note that the first time
## that this paper is compiled, it will generate the data which will take substantial time
## as the shiftingspace_supplementary.Rmd file completion takes ~10 minutes. Subsequent compilations
## will be much faster!

## Loading the packages
if(!require(devtools)) install.packages("devtools")
if(!require(knitr)) install.packages("knitr"); library(knitr)
if(!require(rmarkdown)) install.packages("rmarkdown"); library(rmarkdown)
if(!require(ape)) install.packages("ape"); library(ape)
if(!require(dispRity)) install.packages("dispRity"); library(dispRity)
if(packageVersion("dispRity") < "1.2.4") {
    ## dispRity must be above v1.2.3
    devtools::install_github("TGuillerme/dispRity"); library(dispRity)
}
if(!require(moms)) devtools::install_github("TGuillerme/moms"); library(moms)

## Setting the datapath
DATA_PATH <- "../data/processed/"

## Create data directory
if(!dir.exists(DATA_PATH)) {
    dir.create(path = DATA_PATH, showWarnings = FALSE)
}

## Setting the default parameters for the space plots
defaults <- list(pch = 20,
                 xlim = c(-3, 3),
                 ylim = c(-3, 3),
                 col1 = "grey",
                 col2 = "black",
                 xlab = "Trait",
                 ylab = "Trait",
                 cex = 1)
## Generating the default palette
default.palette <- function(n) {
    hues <- seq(15, 375, length = n + 1)
    grDevices::hcl(h <- hues, l = 65, c = 100)[1:n]
}

## Checking whether the data exists
if(!all(c("remove_05.Rda") %in% list.files(DATA_PATH))) {
    ## Run The supplementary material (simulation) ~ 5 minutes
    rmarkdown::render("shiftingspace_supplementary_simulation.Rmd", "html_document")    
}
if(!all(c("empirical_results.Rda") %in% list.files(DATA_PATH))) {
    ## Run The supplementary material ~ 5 minutes
    rmarkdown::render("shiftingspace_supplementary_empirical.Rmd", "html_document")
}
```


```{r compilation_html, echo = FALSE, eval = TRUE}
## Changing defaults
body(plot.id)[[2]] <- substitute(type <- ".png")
```

# Abstract

Trait multidimensional analysis are now a common tool-kit in ecology and evolution.
Such analysis are based on a multidimensional where each dimension represent a trait (or a transformation thereof) thus summarising all observed and potential trait combinations in a multidimensional trait-space (e.g. a morphospace or an ecospace).
To quantify the overall occupation of such trait-spaces, researchers apply one or more metrics that summarise the way in which organisms inhabit that 'trait-space'.
Using these metrics, researchers have investigated at how trait space occupancy changes through time, in relation to other groups of organisms or in response to global environmental changes (e.g. global warming events or mass extinctions).

Although few well defined space occupancy metrics are used in ecology and evolution, we lack a general description of the majority of those metrics, especially in macroevolution (often called disparity metrics).
Therefore the mathematical and biological meaning of such trait-space occupancy metrics can be vague.
This as consequences when interpreting changes in trait-space occupancy and linking them to biological phenomenon.
For example, does a reduction in volume in trait-space corresponds to episodes of extinction or changes in traits distribution?
Does an overlap in trait-space means overlapping niches?

Here we propose a user friendly tool to Measure Occupancy in Multidimensional Spaces (moms) that allows to visualise numerical changes of many disparity metrics following space transformations (e.g. contraction, displacement, etc.) as well as visualising a 2D projection of the associated space changes.
This tool thus allows researchers to explore and visualise the properties of disparity metrics under various parameters.
Furthermore, we propose a thorough review of the behaviour of seven common and two new disparity metrics regarding various spacial properties (i.e. distribution, transformation, dimensionality).
As expected, we found that different metrics are more appropriated to be used in different disparity analysis.
<!-- > MNP. Rather than just observing differences, may it be more important to (i) show what different metrics measure and can we actually relate this to underlying biology, and (ii) generate null changes with parameters of interest for a researcher's clade. -->

# Introduction

Life on earth is essentially multidimensional.
Both organisms and their environments are a combination of multiple of traits whether they are phenotypic, physiological, phylogenetic, behavioural, etc.
In fact since the advent of modern biology, it has been acknowledged that groups of species and environments share specific, easily recognisable, correlated characteristics (e.g. guilds or biomes).
In fact, a consensus is emerging that organisms or environments should be studied as a set of traits rather than some specific traits in isolation [e.g. @donohue2013; @hopkins2017].
This has led to and explosion of multiple traits studies approaches facilitated by increased computational power and statistical methods as well as by the implementation of statistical methods in `R` packages [@oksanen2007vegan; @adams2013geomorph; @blonder2018; @disprity].

One popular way to analyse all these traits in concert is to use ordination (or dimensionality reduction) techniques [see @legendre2012 for a summary] to create a trait-space of the studied system.
Such trait-space approach has been successfully used across many sub-disciplines in biology to either explore properties of the data or test hypothesis.
For example, in palaeobiology, such trait spaces can be used to look how groups of species change in terms of shared characteristics through time [e.g. @wright2017];
in ecology, it can be used to compare two populations and see whether their overlap can be related to ecological processes such as competition [e.g. @jones2015].
However, different fields use a different set of terms and approaches for such trait-space approaches.
In macroevolution, for example, such trait-spaces are commonly referred to as "morphospaces" [with the whole procedure often being often called "disparity analysis"; e.g. @adams2013geomorph; @marcy2016; @wright2017], while in ecology, such trait-spaces can be called "functional spaces" [and "dissimilarity analysis"; e.g. @diaz2016; @mammola2019].
Nonetheless, they are the same mathematical objects: matrices with columns representing a trait (or a transformation thereof) and rows representing observations [taxon, field site, etc.; @disprity].

Furthermore, researchers working on ecology or evolution are also using trait-spaces for similar reasons.
Across many sub-disciplines they will look at how their observations occupy the trait-space.
In fact, they often are interested in the same fundamental questions: are two groups overlapping in the trait-space? Are some regions of the trait space not occupied? Or how does specific factors influence the occupancy of the trait-space?
This is achieved in various ways such as using disparity metrics (or indices) in macroevolution [@wills2001; @hopkins2017; @disprity] or comparing hypervolumes in ecology [@donohue2013; @diaz2016; @blonder2018; @mammola2019].
Although these trait-space occupancy metrics are common in ecology and evolution, surprisingly little work has been published on their behaviour [but see @ciampaglio2001; @villéger2008; @mammola2019].
This can seem trivial but (unsurprisingly) different space occupancy metrics will capture different aspects of the trait-space.
In many studies in ecology and evolution authors have focused on measuring the volume of the trait-space [or a function thereof; e.g. ellipsoid volume @donohue2013; hypervolume @diaz2016; product of variance @wright2017; Procrustes variance @marcy2016], yet this only represent a single aspects of multidimensional occupancy that exclude other aspects that can be of interest [e.g. the density @geiger2008; the position @wills2001; @ciampaglio2001; or dissimilarity between groups @oksanen2007vegan; @close2015).
Therefore, this lack of diversity in multidimensional occupancy metrics may restrain the potential of multidimensional analysis [@villéger2008].

Here we propose a broad classification of space occupancy metrics as used across ecology [@villéger2008] and evolution [@wills2001] and analyse their power to detect changes in multidimensional space occupancy in empirical and simulated data.
We propose a review of each broad type of space occupancy metrics and a unified terminology aiming to foster easier communication between ecology and evolution.
Unsurprisingly, we found that there is no one-size-fits-all metric and that they are often dependent on the characteristics of the space and the question at hand.
Because they can potentially be as many metrics than they are trait-spaces and studies, it would be a daunting task to propose clear generalities to space occupancy metrics behaviour, therefore, we propose a user friendly tool allowing researchers to design, experiment and visual their own space occupancy metric tailored for their specific project.

## Space occupancy metrics

As mentioned before, we will call trait-spaces any matrix where rows are observations and columns are traits.
These traits can widely vary in number and types.
For example traits could be discrete observations on an organism [e.g. presence of absence of a bone; @beck2014; @wright2017], continuous ones [e.g. leaf area; @diaz2016] or more sophisticated continuous ones [e.g. landmark position; @marcy2016].
Traits can also be relative observations such as community composition [e.g. @jones2015] or even some distance between observations [e.g. @close2015].
However, regardless of the methodology used to build a trait-space, three main broad occupancy metrics can be measured to investigate how observations are distributed in the trait-space: the volume which will approximate the *amount* of space occupied, the density which will approximate the *distribution* in space and the position which will approximate the *location* in space [Figure 1; @villéger2008].
Of course any combination of these three aspects is always possible.

```{r fig_metrics_types, echo = FALSE, fig.height = 3, fig.width = 9, results = 'hide', fig.cap = paste("Figure 1: different type of information captured by disparity metrics. A - Volume (e.g. sum of ranges); B - Density (e.g. average squared pairwise distances); C - Position (e.g. median distance from centroid).") }

set.seed(11)
## Plot space function (utility shortcut)
## The elements
elements <- 10

## Trait space
trait_space <- space.maker(elements, 2, distribution = rnorm)

## Graphical parameters
op <- par(mfrow = c(1,3), bty = "n")

## The volume
plot(trait_space, pch = defaults$pch, main = "A - Volume", xlab = "Trait 1", ylab = "Trait 2")
## The range lines
lines(x = range(trait_space[,1]), y = rep(mean(trait_space[,2]), 2), col = defaults$col1)
lines(x = rep(mean(trait_space[,1]), 2), y = range(trait_space[,2]), col = defaults$col1)

## The density
plot(trait_space, pch = defaults$pch, main = "B - Density", xlab = "Trait 1", ylab = "")
## Plotting the pairwise lines
pair.line <- function(line, trait_space, defaults) {
    lines(x = trait_space[line,1], y = trait_space[line,2], col = defaults$col1)
}
apply(combn(1:elements, 2), 2, pair.line, trait_space, defaults)
points(trait_space, pch = defaults$pch)

## The position
plot(trait_space, pch = defaults$pch, main = "C - Position", xlab = "Trait 1", ylab = "")
## Plotting the center of the space
points(0,0, pch = 13, cex = 2)
arrows(x0 = 0, y0 = 0, x1 = trait_space[,1], y1 = trait_space[,2], code = 0, col = defaults$col1)
points(trait_space, pch = defaults$pch)

par(op)
```

#### 1. The volume

Volume metrics measures the spread of a group in the trait-space.
Such metrics can be interpreted as the amount of the trait-space that is occupied by observations.
Typically, larger values for such metrics indicate more more extreme trait combinations.
For example if group A has a bigger volume than group B, the observations in group A achieve more extreme trait combinations than in group B.
This type of metrics is really common in both ecology [the hypervolume; @blonder2018] or in evolution [the sum or product of ranges or variances @wills2001; @ciampaglio2001 or the Procrustes variance @adams2013geomorph].
In general, such metrics are a variation of the hypercube volume.

Although this type of metric is a really good indicator for comparing group's trait-space occupancy, it is only limited to comparing the range of extreme trait-combinations between groups.
Typically, such metrics do not take into account the spread of the observations within a group.
In other words, such metric can make it difficult to determine whether all the observations are on the edge of the volume or whether the volume is simply driven by a couple of extreme observations.
This weakness has been acknowledged in palaeoecology for example for the product of ranges metric (the exact size of the hypercube) which is highly sensitive to outliers [@Butler2012] or in ecology with the use of convex-hypervolumes.
However, this can be easily alleviated by using lower confidence intervals [e.g. by only at 95% of the data; @donohue2013 or by using the variance instead of the range; @ciampaglio2001].


#### 2. The density

Density metrics measure the distribution of a group in the trait-space.
Such metrics can be interpreted as an indication of the "packedness" of a group in trait-space.
For example, if group A is more dense than group B, observations in group A tend to be more similar between each other relatively than within group B.
Although this aspect of trait-space occupancy is less routinely measured, it is still often used in both evolution [e.g. the average pairwise distance; @geiger2008] or in ecology [e.g. the minimum spanning tree length; @oksanen2007vegan].

This type of metrics could be used more often in concert of a volume to allow answering finer hypothesis.
For example, if group A has a greater volume than group B but both have the same density, similar mechanisms could be driving both groups trait-space occupancy (e.g. a Brownian motion) but maybe group A is older and had more time to achieve more extreme trait combinations.

#### 3. The position

Position metrics measure where a group lies in trait-space.
Such metrics can be interpreted as an indication of where a group lies in the trait-space either relative to the space itself or relative to another group.
For example, if group A has a different position than group B, observation in group A will have a different trait-combination than group B.

This type of metrics is probably harder to interpret in multidimensional spaces (i.e. beyond left/right and above/below) and hence less often used.
However, when thinking about unidimensional data, this metric is pretty obvious: for example, two groups A or B could have the same variance (i.e. "volume" or spread) with the same number of observations (i.e. the same density) but could have a totally different mean and thus be in different positions.
Although these metrics are more rare in macroevolution (to our knowledge), they have been used in ecology to compare the position of two groups relatively to each other [@mammola2019].


## One metric to rule them all?

In an ideal word, the choice of the metric should be based on the properties of changes in the trait-space of interest while taking into account the properties of the space (number of elements or/and dimensions and distribution of the data on each axis).
However, it is highly unlikely that a such one-size-fits-all metric exist; rather, it is important to assess the properties of a metric relative to the specific data used.

If the question of interest is, say, to look at how trait-space occupancy changes in response to mass extinction, using a single metric to describe one aspect of occupancy (usually the volume) can miss an important part of the picture.
For example, in @halliday2015, the authors demonstrate a change in mammalian trait-space volume as a result from the Cretaceous-Palaeogene extinction [66 million years ago - Mya - Fig. 5 in @halliday2015] yet this one seems to be also accompanied by an apparent shift in the trait-space position due to the extinction of basal mammals [Fig. 8 in @halliday2015].
Such examples can be found throughout the literature in both evolution and ecology on different aspects of trait-space occupancy [e.g. @close2015; @diaz2016].
Figure 2 illustrates this problem where the three aspects (volume, density and position) can be decouple and change in concert or independently.
For this example, both trait space (2D), the observations (8) and the metrics have been optimised for illustration purpose.
In empirical data, the relations can be more complex to discern.
Yet, this illustrates how using only one specific space occupancy metric (e.g. the volume) will fail to capture changes in the trait-spaces C, D, and I.


<!-- In Slater et al 2017: variation in mean squared pairwise distance (density) with two peaks (25 Mya and 5 Mya) corresponding to a less densily packed trait-space (Fig. 5) which might be not optimal to explain the shift in body mass (position) and the increase in variance (volume) for the one trait analysed (body length).
 -->

```{r fig_metric_captures, echo = FALSE, fig.height = 4, fig.width = 8, results = 'hide', fig.cap = paste("Figure 2: Illustration how three different volume (Vol. - Product of ranges), density (Den. - Average nearest neighbour distance) and position (Pos. - Average displacement) metrics capture different occupancy aspects in this simplified trait-space.") }

## Making the volume/density/position space
vdp_space <- moms::vdp.make()

## Measuring disparity
vdp_disp <- moms::vdp.dispRity(vdp_space,
                         volume = c(prod, ranges),
                         density = c(mean, neighbours),
                         position = c(mean, displacements))

## Checking the table of volume changes
silent <- moms::vdp.check.table(vdp_disp, vdp_space)

## Plotting the results
moms::vdp.plot(vdp_space, disparity = vdp_disp,
        plot.names = c("A - Base (no changes)",
                       "B - Change in volume",
                       "C - Change in density",
                       "D - Change in position",
                       "E - Change in vol. & den.",
                       "F - Change in vol. & pos.",
                       "I - Change in den. & pos.",
                       "J - All changes"))
```

To alleviate this problem we suggest using multiple metrics to describe trait-space occupancy the same way that multiple statistics are required to describe distributions.
This has also to advantage of allowing finer scale and more precise evolutionary or ecological questions.
For example, during a radiation following a mass extinction event, one could both predict an increase of the volume of the trait-space [e.g. an increase in morphological diversity in birds; @crouch2019] but also a shift if position in the trait-space [e.g. a shift from non-avian to avian dinosaur traits; @crouch2019].
Similarly, in ecology, differences in density of the trait-space while the volume remains constant could indicate some kind of selection pressures on the studied traits (i.e. due to the "narrowness" of trait combination for example in desert plants).

In this paper, we analyse the effect of changes in simulated and empirical trait-spaces on seven space occupancy metrics to explicitly measure trait-space density and position.
As expected, we found no one-size-fits-all metric but provide guidance on which metric could be used in which specific scenario.
We also propose a new user friendly software with an intuitive graphical user interface (GUI) to look at the effect of changes in morphospace occupancy on user defined disparity metrics: [`moms`]().








<!--  -->
<!--  -->
<!--  -->
<!-- METHODS SECTION -->
<!--  -->
<!--  -->
<!--  -->








# Methods

We tested how seven different space occupancy metrics 1) relate to each other, 2) are affected by modifications of traits space and 3) affect group comparisons in empirical data.
To do so we performed the following steps (explained in more details below):

1. We simulated 13 different spaces with different set of parameters (dimensions, distributions, etc);
2. We transformed these spaces by removing 50% of the observations following four different scenarios: randomly, by limit, by displacement and by density;
3. We measured occupancy on the resulted transformed spaces using seven different space occupancy metrics;
4. We applied the same space occupancy metrics to six empirical datasets from the literature (covering a range of disciplines and a range of dataset properties).

| Test | Methods section | Results figure
|------|-----------------|------------------
| How do the metrics compare to each other? | Metrics comparisons       | Figure 4
| How are they affected by space shifting?  | Space shifting            | Figure 5
| How is that reflected in the real world?  | Empirical examples        | Figure 6

Table 1: summary of the tests in this paper.

## Generating spaces

We generated trait spaces using the following combinations of size, distributions, variance and correlation:

| space name | size  | distribution(s)                | dimensions variance | correlation |
|------------|-------|--------------------------------|---------------------|-------------|
| Uniform3   |200*3  | Uniform (min = -0.5, max = 0.5)| Equal            | none        |
| Uniform15  |200*15 | Uniform                        | Equal            | none        |
| Uniform50  |200*50 | Uniform                        | Equal            | none        |
| Uniform150 |200*150| Uniform                        | Equal            | none        |
| Uniform50c |200*50 | Uniform                        | Equal            | Random (between 0.1 and 0.9) |
| Normal3    |200*3  | Normal  (mean = 0, sd = 1)     | Equal            | none        |
| Normal15   |200*15 | Normal                         | Equal            | none        |
| Normal50   |200*50 | Normal                         | Equal            | none        |
| Normal150  |200*150| Normal                         | Equal            | none        |
| Normal50c  |200*50 | Normal                         | Equal            | Random (between 0.1 and 0.9) |
| Random     |200*50 | Normal, Uniform, Lognormal (meanlog = 0, sdlog = 1)| Equal            | none        |
| PCA-like   |200*50 | Normal                         | Multiplicative           | none        |
| PCO-like   |200*50 | Normal                         | Additive              | none        |
Table 2: different simulated space distributions.

The different in space sizes (200 $\times$ 3, 200 $\times$ 15, 200 $\times$ 50 or 200 $\times$ 150) reflects the range of trait-space dimensions in literature: "low-dimension" spaces ($<15$) are common in ecology [@mammola2019] whereas high dimension spaces ($>100$) are common in macroevolution [@hopkins2017].
We used a different range of distributions (uniform, normal or random) to test the effect of observation distributions on the metrics.
We used different levels of variance for each dimensions in the spaces by making the variance on each dimension either equal (i.e. $\sigma_D1 \simeq \sigma_D2 \simeq \sigma_Di$) or decreasing (i.e. $\sigma_D1 < \sigma_D2 < \sigma_Di$) with the decreasing factor being either multiplicative (using the cumulative product of the inverse of the number of dimensions: $\prod_i^d(1/d)$) or additive (using the cumulative sum of the inverse of the numbe of dimensions: $\sum_i^d(1/d)$).
Both multiplicative and cumulative reductions of variance are used to illustrate the properties of ordinations where the variance decreases per dimensions [in a lognormal way in Principal components analysis - PCA; e.g. @marcy2016; healy2019; and in a normal way in Multidimensional Scaling - MDS, PCO or PCoA; e.g. @close2015; @wright2017].
Finally we added a correlation parameter to take into account the potential correlation between different traits.
We repeated the simulation of each trait-space 20 times (resulting in 260 trait-spaces).

## Spatial occupancy metrics

We then measured seven different metrics on the resulting transformed spaces:

Name | Definition | Captures | Source | Notes  |
-----|------------|----------|--------|---------|
Average distance from centroid | $\frac{\sqrt{\sum_{i}^{n}{({k}_{n}-Centroid_{k})^2}}}{d}$ | Volume | @laliberté2010 | This is equivalent to the functional dispersion (FDis) in @laliberté2010 (but not weighted by observation's abundance) |
Sum of variances | $\sum_{i}^{d}{\sigma^{2}{k_i}}$ | Volume | @wills2001 | This way of measuring the volume is less sensitive to outliers [c.f. sum of ranges; @wills2001] |
Ellipsoid volume | $\frac{\pi^{d/2}}{\Gamma(\frac{d}{2}+1)}\displaystyle\prod_{i}^{d} (\lambda_{i}^{0.5})$ | Volume | @donohue2013 | This metric is less sensitive to outliers than the convex hull hypervolume [@diaz2016; @blonder2018] |
Minimum spanning tree average distance | $\frac{\sum(\text{branch length})}{n}$ | Density | @oksanen2007vegan | This metric is related to the functional evenness [FEve; @villéger2008; though not weighted for abundance] |
Average nearest neighbour distance | $min\left(\sqrt{\sum_{i}^{n}{({q}_{i}-p_{i})^2}}\right)\times \frac{1}{n}$ | Density | This paper | This metric measures the density of pairs of observations in the trait-space (c.f. the Minimum spanning tree average distance above) |
Average displacement | $\frac{\sqrt{\sum_{i}^{n}{({k}_{n})^2}}}{\sqrt{\sum_{i}^{n}{({k}_{n}-Centroid_{k})^2}}}$ | Position | This paper | This is the ratio between the observations' position from their centroid and the centre of the trait-space. A value of 1 indicates that the observations' centroid is the centre of the trait-space |
Variance of the distance from centre | $\sigma^2 \left(\sqrt{\sum_{i}^{n}{({k}_{n})^2}}\right)$ | Position | This paper | This metric captures the spread of the distance from the centre of the trait-space; it can also be used to capture increases in volume |

```{r metrics_list, echo = FALSE}
## Loading the list of metrics
source("list.of.metrics.R")
```

We selected these seven space-occupancy metrics to illustrate how they capture different aspects of trait-space occupancy.
We do not believe that they are better than many of the other metrics used in ecology and evolution.
The supplementary results contain the same analysis as described below performed using more metrics.
Additionally, the [moms]() shiny App allows to explore the effect of many more metrics as well as customising metrics by combining them together or entering users functions.

<!--  -->
<!--  -->
<!--  -->
<!-- COMPARING METRICS -->
<!--  -->
<!--  -->
<!--  -->


## Metrics comparisons

We compared the space occupancy correlation between each pair of metrics to check if they captured similar signal [@villéger2008; @laliberté2010].
First, we used the metrics on the full 13 trait-spaces described above.
We then scaled the results and measured the pairwise Pearson correlation to test whether metrics were capturing a similar signal (high positive correlation), a different signal (correlation close to 0) or an opposite signal (high negative correlations).
We performed all the tests using the `psych` package [@psych].

<!--  -->
<!--  -->
<!--  -->
<!-- EFFECT OF DIMENSIONALITY -->
<!--  -->
<!--  -->
<!--  -->
<!--
## Effect of dimensionality

> VW: I understand teh below but only just and it is hard to read. I can help simplify.

Furthermore, high dimensional spaces ($>> 3$) are subject to the "curse of multidimensionality" [@cursedimensionality].
This is link to the fact that the more dimensions, the more sparse the data becomes.
In other words the probability of two points A and B overlapping in *n* dimensions is the probability of point A having the same value as point point B on dimension 1, 2, 3, etc...
Thus this probability decreases as a product of the number of dimensions.
This "curse" can make the interpretation of high dimensional data counter-intuitive.

For example, the product of range is expected to decrease with the number of dimensions, regardless of the number of elements on each dimensions.
This is counter-intuitive because:
1) first, the range of values on a dimension is bounded to the number of elements on this dimensions (i.e. increasing the number of observations on one dimension can only increase the range, never decrease it);
2) second, products are a classical example of the "curse" where multiplying a higher number of dimensions with a non-null probability of having a range of zero will irremediably result in 0 (i.e. an infinite number of positive values by 0 is still 0).

-->

```{r fig_curse, eval=FALSE, echo = FALSE, fig.height = 8, fig.width = 8, results = 'hide', fig.cap = paste("Figure 3: Effect of the curse of dimensionality on different scaled disparity metrics. Metrics with containing products (ellipsoid volume, product of ranges or variances) are classically affected by the \"curse\" as they decrease more or less rapidly with an increase in dimensions. Note especially how the Product of Range actually increases and then decreases with the number of dimensions.")}
set.seed(42)
## Make a 50 dimensions space
space <- space.maker(300, 50, rnorm, scree = rev(cumsum(rep(1/50, 50))))

## Function wrappers
disparity <- function(metric, dimensions, space) {
    fast.disparity(group = 1:nrow(space), space = space, metric = metric, rare.dim = dimensions)
}
lapply.fun <- function(dimensions, metrics_list, space) {
    unlist(lapply(metrics_list, disparity, dimensions = dimensions, space = space))
}

## Curse results
curse_results <- sapply(2:50, lapply.fun, metrics_list = metrics_list, space = space)
curse_results <- apply(curse_results, 1, function(x) return(x/max(x)))

## Empty plot
hue_colors <- default.palette(ncol(curse_results))
par(bty = "n")
plot(NULL, xlim = c(2,50), ylim = c(0,1),
xlab = "Dimensions (decreasing variance)",
ylab = "Scaled disparity")
for(metric in 1:ncol(curse_results)) {
    lines(curse_results[, metric], col = hue_colors[metric])
}
legend("bottomleft", metric_names, lty = 1, col = hue_colors)
```
<!--  -->
<!--  -->
<!--  -->
<!-- SHIFTING SPACES -->
<!--  -->
<!--  -->
<!--  -->

## Shifting spaces {#shifting-spaces}

To measure how the metrics responded to shifts in trait-spaces, we reduced the spaces by removing 50% of elements each time using the following algorithms:

* **Randomly:** by randomly removing 50% of elements (Fig. 3A).

* **Limit:** by removing all elements with a distance from the centre (mean point) of the space lower or greater than a radius $\rho$ (where \$rho$ is selected such that 50% elements are selected) (Fig. 3B). This generated two limit removals: *maximum* and *minimum* respectively in orange and blue in Fig. 3B.

* **Density:** by removing any pairs of point with a distance $D$ from each other where (where $D$ is selected such that 50% elements are selected - Fig. 3C). This generated two density removals: *high* and *low* respectively in orange and blue in Fig. 3C.

* **Position:** by removing points similarly as above but using the distance from the furthest point from the centre (max point - Fig. 3D). This generated two position removals: *positive* and *negative* respectively in orange and blue in Fig. 3D.


The algorithm to select $\rho$ or $D$ is described in more detail in in the [Appendix](#Appendix_algorithm_reduce).
We used mirror results for the limit, displacement and density reduction (i.e. the opposite data was also used).
For example, when increasing the **density** by removing the 50% most distant elements, we also run a transformation by removing 50% of the *closests* elements.


```{r fig_reduce_space, echo = FALSE, fig.height = 8, fig.width = 8, results = 'hide', fig.cap = paste("Figure 3: different type of space reduction. Each panel displays two groups (orange and blue) of 50% of the data points each. Each groups are generated using the following algorithm: A - randomly; B - by limit (maximum and minimum limit in respectively orange and blue); C - by density (high and low in respectively orange and blue); and D - by position (positive and negative in respectively orange and blue).")}
set.seed(42)

## Change colors
defaults$col1 <- "blue"
defaults$col2 <- "orange"

op <- par(mfrow = c(2,2), bty = "n")
## The elements
elements <- 300
## The amount to remove
remove <- 0.5

## Trait space
trait_space <- space.maker(elements, 2, distribution = rnorm)

## The randomly removed space
random_rm <- reduce.space(trait_space, type = "random", remove = 0.5)
## Plotting the reduction
plot.space(trait_space, random_rm, main = "A - Random removal", defaults)

## The limit removal
limit_rm <- reduce.space(trait_space, type = "limit", remove = 0.5)
## Plotting the reduction
plot.space(trait_space, limit_rm, main = "B - Limit", defaults)

## The density removal
density_rm <- reduce.space(trait_space, type = "density", remove = 0.5)
## Plotting the reduction
plot.space(trait_space, density_rm, main = "C - Density", defaults)

## The displacement removal
displace_rm <- reduce.space(trait_space, type = "displacement", remove = 0.5)
## Moving the space to the upper right corner (positive)
plot.space(trait_space, displace_rm, main = "D - Position", defaults)


## List of removals (for plotting the tables later)
typical_removal <- list(space = trait_space,
                        remove = list("random" = random_rm,
                                      "limit(min)" = limit_rm,
                                      "limit(max)" = !limit_rm,
                                      "density(high)" = density_rm,
                                      "density(low)" = !density_rm,
                                      "displace(positive)" = displace_rm,
                                      "displace(negative)" = !displace_rm))
```

To measure the effect of space reduction, distribution and dimensionality on the metric, we first scaled the metric to be relative to the non reduced space for each dimension distributions or number of dimensions.
To do so, we subtracted the observed disparity with no space reduction (i.e. base disparity) to all the disparity measurements of the reduced spaces and then divided it by the resulting maximum observed disparity.
This way, our disparity metrics where scaled between -1 and 1 with a value of 0 indicating no effect of the space reduction and $>0$ and $<0$ respectively indicating an increase or decrease in the disparity metric value.
We then measured the probability of overlap of the between the non-random removals (limit (max/min), displacement (positive/negative) and density (high/low)) and the random removals using the Bhattacharrya Coefficient [i.e. the probability of overlap between two distributions; @bhattacharyya1943; @guillerme2016].

### Measuring the effect of space and dimensionality on shifting spaces

We also measured the potential effect the distribution of the space or the number of dimensions in the space could have on the metric in general.
In fact, the difference of distributions can have some drastic effect on the way space-occupancy is measured.
For example, in a normally distributed space, a decrease in density can often lead to an increase in volume.
This is not necessarily true in log-normal spaces or in uniform spaces for certain metrics (e.g. the convex hull of a lognormal space will be less sensitive to changes in density).

Furthermore, the differences in distributions can have some drastic effects in high dimensional spaces ($> 10$) which are subject to the "curse of multidimensionality" [@cursedimensionality].
This is link to the fact that the more dimensions, the more sparse the data becomes.
In other words the probability of two points A and B overlapping in *n* dimensions is the probability of point A having the same value as point point B on dimension 1, 2, 3, etc...
Thus this probability decreases as a product of the number of dimensions.
This "curse" can make the interpretation of high dimensional data counter-intuitive.

We thus measured the effect of space distribution and dimensionality using an ANOVA ($occupancy \sim distribution$ and $occupancy \sim dimensions$) by using 1) all spaces with 50 dimensions and 2) the uniform and normal spaces with equal variance and no correlation wit 3, 15, 50, 100 and 150 dimensions (Table 2) for testing respectively the effect of 1) distribution and 2) dimensions.
The results of the ANOVAs (_p_-values) are reported in Table 3 (see supplementary material for the full ANOVA results).

<!--  -->
<!--  -->
<!--  -->
<!-- EMPIRICAL EXAMPLES -->
<!--  -->
<!--  -->
<!--  -->

## Empirical examples

Finally, analysed the effect of the different space-occupancy metrics on six different empirical studies from palaeontology, geometric morphometrics, and ecology to cover a broad representative view of fields using trait-spaces analysis.
For each of these six studies we generated a trait-spaces from the data published along with the paper.
We then divided the trait-space into two roughly equal sized groups based on the nature of the paper and applied the space-occupancy metrics to each pair of groups to test whether different metrics captured different differences between groups.

The procedures to generate the data and the groups varies from one study to the other but is detailed and fully reproducible in the supplementary materials.

study | field | taxonomic Group | traits (data) | trait-space | size | groups | type of question |
------|-------|-----------------|---------------|-------------|------|--------|------------------|
@beck2014 | palaeontology | Mammalia | discrete morphological phylogenetic data | Ordination of a distance matrix (PCO) | 106*105 | 52 crown vs. 54 stem | Are crown mammals more disparate than stem mammals?|
@wright2017 | palaeontology | Crinoidea | discrete morphological phylogenetic data | Ordination of a distance matrix (PCO) | 42*41 | 16 before vs. 23 after | Is there a difference in disparity before and after the Ordovician mass extinction?|
@marcy2016 | geometrics morphometrics | Rodentia | skull 2D landmarks coordinates  | Ordination of a Procrustes Superimposition (PCA) | 454*134 | 225 *Megascapheus* vs. 229 *Thomomys* | Are two genus of Gophers (*Megascapheus*, *Thomomys*) morphological distinct? |
@@@ | geometrics morphometrics | @@@ | 3D landmarks | Ordination of a Procrustes Superimposition (PCA) | @@@ |@@@ vs. @@@ | @@@|
@jones2015 | Ecology | Plantae | Communities species compositions | Ordination of a Jaccard distance matrix (PCO) | 48*47 | 24 aspens vs. 24 grasslands | Is there a difference in species composition between aspens and grasslands? |
@healy2019 | Ecology | Animalia | Life history traits | Ordination (PCA) | 285*6 | 83 ecthotherms vs. 202 endotherms | Do endotherms have more diversified life history strategies than ectotherms? |

Table 4: details of the six empirical trait-spaces.

For each empirical trait-space we bootstrapped each group 500 times [@disprity] and applied the seven space-occupancy metric to each pairs of groups.
Note that when space-occupancy could not be calculated (e.g. due to the curse of multidimensionaly), we collapsed the metric value to 0 (i.e. no space-occupancy was captured).
We then compared the means of each groups using the Bhattacharrya Coefficient [i.e. the probability of overlap between two distributions; @bhattacharyya1943; @guillerme2016].
The are displayed in Table 6.

<!--  -->
<!--  -->
<!--  -->
<!-- RESULTS SECTION -->
<!--  -->
<!--  -->
<!--  -->








# Results

```{r loading_results, echo = FALSE}
## Loading the results
remove_05 <- load.results("remove_05")
```
```{r running_tests, echo = FALSE}
## Anova function
anova.fun <- function(data) {return(aov(glm(disparity ~ factor, data = data)))}

## Running the tests
all_test <- test.simulation(remove_05, test = anova.fun, scale = TRUE)
all_dim_test <- test.simulation(remove_05, test = anova.fun, scale = TRUE,
                      factors = c("uniform3", "uniform15", "uniform50", "uniform100", "uniform150",
                                  "normal3", "normal15", "normal50", "normal100", "normal150"))
space_test <- test.simulation(remove_05, test = anova.fun, scale = TRUE,
                              factors = c("uniform50", "uniform50c", "normal50", "normal50c",
                                          "random50", "pca_like", "pco_like"))
```

## Metrics comparisons 

```{r fig_metric_correlation, echo = FALSE, fig.height = 8, fig.width = 8, results = 'hide', fig.cap = paste("Figure 4: pairwise correlation between the scaled metrics. Numbers on the upper right corner are the Pearson correlations. The red line are linear regressions (with the confidence intervals in grey).")}

## Adding proper names
results_pairwise <- remove_05
names(results_pairwise[[1]]) <- metric_names

## Plotting the pairwise results
pairwise.plot(results_pairwise, scale = TRUE, type = "base", plot = "cor")
```

All the metrics selected where either positively correlated (correlation of 0.99 for the Average distance from centroid and Sum of variance or 0.97 for the Average nearest neighbour distance and Minimum spanning tree average length; Fig. 4) or somewhat correlated (ranging from 0.66 for the Sum of Variances and the Ellispsoid Volume to -0.17 between the Average displacement and the Variance of the distance from centre; Fig. 4).
Note that all metrics but the Ellipsoid Volume were normally distributed (Fig. 4).
This is due to the Ellipsoid Volume being more sensitive to the curse of multidimensionality (many values close to 0).
More comparisons between metrics are available in the supplementary materials.

## Space shifting

```{r fable_results, fig.show='hide', echo=FALSE, fig.height=3, fig.width=3}
## The metrics names (shortened vector)
name <- metric_names

## Making a list of parameters for each mini plot
plot.param <- list(scaler = 3,
                   bg.col = "black",
                   col = c("grey", "orange", "blue"),
                   quantiles = c(95, 50),
                   cent.tend = median,
                   pch = 19,
                   metric.max = length(metrics_list),
                   cex = 2)

## Looping through each mini plot for every metric
for(metric in 1:length(metrics_list)) {
    generate.fable.plot(data = remove_05, metric = metric, what = "limits", plot.param = plot.param, overlap = TRUE)
    generate.fable.plot(data = remove_05, metric = metric, what = "densit", plot.param = plot.param, overlap = TRUE)
    generate.fable.plot(data = remove_05, metric = metric, what = "displa", plot.param = plot.param, overlap = TRUE)
}

```

```{r, echo = FALSE, eval = FALSE}
## Function for printing the table in the R console
print.fable <- function(n_metrics, byrow, ncol, test) {
  ## Make the plot.id table 
  ids <- matrix(1:(n_metrics*ncol), ncol = ncol, byrow = byrow)

  for(one_metric in 1:n_metrics) {
    ## Print all the rows one by one
    text <- c(paste0("`r name[", one_metric, "]`"), paste0("`r plot.id(", ids[one_metric, ], ")`"))
    ## Add some tests?
    if(test) {
      text <- c(text, paste0("`r s.test(", one_metric, ", \"s\")`"), paste0("`r s.test(", one_metric, ", \"r\")`"))
    }
    ## Print the line
    cat(paste(text, collapse = " | "))
    cat("|\n")
  }
}
## Getting the fable
print.fable(length(metrics_list), byrow = TRUE, ncol = 3, test = TRUE)
```

Metric      | Volume change  | Density change | Position change | Distribution effect | Dimensions effect |
:-----------|----------------|-----------------|----------------|---------------------|-------------------|
`r name[1]` | `r plot.id(1)` | `r plot.id(2)` | `r plot.id(3)` | `r s.test(1, "s")` | `r s.test(1, "r")`|
`r name[2]` | `r plot.id(4)` | `r plot.id(5)` | `r plot.id(6)` | `r s.test(2, "s")` | `r s.test(2, "r")`|
`r name[3]` | `r plot.id(7)` | `r plot.id(8)` | `r plot.id(9)` | `r s.test(3, "s")` | `r s.test(3, "r")`|
`r name[4]` | `r plot.id(10)` | `r plot.id(11)` | `r plot.id(12)` | `r s.test(4, "s")` | `r s.test(4, "r")`|
`r name[5]` | `r plot.id(13)` | `r plot.id(14)` | `r plot.id(15)` | `r s.test(5, "s")` | `r s.test(5, "r")`|
`r name[6]` | `r plot.id(16)` | `r plot.id(17)` | `r plot.id(18)` | `r s.test(6, "s")` | `r s.test(6, "r")`|
`r name[7]` | `r plot.id(19)` | `r plot.id(20)` | `r plot.id(21)` | `r s.test(7, "s")` | `r s.test(7, "r")`|


Table 5: Results of the effect of space reduction, space dimensions distributions and dimensions number of the different space-occupancy metrics. The dots represent the median space-occupancy values, the solid and dashed line respectively the 50% and 95% confidence intervals. Results in grey are the random 50% reduction. Results in blue are the minimum limit, low density and negative shift for respectively the volume, density and position changes. Results in orange are the maximum limit, high density and positive shift for respectively the volume, density and position changes. The displayed value in the plots are the probability of overlap (Bhattacharrya Coefficient) between the blue and orange reductions and the random ones. _p_-values for distribution effect and dimensions effect represents respectively the effect of the ANOVAs space-occupancy ~ distributions and space-occupancy ~ dimensions (Signif. codes:  0 '\*\*\*' 0.001 '\*\*' 0.01 '\*' 0.05 '.' 0.1 ' ' 1).

As expected from the sketch in Figure 2, some different metrics capture different aspects of trait-space occupancy.
However, it is worth noticing that it can be hard to predict the behaviour of each metric when 50% of the observations are removed.
In fact we observe a clear decrease in median metric in only 14 out of 63 of the space reductions (or 42 non-random ones).

In terms of change in volume (increase or decrease), only the Average distance from centroid and the Sum of variances seem to capture a clear change in both directions.
Note however that the increase in volume does not correspond to an *actual* increase in volume in the trait-space (i.e. the volume in from the orange observations in Fig. 3B is equivalent to the one in Fig. 3A).
In terms of change in density (increase or decrease), only the Minimum spanning tree average distance and the Average nearest neighbour distance seem to capture a clear change in both directions.
In terms of change in position (increase or decrease), only the Average displacements metric seems to capture a change a clear change in direction (albeit not in both directions).
This is not so surprising since the notion of positions becomes more and more complex to grab as dimensionality increases (i.e. beyond left/right and up/down).

## Empirical example

```{r test_empirical, echo = FALSE}
## Loading the results
empirical_results <- load.results("empirical_results")

## Testing the differences for each distributions
bhatt.coeff.safe <- function(x, y, tol = 1e-16, ...) {
  if(all(x < tol) | all(y < tol)) {
    bhatt.coeff(1, 0)
  } else {
    bhatt.coeff(x, y, ...)
  }
} 
disparity_test <- lapply(empirical_results, lapply, test.dispRity, test = bhatt.coeff.safe)
```

```{r fable_results_empirical, fig.show='hide', echo=FALSE, fig.height=3, fig.width=3}
## Plotting parameters
plot.param <- list(cex = 2,
                   col = c("#F7B27E", "#BFE4E3"),
                   border = c("#F65205", "#3E9CBA"),
                   na.cex = 3,
                   scaler = 3)

## Looping through each mini plot for every metric
data_names <- c("Beck and Lee 2014", "Wright 2017", "Marcy et al. 2016",
                "Somebody", "Jones et al. 2015", "Somebody")

for(dataset in 1:length(data_names)){
    for(metric in 1:length(metrics_list)){
        ## Plotting the results
        generate.fable.empirical(data = empirical_results[[dataset]][[metric]],
                                 test = disparity_test[[dataset]][[metric]],
                                 precision = 1e-5, plot.param, dataset = dataset)
    }
}
```

```{r change_plotid_chain, echo = FALSE, eval = TRUE}
## Changing defaults
body(plot.id)[[3]] <- substitute(chain <- "fable_results_empirical")
```

```{r, echo = FALSE, eval = FALSE}
print.fable(length(metrics_list), byrow = FALSE, ncol = 6, test = FALSE)
```

Metric      | Beck and Lee 2014  | Wright 2017 | Marcy et al. 2016 | Somebody       | Jones et al. 2015 | Healy et al. 2019  |
:-----------|----------------|-----------------|------------------|----------------|------------------|----------------|
`r name[1]` | `r plot.id(1)` | `r plot.id(8)` | `r plot.id(15)` | `r plot.id(22)` | `r plot.id(29)` | `r plot.id(36)`|
`r name[2]` | `r plot.id(2)` | `r plot.id(9)` | `r plot.id(16)` | `r plot.id(23)` | `r plot.id(30)` | `r plot.id(37)`|
`r name[3]` | `r plot.id(3)` | `r plot.id(10)` | `r plot.id(17)` | `r plot.id(24)` | `r plot.id(31)` | `r plot.id(38)`|
`r name[4]` | `r plot.id(4)` | `r plot.id(11)` | `r plot.id(18)` | `r plot.id(25)` | `r plot.id(32)` | `r plot.id(39)`|
`r name[5]` | `r plot.id(5)` | `r plot.id(12)` | `r plot.id(19)` | `r plot.id(26)` | `r plot.id(33)` | `r plot.id(40)`|
`r name[6]` | `r plot.id(6)` | `r plot.id(13)` | `r plot.id(20)` | `r plot.id(27)` | `r plot.id(34)` | `r plot.id(41)`|
`r name[7]` | `r plot.id(7)` | `r plot.id(14)` | `r plot.id(21)` | `r plot.id(28)` | `r plot.id(35)` | `r plot.id(42)`|

Table 6: Comparisons of different pairs of groups in different empirical trait-spaces. NAs are used for cases where space-occupancy could not be measured due to the curse of multidimensionality. The displayed values are the probability of overlap between both groups (Bhattacharrya Coefficient).


Similarly as for the simulated results, the empirical ones indicate that there is no perfect one-size-fit all metric.
For all seven metrics (expect the Ellispoid volume) we see either one group or the other having a bigger mean than the other.
When looking at the probability of overlap, they are also clearly affected by the different metrics.


<!--  -->
<!--  -->
<!--  -->
<!-- DISCUSSION SECTION -->
<!--  -->
<!--  -->
<!--  -->








# Discussion

To write at some point.

<!-- 
* Average squared distances: all right metric for measuring density (increase/decrease picked up). Not great for volume (i.e. volume decreases when the morphospace becomes hollow). Not at all good for position (both negative/positive are picked up the same way). Affected by the distributions but not the dimensions.

* Procrustes variances: similar to the average squared distances although even worth for position (often close to random changes). Clearly not affect by the distributions and the dimensions.

* Ellispsoid volume: Not great for picking up anything, probably because of the curse of multidimensionality. This metric is clearly affected both by the distributions and the number of dimensions. This metric is probably best used with a low number of dimensions ($<10$).

* Product of ranges: Same as the ellipsoid volume.

* Sum of ranges: Picks a only negative change in volume (but not hollowness) and bat for measuring changes in position and density. This metric is clearly affected by the distributions and also by the number of dimensions (albeit less clearly).

* Product of variances: Positive decrease in volume (hollowness) is picked up. But not much signal from change in position or density. This metric is clearly affected by the distributions and the dimensions.

* Sum of variances: Similar behaviour than the Procrustes variance. Picks up great differences in volume. Bad for position on average, not bad for density. 

* Mean displacement: Picks up reduction in volume (increased metric), not great for change in position and density. This metric is clearly affected by both the distributions and the number of dimensions.

* Mean nearest neighbour distances: Picks up reduction in volume. Not great for change in position. OK for change in density. This metric is affected by the distributions but not the number of dimensions.
 -->
## Caveat of the analysis

<!-- * Data not simulated using evolutionary models (TODO: maybe TODO?)
* Response to reduction is often more specific to distribution/dimensions/reduction for each metric and these fine differences are not displayed here.
*
 -->
## Suggestions

<!-- * Measure multiple aspects of multidimensional space occupancy
* Use a metric that will best fit the biological question
* Don't name metrics as the biological aspect they are approximating (e.g. disparity or functional dispersion) but rather what they are measuring (e.g. sum of dimensions variance or the average distance from centroids). We believe this point will allow both a clearer understanding of what is measured (c.f. what is approximated) and a easier understanding between ecology and evolution for which the metrics can be the same but named differently and used for approximating different things.
 -->

# Conclusion

<!-- There are non one-size-fits-all disparity metric.
It is important to use the disparity metric that will best capture the problem at hand (e.g. if interested in the position of the morphospace, don't use the product of variances).

Furthermore, all these different metrics are "disparity metrics" even though they represent widely different aspects.
We thus suggest that future disparity analysis authors abstain from using the term "disparity" to designate the "disparity metric" but rather use "position in the morphospace", or, directly the name of the used metric to avoid confusion.
 -->

# Acknowledgements

Thanks to Natalie Jones for helping finding/sorting the ecological data.
Money from the ARC.
ARC DP170103227, FT180100634



# References





# Supplementary material

## Algorithm for selecting the parameters to reduce the space ($radius$, $displacement$, $density$) {#Appendix_algorithm_reduce}

We used a recursive algorithm for selecting the parameter that removes $P$ elements: 80%, 50% or 20%.

1. Select a random reduction parameters $R$.
2. Remove elements from the space using $R$ resulting in $P'$ removed elements.
If the remaining number of elements is to the required proportion $P$ ; exit the algorithm;
Else go to 3.
3. Get the different between the proportion of removed elements $P'$ and $P$.
If the difference is positive set the increment parameter $R$ to $R = 1.1 \times R$, then go to 2.
Else set $R = 0.9 \times R$, then go to 2.

The algorithm is implemented in the `optimise.parameter` function in [reduce.space_fun.R](@@@).
